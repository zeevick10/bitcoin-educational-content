---
name: 比特币上的隐私保护
goal: 理解并掌握在使用比特币时保护隐私的原则
objectives:
  - 定义理解隐私保护利害关系所需的理论概念
  - 知道如何识别和减轻比特币用户隐私丢失的风险
  - 使用方法和工具保护您在比特币上的隐私
  - 理解链分析方法并制定防御策略
---
# 保护您在比特币上的隐私

在一个金融交易的隐私逐渐成为奢侈品的世界里，理解和掌握在使用比特币时保护隐私的原则是至关重要的。这个培训为您提供了实现这一目标的所有理论和实践关键。

如今，在比特币上，有专门从事链分析的公司。它们的核心业务正是侵入您的私人领域，以妥协您交易的保密性。实际上，比特币上的“隐私权”并不存在。因此，作为用户，维护交易的保密性是您的自然权利，因为没有其他人会为您做这件事。

这个培训被呈现为一个完整和通用的旅程。每个技术概念都详细说明并通过解释性图表支持。目标是使知识对每个人都可访问。因此，BTC204对初学者和中级用户来说是可接近的。这个培训对于最有经验的比特币用户也提供了附加值，因为我们深入探讨了一些通常未知的技术概念。

加入我们，转变您使用比特币的方式，成为一个了解保密问题并能够保护您隐私的知情用户。

+++

# 引言
<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## 培训简介
<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

在一个金融交易的隐私逐渐成为奢侈品的世界里，理解和掌握在使用比特币时保护隐私的原则是至关重要的。这个培训为您提供了实现这一目标的所有理论和实践关键。
如今，在比特币生态系统中，有专门从事链分析的公司。它们的核心业务正是侵入您的私人领域，妥协您交易的保密性。实际上，比特币上的“隐私权”并不存在。因此，作为用户，维护交易的保密性是您的自然权利，因为没有其他人会为您做这件事。

比特币不仅仅是为了“数字增长”和保存储蓄价值。由于其独特的特性和历史，它主要是反经济的工具。通过这一杰出的发明，您可以自由地管理您的资金，花费它，并积累它，没有任何人能够阻止您。

比特币提供了一种从国家的枷锁中平和逃脱的方式，让您能够充分享受您的自然权利，这些权利不能被既定法律挑战。感谢中本聪的发明，您有权力强制尊重您的私有财产并重新获得契约自由。

然而，比特币默认情况下并不是匿名的，这对于从事反经济活动的个人来说可能构成风险，特别是在专制政权下的地区。但这并不是唯一的危险。鉴于比特币是一种有价值且不可审查的资产，它可能吸引窃贼的注意。因此，保护您的隐私也成为一种安全问题：它可以帮助您防止网络攻击和身体攻击。
正如我们将看到的，尽管该协议提供了某些固有的隐私保护，但使用额外的工具来优化和保护这些隐私至关重要。这项培训被设计为一个全面且通用的课程，旨在理解比特币隐私问题的重要性。每个技术概念都将详细讨论，并通过解释性图表进行支持。目标是使知识对每个人都易于理解，即使是初学者和中级用户也不例外。对于更有经验的比特币用户，我们还将在整个培训过程中涵盖非常技术性和有时较不为人知的概念，以加深对每个主题的理解。

这项培训的目标不是让您在使用比特币时完全匿名，而是提供给您必要的工具，了解如何根据您的个人目标保护您的隐私。您将有自由选择所介绍的概念和工具，以开发适合您特定目标和需求的策略。

### 第1节：定义和关键概念
首先，我们将一起回顾支配比特币运作的基本原则，然后再平静地接触与隐私相关的概念。在能够完全理解我们将在后续章节中讨论的概念之前，掌握一些基本概念是必要的，例如UTXOs、接收地址或脚本。我们还将介绍比特币隐私的一般模型，正如中本聪所设想的，这将使我们能够把握相关的利害关系和风险。
![BTC204](assets/en/11/1.webp)

### 第2节：理解链分析及如何防御

在第二节中，我们研究链分析公司用来追踪您在比特币上的活动的技术。理解这些方法对于增强您的隐私保护至关重要。这部分旨在检查攻击者的策略，以更好地理解风险，并为我们将在后续章节中研究的技术奠定基础。我们将分析交易模式、内部和外部启发式方法，以及这些模式的合理解释。除了理论部分外，我们还将学习使用区块浏览器进行链分析，通过实际示例和练习。

![BTC204](assets/notext/11/2.webp)

### 第3节：掌握保护隐私的最佳实践

在我们培训的第三节中，我们进入了实践的核心部分：实践！目标是掌握所有应该成为任何比特币用户自然反应的基本最佳实践。我们将涵盖使用新地址、标记、合并、使用全节点以及KYC和获取方法的使用。目的是为您提供一个全面的概述，了解要避免的陷阱，以建立我们寻求隐私保护的坚实基础。对于这些实践中的一些，您将被引导到特定的教程以实施它们。

![BTC204](assets/en/11/3.webp)

### 第4节：理解Coinjoin交易

我们怎能在不讨论coinjoins的情况下谈论比特币上的隐私呢？在第4节中，您将发现关于这种混合方法的所有需要知道的信息。您将学习什么是coinjoin，它的历史和目标，以及存在的不同类型的coinjoins。最后，对于更有经验的用户，我们将探讨什么是匿名集和熵，以及如何计算这些指标。

![BTC204](assets/en/11/4.webp)

### 第5节：理解其他高级隐私技术的利害关系
在第五节中，我们将提供一个关于保护比特币上隐私的所有其他现有技术的概览，除了coinjoin之外。多年来，开发者在设计致力于隐私的工具方面展现了非凡的创造力。我们将检查所有这些方法，如payjoin、协作交易、Coin Swap和Atomic Swap，详细说明它们的操作、目标和潜在弱点。
我们还将讨论节点网络层面的隐私和交易的传播。我们还将讨论多年来提出的各种协议，以增强比特币上用户的隐私，包括静态地址协议。

![BTC204](assets/notext/11/5.webp)

# 定义和关键概念
<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>


## 比特币UTXO模型
<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>

比特币主要是一种货币，但你知道BTC在协议上是如何具体表示的吗？

### 比特币UTXOs：它们是什么？

在比特币协议中，货币单位的管理围绕着UTXO模型展开，这是“_未花费交易输出_”的缩写。

这种模型与传统银行系统有着根本的不同，后者依赖于账户和余额机制来跟踪财务流动。实际上，在银行系统中，个人余额是通过与身份相关联的账户来维护的。例如，当你从面包师那里买一个法棍时，你的银行只是从你的账户中扣除购买金额，从而减少你的余额，而面包师的账户则被记入相同的金额，增加了他的余额。在这个系统中，除了交易记录外，没有进入你账户的钱和离开它的钱之间的联系的概念。

![BTC204](assets/en/21/1.webp)
在比特币上，情况有所不同。账户的概念不存在，货币单位不是通过余额而是通过UTXOs来管理的。一个UTXO代表了一定数量的尚未被花费的比特币，因此形成了一个可以大可以小的“比特币片段”。例如，一个UTXO可以价值`500 BTC`或仅`700 SATS`。
**> 提醒：** Satoshi，通常缩写为sat，是比特币的最小单位，类似于法定货币中的分。

```plaintext
1 BTC = 100,000,000 SATS
```

理论上，一个UTXO可以代表任何价值的比特币，从一个satoshi到理论上的最大约2100万BTC。然而，拥有所有2100万比特币在逻辑上是不可能的，并且存在一个称为“尘埃”的经济门槛，低于此门槛的UTXO被认为是经济上不可行的花费。

**> 你知道吗？** 在比特币上创建的最大的UTXO价值为`500,000 BTC`。它是由MtGox平台在2011年11月的一次合并操作中创建的：[29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXOs和花费条件
UTXO是比特币上的交换工具。每一笔交易都会消耗UTXO作为输入，并创建新的UTXO作为输出。当进行交易时，用作输入的UTXO被视为“已花费”，并且会生成新的UTXO分配给交易输出中指示的接收者。因此，UTXO简单地代表一个未花费的交易输出，因此代表用户在给定时间拥有的一定数量的比特币。
![BTC204](assets/en/21/2.webp)
所有UTXO都由脚本保护，这些脚本定义了它们可以被花费的条件。要消费一个UTXO，用户必须向网络证明他们满足该UTXO保护脚本规定的条件。通常，UTXO由公钥（或代表此公钥的接收地址）保护。要花费与此公钥关联的UTXO，用户必须证明他们持有相应的私钥，通过提供用此密钥制作的数字签名。这就是为什么人们说你的比特币钱包实际上不包含比特币，而是存储你的私钥，这些私钥反过来让你访问你的UTXO，以及它们代表的比特币。
![BTC204](assets/en/21/3.webp)

鉴于比特币中缺乏账户的概念，钱包的余额简单对应于它可以花费的所有UTXO的值之和。例如，如果你的比特币钱包可以花费以下4个UTXO：

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

你的钱包总余额将是`17 BTC`。

![BTC204](assets/en/21/4.webp)

## 比特币交易的结构

### 交易的输入和输出

比特币交易是一种在区块链上记录的操作，允许将比特币的所有权从一个人转移到另一个人。更具体地说，由于我们处于UTXO模型且没有账户，交易满足了保护一个或多个UTXO的花费条件，消耗它们，并等价地创建了赋予新花费条件的新UTXO。简而言之，交易将比特币从一个满足条件的脚本移动到旨在保护它们的新脚本。

![BTC204](assets/en/22/1.webp)

因此，每笔比特币交易由一个或多个输入和一个或多个输出组成。输入是交易消耗的UTXO，用于生成输出。输出是新的UTXO，将来可作为交易的输入使用。

![BTC204](assets/en/22/2.webp)

**> 你知道吗？** 理论上，一笔比特币交易可以有无限多的输入和输出。只有区块的最大大小限制了这个数字。
比特币交易中的每个输入都指向一个之前的、未花费的UTXO（未花费的交易输出）。要将UTXO作为输入使用，其持有者必须通过验证与之关联的脚本，即满足强加的花费条件，来证明他们是合法的所有者。通常，这涉及提供一个与最初保护该UTXO的公钥相对应的私钥产生的数字签名。因此，脚本验证签名与接收资金时使用的公钥匹配。
![BTC204](assets/en/22/3.webp)
另一方面，每个输出指定了要转移的比特币数量以及接收者。后者通过一个新脚本定义，通常，这个脚本会用接收地址或一个新的公钥锁定新创建的UTXO。

根据共识规则，要使交易被视为有效，输出的总额必须小于或等于输入的总额。换句话说，交易生成的新UTXO的总和不能超过作为输入消耗的UTXO的总和。这个原则是合乎逻辑的：如果你只有`500,000 SATS`，你不能进行`700,000 SATS`的购买。

### 比特币交易中的找零和合并

因此，比特币交易对UTXO的作用可以比作金币的熔化。实际上，UTXO是不可分割的，但可以合并。这意味着用户不能简单地将代表一定数量比特币的UTXO分割成几个较小的UTXO。他们必须在交易中完全消耗它，以在输出中创建一个或多个任意值的新UTXO，这些新UTXO的值必须小于或等于初始值。

这个机制类似于金币。想象你拥有一枚2盎司的金币，你想支付1盎司，假设卖家不能给你找零。你需要将你的金币熔化，铸造出2枚新的各1盎司的金币。
在比特币上，操作类似。假设Alice有一个`10,000 SATS`的UTXO，她想买一个价值`4,000 SATS`的法棍。Alice将进行一次交易，输入一个`10,000 SATS`的UTXO，她将完全消耗它，并在输出中创建两个分别值`4,000 SATS`和`6,000 SATS`的UTXO。`4,000 SATS`的UTXO将作为法棍的支付发送给面包师，而`6,000 SATS`的UTXO将作为找零返回给Alice。这个返回给交易初始发送者的UTXO，在比特币术语中被称为“找零”。

现在想象Alice不是拥有一个`10,000 SATS`的UTXO，而是有两个各`3,000 SATS`的UTXO。在这种情况下，单个UTXO都不足以支付法棍的`4,000 SATS`。因此，Alice必须同时使用两个`3,000 SATS`的UTXO作为她交易的输入。这样，输入的总金额将达到`6,000 SATS`，使她能够支付给面包师`4,000 SATS`。这种方法，涉及到在交易的输入中组合多个UTXO，通常被称为“合并”。

### 交易费用
直观上，人们可能会认为交易费用也代表了一笔交易的输出。但实际上，并非如此。交易的费用代表了输入总额与输出总额之间的差额。这意味着，在使用输入的一部分价值来覆盖交易中所需的输出后，输入的某个金额仍未被使用。这部分剩余的金额构成了交易费用。
```plaintext
费用 = 总输入 - 总输出
```

让我们回到爱丽丝想要用`10,000 SATS`的UTXO购买价值`4,000 SATS`的法棍面包的例子。爱丽丝用她的`10,000 SATS`UTXO作为输入创建了一个交易。然后，她生成了一个`4,000 SATS`的输出，用于支付给面包师傅的法棍面包。为了鼓励矿工将她的交易包含在一个区块中，爱丽丝分配了`200 SATS`作为费用。因此，她创建了第二个输出，即找零，将返回给她，金额为`5,800 SATS`。

![BTC204](assets/en/22/6.webp)

通过应用费用公式，我们确实看到矿工们剩下了`200 SATS`：
```plaintext
费用 = 总输入 - 总输出
开销 = 10,000 - (4,000 + 5,800)
开销 = 10,000 - 9,800
开销 = 200
```

当矿工成功验证一个区块时，他们可以通过所谓的“coinbase”交易，收集该区块中所有交易的费用。

### 比特币上UTXOs的创建

如果你一直在仔细跟随前面的段落，你现在应该知道，UTXOs只能通过消耗其他现有的UTXOs来创建。因此，比特币上的硬币形成了一个连续的链条。然而，你可能会想知道这个链条中的第一个UTXOs是如何出现的。这引发了一个类似于鸡和蛋的问题：这些原始的UTXOs从哪里来？

答案在于**coinbase交易**。

Coinbase是比特币交易的一种特殊类型，每个区块中都独有且总是排在第一位。它允许找到有效工作证明的矿工接收他们的区块奖励。这个奖励由两部分组成：**区块补贴**和**我们在前一部分谈到的交易费用**。

Coinbase交易的独特之处在于，它是唯一可以凭空创建比特币的交易，无需消耗输入来生成其输出。这些新创建的比特币构成了所谓的“原始UTXOs”。

![BTC204](assets/en/22/7.webp)

区块补贴中的比特币是根据共识规则中预设的发行计划从无到有创建的新BTC。区块补贴每210,000个区块减半一次，大约每四年一次，这个过程称为“减半”。最初，每次补贴创建50个比特币，但这个数量已经逐渐减少；目前，每个区块的补贴是3.125个比特币。
关于交易费用的部分，尽管它也代表了新创建的BTC，但它们不得超过一个区块中所有交易的总输入与输出之间的差额。我们之前看到，这些费用代表了输入中未用于交易输出的那部分。这部分在交易过程中技术上被“丢失”，矿工有权以一个或多个新的UTXO形式重新创造这个价值。因此，这是一个从交易发送者到将其添加到区块链的矿工的价值转移。
**> 你知道吗？** 通过coinbase交易生成的比特币在它们不能被矿工使用的100个区块的成熟期内受到限制。这个规则旨在避免使用在可能稍后被废弃的链上新创建的比特币相关的复杂情况。

### UTXO模型的影响

首先，UTXO模型直接影响比特币上的交易费用。鉴于每个区块的容量有限，矿工更倾向于选择相对于它们将占用的区块空间提供最佳费用的交易。实际上，交易包含的UTXO作为输入和输出越多，它就越重，因此，它需要更高的费用。这是我们经常努力减少钱包中UTXO数量的原因之一，这也会影响隐私，这是我们将在本培训的第三部分详细探讨的话题。

接下来，如前几部分所述，比特币上的硬币本质上是UTXO的链。因此，每笔交易都在过去的UTXO和未来的UTXO之间创建了一个链接。因此，UTXO允许明确跟踪比特币从创建到当前支出的路径。这种透明性可以被积极看待，因为它允许每个用户确保所收到的比特币的真实性。然而，正是基于这种可追溯性和可审计性原则，链分析的实践也以此为基础，这种做法旨在妥协您的隐私。我们将在培训的第二部分深入研究这种做法。

## 比特币的隐私模型
<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>

### 货币：真实性、完整性和双重支付

货币的一个功能是解决双重需求巧合的问题。在一个基于物物交换的系统中，进行交换不仅需要找到一个提供满足我需求的商品的个体，还需要提供一个具有等价值的商品满足他们的需求。找到这种平衡证明是复杂的。

![BTC204](assets/notext/23/1.webp)

这就是为什么我们诉诸于货币，它允许价值在空间和时间上的转移。

![BTC204](assets/notext/23/2.webp)

为了解决这个问题，货币至关重要的是，提供商品或服务的一方相信他们以后能够花费那笔钱。因此，任何希望接受一种货币（无论是数字的还是物理的）的理性个体都会确保它满足两个基本标准：
- **货币必须是完整且真实的；**
- **并且它不能被双重支付。**
在使用实体货币时，第一个特性是最复杂的。在历史的不同时期，金属硬币的完整性经常因为剪边或钻孔等做法而受到损害。例如，在古罗马时期，公民们常常刮取金币的边缘以收集一些贵重金属，同时仍然保留它们以备将来交易。因此，硬币的内在价值降低了，但其面值保持不变。这正是后来在硬币边缘铸造凸起的原因。

真实性也是一个难以验证的特性，对于实体货币媒介而言。如今，对抗伪造的技术越来越复杂，迫使商家投资于昂贵的验证系统。

另一方面，由于其性质，实体货币不存在双重支付的问题。如果我给你一张€10的钞票，它不可撤销地离开我的占有，进入你的占有，自然排除了多次花费同一货币单位的可能性。简而言之，我将无法再次花费那张€10的钞票。

![BTC204](assets/notext/23/3.webp)

对于数字货币，困难在于不同的方面。确保一枚硬币的真实性和完整性通常更简单。正如我们在前一节中看到的，比特币的UTXO模型允许追溯一枚硬币的起源，从而验证它确实是按照共识规则由矿工创建的。

然而，确保不存在双重支付更为复杂，因为任何数字商品本质上都是信息。与实体商品不同，信息在交换过程中不会分割，而是通过复制来传播。例如，如果我通过电子邮件发送给你一个文档，它就会被复制。在你这一端，你无法确定我是否已经删除了原始文档。

![BTC204](assets/notext/23/4.webp)

### 在比特币上防止双重支付

避免数字商品复制的唯一方法是了解系统内所有的交换。这样，人们就可以知道谁拥有什么，并根据进行的交易更新每个人的持有量。例如，这就是银行系统中记账货币所做的。当你用信用卡支付给商家€10时，银行会记录这次交换并更新账本。
在比特币上，以同样的方式实现防止双重支付。目标是确认不存在已经使用过相关硬币的交易。如果这些硬币从未被使用，那么我们可以确信不会发生双重支付。中本聪在白皮书中用这句著名的话描述了这一原则：

**"*确认交易不存在的唯一方法是了解所有交易。*"**

然而，与银行模型不同，比特币不希望必须信任一个中央实体。所有用户都必须能够确认不存在双重支付，而不依赖于第三方。因此，每个人都必须了解所有比特币交易。这就是为什么比特币交易在所有网络节点上公开广播并在区块链上明确记录的原因。

正是这种信息的公开传播，使得在比特币上保护隐私变得复杂。在传统银行系统中，理论上，只有金融机构知道所进行的交易。另一方面，在比特币上，所有用户通过各自的节点了解所有交易。

### 隐私模型：银行系统 vs 比特币
在传统系统中，您的银行账户与您的身份挂钩。银行家能够知道哪个银行账户属于哪个客户，以及与之相关的交易是什么。然而，这种信息流在银行和公共领域之间是被切断的。换句话说，不可能知道属于另一个个人的银行账户的余额和交易情况。只有银行能够访问这些信息。
例如，您的银行家知道您每天早上在邻里面包店买法棍面包，但您的邻居不知道这笔交易。因此，信息流对相关方，特别是银行是可访问的，但对外人来说是不可访问的。

由于我们在前一部分看到的公共传播交易的限制，比特币的隐私模型不能遵循银行系统的模型。在比特币的情况下，由于信息流不能在交易和公共领域之间断开，**隐私模型依赖于用户身份和交易本身之间的分离**。
例如，如果您通过支付BTC在面包师那里买了一根法棍面包，拥有自己的完整节点的邻居可以看到您的交易进行，就像他们可以看到系统中的所有其他交易一样。然而，如果遵守隐私原则，他们不应该能够将这个特定的交易与您的身份联系起来。
![BTC204](assets/en/23/9.webp)

但由于比特币交易是公开的，仍然有可能在它们之间建立联系，以推断出有关参与方的信息。这项活动甚至构成了一个自成一体的专业领域，称为“链分析”。在培训的下一部分，我邀请您探索链分析的基础知识，以了解您的比特币是如何被追踪的，以及如何更好地防御它。

# 理解链分析及如何保护自己
<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## 什么是比特币上的链分析？
<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>

### 定义和操作

链分析是一种实践，涵盖了用于追踪区块链上比特币流动的所有方法。通常，链分析依赖于观察以前交易样本中的特征。然后涉及识别这些相同的特征在一个人希望分析的交易中，并推导出合理的解释。这种从实际方法出发，找到一个足够好的解决方案的问题解决方法，就是所谓的“启发式”。

简而言之，链分析主要分为三个步骤：
1. **观察区块链；**
2. **识别已知特征；**
3. **推导假设。**

![BTC204](assets/en/31/1.webp)

任何人都可以进行链分析。只需通过完整节点访问区块链的公共信息，就足以观察交易的移动并提出假设。也有免费工具促进这种分析，比如我们将在本部分的最后两章详细探讨的网站[OXT.me](https://oxt.me/)。然而，隐私的主要风险来自专门从事链分析的公司。这些公司已将链分析提升到工业规模，并将其服务销售给金融机构或政府。在这些公司中，Chainalysis可能是最著名的。

### 链分析的目标
链分析的目标之一是将比特币上的各种活动分组，以确定执行这些活动的用户的独特性。随后，将尝试将这一系列活动与一个真实身份联系起来。
![BTC204](assets/notext/31/2.webp)

回想前一章。我解释了比特币的隐私模型最初是如何依赖于将用户的身份与他们的交易分开的。因此，人们可能会认为链分析是不必要的，因为即使有人设法将链上活动分组，也无法将它们与一个真实身份关联起来。

从理论上讲，这个说法是准确的。在本培训的第一部分，我们看到了如何使用加密密钥对来建立UTXO上的条件。本质上，这些密钥对不会透露其持有者的任何身份信息。因此，即使有人成功地将与不同密钥对相关的活动分组，这也无法告诉我们这些活动背后的实体是谁。

![BTC204](assets/notext/31/3.webp)

然而，实际情况要复杂得多。存在许多行为可能会将一个真实身份与链上活动联系起来。在分析中，这被称为入口点，而且这样的入口点有很多。

最常见的当然是KYC（*了解你的客户*）。如果你从一个受监管的平台提取你的比特币到你的一个个人接收地址，那么一些人能够将你的身份与这个地址联系起来。更广泛地说，入口点可以是你的现实生活与比特币交易之间的任何形式的互动。例如，如果你在社交网络上发布一个接收地址，这可以成为分析的一个入口点。如果你用比特币向你的面包师支付，他们可以将你的面孔（这是你身份的一部分）与一个比特币地址关联起来。

这些入口点在使用比特币时几乎是不可避免的。尽管人们可以寻求限制它们的范围，但它们仍将存在。这就是为什么结合旨在保护你的隐私的方法至关重要。虽然保持你的真实身份与你的交易之间的分离是一个有趣的方法，但今天它仍然不够。事实上，如果你所有的链上活动都可以被分组，那么最轻微的入口点都可能会危及你所建立的唯一隐私层。

![BTC204](assets/notext/31/4.webp)

### 防御链分析
因此，在我们使用比特币时，也有必要能够面对区块链分析。通过这种方式，我们可以最小化我们活动的聚合，并限制一个入口点对我们隐私的影响。
![BTC204](assets/notext/31/5.webp)

实际上，为了更好地对抗区块链分析，比熟悉区块链分析中使用的方法更好的方法是什么呢？如果你想知道如何在比特币上提高你的隐私，你必须理解这些方法。这将使你能够更好地掌握像[coinjoin](https://planb.network/fr/tutorials/privacy/coinjoin-samourai-wallet)或[payjoin](https://planb.network/fr/tutorials/privacy/payjoin)（我们将在培训的最后部分研究的技术）这样的技术，并减少你可能犯的错误。
在这里，我们可以用密码学和密码分析作一个类比。一个优秀的密码学家首先是一个优秀的密码分析师。要想象一个新的加密算法，必须知道它将面临什么样的攻击，同时也要研究为什么之前的算法被破解。这一原则同样适用于比特币上的隐私保护。理解区块链分析的方法是保护免受其侵害的关键。这就是为什么我在这次培训中提议整个部分都关于区块链分析。

### 区块链分析的方法

重要的是要理解，区块链分析不是一门精确科学。它依赖于从以往的观察或逻辑解释中得出的启发式规则。这些规则允许得到相当可靠的结果，但永远不会有绝对的精确性。换句话说，**区块链分析总是涉及到在所得出的结论中加入概率维度**。例如，可能会更或少地确定两个地址属于同一实体，但总是无法达到完全的确定性。

区块链分析的整个目标正是在于聚合各种启发式规则，以最小化错误的风险。这在某种程度上，是一种证据的积累，使我们能够更接近地接触现实。

这些著名的启发式规则可以分为不同的类别，我们将一起详细说明：
- **交易模式（或交易模型）;**
- **交易内部的启发式规则;**
- **交易外部的启发式规则。**

### 中本聪和区块链分析
值得注意的是，链分析的前两个启发式规则是由中本聪本人发现的。他在比特币白皮书的第10部分讨论了这些内容。这些是：
- 共同输入所有权启发式（CIOH）;
- 和地址重用。

![BTC204](assets/notext/31/6.webp)

来源：S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009。

在接下来的章节中，我们将探讨这些内容的构成，但已经很有趣的是注意到这两个启发式规则今天在链分析中仍然保持着优先地位。

## 交易模式
<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>

交易模式简单来说就是可以在区块链上找到的典型交易的一个模型或整体结构，其解释很可能是已知的。在研究模式时，我们将关注单一交易，并在高层次上分析它。

换句话说，我们只会看输入中的UTXO数量和输出中的UTXO数量，而不会详细研究更具体的细节或交易的环境。从观察到的模型中，我们将能够解释交易的性质。然后我们将寻找其结构中的特征，并推导出一个解释。

![BTC204](assets/en/32/01.webp)

在这部分，我们将一起发现在链分析中可以遇到的主要交易模型，对于每个模型，我将给出这种结构的可能解释，以及一个具体的例子。

### 简单发送（或简单支付）

我们从一个非常普遍的模式开始，因为它是在大多数比特币支付中出现的模式。简单支付模型的特点是在输入中消耗一个或多个UTXO，并在输出中产生2个UTXO。因此，这个模型将如下所示：

![BTC204](assets/en/32/02.webp)
当我们在区块链上发现这种交易结构时，我们就可以做出解读。正如其名称所示，这个模型表明我们正处于一个发送或支付交易的场景中。用户已经使用他们自己的UTXO作为输入来满足输出中的一个支付UTXO和一个找零UTXO（钱返回给同一用户）。
因此，我们知道观察到的用户可能不再拥有输出中的两个UTXO之一（支付那个），但他们仍然拥有另一个UTXO（找零那个）。
目前，我们无法指定哪个输出代表哪个UTXO，因为这不是研究模式的目标。我们将通过依赖我们在后续部分将研究的启发式方法来实现这一点。在这个阶段，我们的目标仅限于识别所讨论的交易的性质，即在这种情况下，是一个简单的发送。

例如，这里有一个采用简单发送模式的比特币交易：

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/en/32/03.webp)

来源：[Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

在这个第一个例子之后，你应该对研究“交易模型”意味着什么有了更好的理解。我们通过只关注交易的结构来检查一个交易，而不考虑其环境或交易的具体细节。我们在这第一步中只以全局方式观察它。

现在你已经理解了什么是模式，让我们继续探讨其他现有的模型。

### 清扫

这第二个模型的特点是消耗单个UTXO作为输入，并产生单个UTXO作为输出。

![BTC204](assets/en/32/04.webp)

这个模型的解释是我们处于自我转账的场景中。用户已经将他的比特币转移到他自己的另一个地址。由于交易中没有找零，我们几乎可以肯定这不是一次支付。实际上，当进行支付时，付款人几乎不可能拥有一个完全匹配卖家要求的金额加上交易费用的UTXO。通常，付款人因此被迫产生一个找零输出。

然后我们知道观察到的用户可能仍然拥有这个UTXO。在链分析的背景下，如果我们知道用作交易输入的UTXO属于Alice，我们可以假设输出中的UTXO也属于她。稍后变得有趣的是找到交易内部的启发式方法，这些方法可以加强这个假设（我们将在第3.3章研究这些启发式方法）。

例如，这里有一个采用清扫模式的比特币交易：

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/en/32/05.webp)
来源：[Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d)然而，这种模式也可能揭示了一次向加密货币交易平台账户的自我转账。通过研究已知地址和交易上下文，我们可以知道这是向自我保管钱包的清扫还是向平台的提款。实际上，交易平台的地址往往容易识别。

回到Alice的例子：如果清扫导致了一个平台的已知地址（例如Binance），这可能意味着比特币被转移出了Alice的直接控制，可能是出于出售它们或在该平台上存储它们的意图。另一方面，如果目的地地址是未知的，合理的假设是它仅仅是另一个仍然属于Alice的钱包。但这种类型的研究更多地属于启发式分类，而不是模式研究。

### 合并

这种模式的特点是消耗多个UTXOs作为输入，并产生单个UTXO作为输出。

![BTC204](assets/en/32/06.webp)

这种模式的解释是我们处于合并之中。这是比特币用户之间的一种常见做法，旨在合并多个UTXOs以预期交易费用可能的增加。通过在费用较低的时期进行此操作，可以节省未来的费用。我们将在第4.3章更多地讨论这种做法。

我们可以推断，进行这种交易模式的用户很可能拥有所有输入中的UTXOs，并且仍然拥有输出中的UTXO。这肯定是一次自我转账。

就像清扫一样，这种类型的模式也可以揭示向交易平台账户的自我转账。通过研究已知地址和交易上下文，我们可以知道这是向自我保管钱包的合并还是向平台的提款。

例如，这里是一个采用合并模式的比特币交易：

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/en/32/07.webp)

来源：[Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)
在链分析的背景下，这种模式可以揭示很多信息。例如，如果我们知道其中一个输入属于Alice，我们可以假设这笔交易的所有其他输入和输出也属于她。这个假设随后允许我们追溯通过之前的交易链来发现和分析可能与Alice相关的其他交易。
![BTC204](assets/en/32/08.webp)

### 分组支出

这种模式的特点是消耗少量UTXOs作为输入（通常只有一个）并产生众多UTXOs作为输出。

![BTC204](assets/en/32/09.webp)
此模型的解释是，我们处于集中支出的状态。这是一种可能揭示重大经济活动的做法，例如交易平台。通过将支出合并为单一交易，这些实体可以节省费用。

我们可以从这个模型中推断，UTXO输入来自于一个有着重大经济活动的公司，而UTXO输出将会分散。许多输出将属于从平台提取比特币的公司客户。其他可能流向合作伙伴公司。最后，肯定会有一个或多个交易返回给发行公司。

例如，这里有一个采用集中支出模式的比特币交易（很可能是由Bybit平台发起的）：

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/en/32/10.webp)

来源：[Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### 特定协议的交易

在交易模式中，我们还可以识别出揭示特定协议使用的模型。例如，Whirlpool coinjoins（我们将在第5部分讨论）将具有容易识别的结构，使它们能够与其他更传统的交易区分开来。

![BTC204](assets/en/32/11.webp)

这种模式的分析表明，我们很可能处于协作交易的状态。也有可能观察到coinjoin。如果这个后者的假设被证实是准确的，那么输出的数量可以为我们提供coinjoin中参与者数量的大致估计。

例如，这里是一个采用协作交易类型coinjoin模式的比特币交易：

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/en/32/12.webp)

来源：[Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

还有许多其他协议具有自己特定的结构。因此，我们可以区分Wabisabi类型的交易、Stamps交易，甚至是Runes交易，例如。

感谢这些交易模式，我们已经可以解释关于给定交易的许多信息。但交易的结构不是分析的唯一信息来源。我们还可以研究其细节。这些细节，内部于交易，是我喜欢称之为“内部启发式”的，我们将在下一章中研究它们。

## 内部启发式
<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>

内部启发式是在交易本身内部识别的特定特征，无需检查其环境，就可以让我们做出推断。与侧重于高层次上交易整体结构的模式不同，内部启发式基于一组可提取的数据。这包括：
- 不同UTXO（未花费交易输出）的金额，包括进账和出账；
- 与脚本相关的所有内容：接收地址、版本控制、锁定时间等。

通常，这种启发式方法将允许我们识别特定交易中的变化。通过这样做，我们可以继续追踪某个实体在几个不同交易中的活动。确实，如果我们识别出属于我们希望跟踪的用户的UTXO，在他们进行交易时，确定哪个输出被转移到另一个用户，哪个输出代表找零，因而仍然属于他们的所有，这一点至关重要。

![BTC204](assets/en/33/01.webp)

再次提醒，这些启发式方法并不绝对精确。单独使用时，它们只能让我们识别出可能的情景。是多个启发式方法的累积帮助减少不确定性，但永远无法完全消除。

### 内部相似性

这种启发式方法涉及研究同一交易中输入和输出之间的相似性。如果我们观察到输入和交易的仅一个输出上有相同的特征，那么这个输出很可能构成找零。

最明显的特征是在同一交易中重用接收地址。

![BTC204](assets/en/33/02.webp)
这种启发式方法留下的疑问很少。除非某人的私钥被黑，相同的接收地址不可避免地揭示了单一用户的活动。随之而来的解释是，交易中的找零是输入和输出地址相同的那个输出。这允许基于这种变化继续追踪个体。
例如，这里有一个可以合理应用此启发式方法的交易：

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/notext/33/03.webp)

来源：[Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

这些输入和输出之间的相似性不仅限于地址重用。任何在脚本使用上的相似性都可以应用启发式方法。例如，有时可以观察到输入和交易的一个输出之间有相同的版本控制。

![BTC204](assets/en/33/04.webp)

在此图中，我们可以看到输入编号0解锁了一个P2WPKH脚本（SegWit V0以`bc1q`开头）。输出编号0使用相同类型的脚本。然而，输出编号1使用了一个P2TR脚本（SegWit V1以`bc1p`开头）。这个特征的解释是，与输入具有相同版本控制的地址很可能是找零地址。因此，它仍然属于同一用户。

这里是一个可以合理应用此启发式方法的交易：

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/notext/33/05.webp)

来源：[Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)
在这个案例中，我们可以看到输入编号0和输出编号1使用的是P2WPKH脚本（SegWit V0），而输出编号0使用的是不同类型的脚本，即P2PKH（传统）。在2010年代初期，由于可用的脚本类型受限，基于脚本版本的启发式方法相对来说用处不大。然而，随着时间的推移和比特币的连续更新，引入了越来越多样化的脚本类型。这种启发式方法变得越来越相关，因为随着脚本类型范围的扩大，用户被划分为更小的群体，从而增加了应用这种内部版本重用启发式方法的机会。因此，仅从隐私角度来看，建议选择最常见的脚本类型。例如，正如我写这些行时，Taproot脚本（`bc1p`）的使用频率低于SegWit V0脚本（`bc1q`）。尽管前者在某些特定情境下提供经济和隐私上的好处，但对于更传统的单签名用途，出于隐私原因，坚持使用较旧的标准可能是明智的，直到新标准被更广泛地采用。

### 圆整数额支付

另一个可以帮助我们识别找零的内部启发式方法是圆整数额。通常，在面对一个简单的支付模式（1个输入和2个输出）时，如果其中一个输出花费了一个圆整数额，那么它代表了支付。

![BTC204](assets/en/33/06.webp)

通过排除法，如果一个输出代表支付，另一个则代表找零。因此，可以推断用户输入交易的人仍然拥有被识别为找零的输出。

应该注意的是，这种启发式方法并不总是适用，因为大多数支付仍以法定货币单位进行。实际上，当法国的商家接受比特币时，通常他们不会以sats显示稳定的价格。他们宁愿选择将欧元价格和要支付的比特币金额之间进行转换。因此，交易输出中不应该有圆整数。

尽管如此，分析师可以尝试通过考虑交易在网络上广播时的有效汇率来进行这种转换。让我们以一个输入为`97,552 sats`和两个输出，一个为`31,085 sats`，另一个为`64,152 sats`的交易为例。乍一看，这笔交易似乎不涉及圆整数额。然而，通过应用交易时的€64,339汇率，我们得到的欧元转换如下所示：
- 一个输入为€62.76；
- 一个输出为€20；
- 一个输出为€41.27。
一旦转换成法定货币，这笔交易允许应用圆整数额支付的启发式方法。€20的输出很可能是为了商家，或至少是所有权发生了变更。通过推断，€41.27的输出很可能仍然由原始用户持有。
![BTC204](assets/en/33/07.webp)

如果有一天，比特币成为我们交易中首选的计价单位，这种启发式方法对于分析可能会变得更加有用。

例如，这里有一个可能适用这种启发式方法的交易：

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/notext/33/08.webp)
来源：[Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)
### 最大输出

当在简单支付模型中发现两个交易输出之间有足够大的差距时，可以估计较大的输出很可能是找零。

![BTC204](assets/en/33/09.webp)

这种最大输出的启发式方法可能是所有方法中最不精确的。如果单独识别，它相当弱。然而，这个特征可以与其他启发式方法结合使用，以减少我们解释的不确定性。

例如，如果我们检查一个交易，展示一个输出有一个整数金额，另一个输出有更大的金额，那么整数支付和最大输出的启发式方法的联合应用允许我们降低我们的不确定性水平。

例如，这里是一个可能适用这种启发式方法的交易：

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/notext/33/10.webp)

来源：[Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## 外部启发式
<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>

研究外部启发式涉及分析某些元素的相似性、模式和特征，这些元素并非交易本身固有的。换句话说，如果之前我们限于利用交易内在的元素进行内部启发式分析，现在我们通过外部启发式扩展了我们的分析领域到交易环境。

### 地址重用

这是比特币爱好者中最著名的启发式方法之一。地址重用允许建立不同交易和不同UTXOs之间的链接。当一个比特币接收地址被多次使用时，就会观察到地址重用。

因此，可以在同一交易中利用地址重用作为内部启发式方法来识别找零（如前一章所见）。然而，地址重用也可以作为外部启发式方法来识别多个交易背后的同一实体的独特性。

地址重用的解释是，锁定在此地址上的所有UTXOs都属于（或曾属于）同一实体。这种启发式方法留下的不确定性很小。当能够识别它时，随之而来的解释很可能与现实相符。因此，它允许对不同的链上活动进行分组。

![BTC204](assets/en/34/01.webp)

正如本部分第3章引言中所解释的，这种启发式方法是由中本聪自己发现的。在白皮书中，他特别提到了一个避免产生它的解决方案，那就是每个新交易都使用一个新地址：

"_作为一个额外的防火墙，每个交易都可以使用一对新的密钥，以防止它们被链接到一个共同的所有者。_"

![BTC204](assets/notext/34/02.webp)

来源：S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

例如，这里是一个在多个交易中重用的地址：

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0

![BTC204](assets/notext/34/03.webp)

来源：[Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### 脚本相似性和钱包指纹

除了地址重用之外，还有许多其他启发式方法可以将行动链接到同一个钱包或一组地址。
首先，分析师可以从脚本的使用相似性中受益。例如，某些少数脚本，如多签名，比SegWit V0脚本更容易被识别。我们隐藏的群体越大，我们就越难被发现。这就是为什么在好的Coinjoin协议中，所有参与者都使用完全相同类型的脚本的原因。
更广泛地说，分析师还可以关注钱包的特征指纹。这些是与使用相关的特定过程，人们可能试图识别它们，以便将它们作为追踪启发式方法。换句话说，如果观察到归因于被追踪实体的交易上积累了相同的内部特征，那么可以尝试在其他交易上识别这些相同的特征。

例如，可以识别出被追踪的用户系统性地将他们的零钱发送到P2TR地址（`bc1p…`）。如果这个过程重复，它可以作为我们分析继续的启发式方法。还可以使用其他指纹，例如UTXOs的顺序、零钱在输出中的位置、RBF（Replace-by-Fee）的标示，甚至是版本号、`nSequence`字段和`nLockTime`字段。

![BTC204](assets/en/34/04.webp)

正如[@LaurentMT](https://twitter.com/LaurentMT)在[Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)（一个法语播客）中指出的，钱包指纹在链分析中的作用随着时间的推移显著增加。实际上，脚本类型的不断增加和这些新功能由钱包软件逐渐部署，加剧了差异。甚至可能准确识别出被追踪实体使用的软件。因此，重要的是要理解，钱包指纹的研究对于近期交易特别相关，比起20世纪10年代初期启动的那些交易更是如此。

总结来说，指纹可以是任何特定的实践，由钱包自动执行或用户手动执行，可以在其他交易上找到，以协助我们进行分析。

### 公共输入所有权启发式（CIOH）

CIOH，即英文"Common Input Ownership Heuristic"的缩写，是一种启发式方法，它表明当一个交易包含多个输入时，这些输入很可能都来自单一实体。因此，它们的所有权是共同的。
要应用共同输入所有权启发式（CIOH），我们首先观察一个具有多个输入的交易。这可能少至2个输入，多至30个输入。一旦识别出这个特征，我们检查交易是否不符合已知的交易模型。例如，如果它有5个输入，数量大致相同，以及5个输出，数量完全相同，我们知道这是coinjoin的结构。因此，我们不能应用CIOH。
然而，如果交易不符合任何已知的协作交易模型，那么我们可以推断所有输入很可能来自同一个实体。这对于扩展已知的集群或继续追踪非常有用。

CIOH是由中本聪发现的。他在白皮书的第10部分讨论了它：

“_[...] 多输入交易不可避免地链接，必然显示它们的输入是由同一所有者拥有的。风险在于，如果密钥的所有者被揭示，链接可以揭示属于同一所有者的其他交易。_”

特别引人注目的是，中本聪甚至在比特币正式推出之前，就已经识别出了用户隐私方面的两个主要漏洞，即CIOH和地址重用。这种先见之明相当了不起，因为这两种启发式方法，即使在今天，仍然是链分析中最有用的。

给你一个我们可能会应用CIOH的交易示例：

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

来源：[Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### 链下数据

显然，链分析不仅限于链上数据。来自之前分析的任何数据或在互联网上可用的数据也可以用来精细化分析。
例如，如果观察到追踪的交易系统性地从同一个比特币节点广播，并且可以识别其IP地址，那么可能能够发现来自同一实体的其他交易，除了确定发送者身份的一部分。虽然这种做法不容易实现，因为它需要操作许多节点，但一些专门从事链分析的公司可能会采用这种做法。

分析师还可以依赖之前公开的分析，或他们自己之前的分析。也许人们会发现一个输出指向一个已经被识别的地址集群。有时，也可以依赖指向交易平台的输出，这些公司的地址通常是已知的。

同样，人们可以通过排除法进行分析。例如，如果在分析一个有两个输出的交易时，其中一个输出链接到一个已知但与被追踪实体不同的地址集群，那么可以解释说另一个输出很可能代表找零。

链分析还包括一部分更通用的OSINT（*开源情报*）与互联网搜索。这就是为什么建议不要在社交媒体或网站上直接发布接收地址，无论是使用化名还是不使用化名。

![BTC204](assets/notext/34/10.webp)

### 时间模型
虽然不常被人们想到，但某些人类行为在链上是可以识别的。在分析中最有用的可能是你的睡眠模式！是的，当你睡觉时，你大概不会广播比特币交易。由于你通常在相同的时间段睡觉，因此在链上分析中常常使用时间分析。这仅仅涉及到记录给定实体的交易被广播到比特币网络的时间。分析这些时间模式允许我们推断出许多信息。

首先，时间分析有时允许识别被追踪实体的性质。如果观察到交易在24小时内持续不断地被广播，那么这将暴露出强烈的经济活动。这些交易背后的实体很可能是一家公司，可能是国际性的，而且可能在内部有自动化程序。

例如，几个月前，我通过分析[错误地分配了19个比特币作为手续费的交易](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd)认出了这种模式。一个简单的时间分析让我假设我们正在处理一个自动化服务，因此很可能是一个大型实体，如一个交易平台。
实际上，几天后，发现这些资金属于PayPal，通过交易平台Paxos。

相反，如果我们看到时间模式相当分散在16个非常特定的小时内，那么我们可以估计我们正在处理一个个人用户，或者可能是一个根据交易量来看的本地商业。

除了观察到的实体的性质之外，时间模式还可以通过时区给我们一个用户的大致位置。因此，我们可以将其他交易链接起来，并使用这些交易的时间戳作为可以添加到我们分析中的额外启发式方法。

例如，在我之前谈到的重复使用的地址上，我们可以观察到，无论是进账还是出账的交易，都集中在一个13小时的时间间隔内。

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/notext/34/11.webp)

来源：OXT.me

这个间隔很可能对应于欧洲、非洲或中东。因此，我们可以推断这些交易背后的用户住在那里。

在不同的注册中，也是这种类型的时间分析，让人假设中本聪不是从日本操作，而是确实来自美国：[*中本聪的时区*](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## 使用区块浏览器的实际应用
<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

在这最后一章中，我们将具体应用到目前为止我们已经学习的概念。我将向你展示真实的比特币交易示例，你将需要提取我询问的信息。
理想情况下，对于这些练习，使用专业的链分析工具会更好。然而，自从Samourai Wallet的创建者被逮捕以来，唯一的免费分析工具OXT.me不再可用。因此，我们将选择使用经典的区块浏览器来进行这些练习。我推荐使用[Mempool.space](https://mempool.space/)，因为它具有众多功能和一系列链分析工具，但你也可以选择其他浏览器，如[Bitcoin Explorer](https://bitcoinexplorer.org/)。首先，我将介绍这些练习。使用你的区块浏览器完成它们，并将你的答案写在一张纸上。然后，在本章的最后，我将提供答案，以便你可以检查并更正你的结果。

*这些练习中选定的交易仅因其特征以某种随机方式被选中。本章仅用于教育和信息目的。我想澄清，我不支持或鼓励使用这些工具进行恶意目的。目标是教你如何保护自己免受链分析，而不是进行分析以暴露他人的私人信息。*

### 练习 1

要分析的交易ID：

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

这笔交易的模型名称是什么，仅通过检查其模型，即交易的结构，可以得出哪些合理的解释？

### 练习 2

要分析的交易ID：

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

这笔交易的模型名称是什么，仅通过检查其模型，即交易的结构，可以得出哪些合理的解释？

### 练习 3

要分析的交易ID：

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

这笔交易的模型是什么？

在识别其模型后，使用交易的内部启发式规则，哪个输出很可能代表找零？

### 练习 4

要分析的交易ID：

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

这笔交易的模型是什么？
在识别其模型后，使用交易的内部启发式规则，哪个输出很可能代表找零？

### 练习 5

想象Loïc在社交网络Twitter上发布了他的一个比特币接收地址：

![BTC204](assets/notext/35/1.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

**仅使用地址重用启发式规则**，我们可以将哪些比特币交易与Loïc的身份联系起来？

*显然，我不是这个接收地址的真正拥有者，我也没有在社交网络上发布它。这是我从区块链上随机挑选的一个地址。*

### 练习 6

继练习 5 之后，感谢地址重用启发式规则，你能够识别出Loïc似乎参与的几笔比特币交易。通常，在识别的交易中，你应该已经发现了这一笔：
这笔交易是第一次向Loïc的地址发送资金的交易。在您看来，Loïc通过这笔交易收到的比特币来自哪里？

### 练习 7

继练习 5 之后，由于地址重用启发式规则，您能够识别出Loïc似乎涉及的几笔比特币交易。现在，您希望找出Loïc来自哪里。基于找到的交易，进行时间分析以找出Loïc可能使用的时区。从这个时区确定Loïc似乎居住的地点（国家、州/地区、城市...）。

![BTC204](assets/notext/35/2.webp)

### 练习 8

这是要研究的比特币交易：

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

仅通过观察这笔交易，我们能解读出哪些信息？

### 练习的解答

***练习 1：***
这笔交易的模型是简单支付。如果我们仅研究其结构，我们可以解读出一个输出代表找零，另一个输出代表实际支付。因此，我们知道观察到的用户可能不再拥有输出中的两个UTXO之一（用于支付的那个），但仍然拥有另一个UTXO（用于找零的那个）。

***练习 2：***
这笔交易的模型是批量支出。这个模型很可能表明有重大的经济活动，例如一个交易平台。我们可以推断，输入中的UTXO来自于一个有重大经济活动的公司，输出中的UTXO将会分散。一些将属于已将他们的比特币提取到自我保管钱包的公司客户。其他可能流向合作公司。最后，肯定会有一个找零返回给发行公司。

***练习 3：***

这笔交易的模型是简单支付。因此，我们可以对交易应用内部启发式规则，试图识别找零。

我个人至少识别出两个支持相同假设的内部启发式规则：
- 使用相同类型的脚本重用；
- 最大的输出。

最明显的启发式规则是使用相同类型的脚本重用。确实，输出 `0` 是一个 `P2SH`，可通过其接收地址以 `3` 开头识别：

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

而输出 `1` 是一个 `P2WPKH`，可通过其地址以 `bc1q` 开头识别：

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

这笔交易中使用的输入UTXO也使用 `P2WPKH` 脚本：

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

因此，我们可以假设输出 `0` 对应于支付，而输出 `1` 是交易的找零，这意味着输入中的用户仍然拥有输出 `1`。
为了支持或反驳这个假设，我们可以寻找其他启发式方法，这些方法要么确认我们的想法，要么降低我们的假设正确的可能性。
我至少发现了另一种启发式方法。它是最大的输出。输出`0`的量为`123,689 sats`，而输出`1`的量为`505,839 sats`。因此，这两个输出之间存在显著差异。最大输出的启发式方法表明，最大体积的输出很可能是找零。这种启发式方法因此进一步加强了我们最初的假设。

看来，提供输入UTXO的用户仍然持有输出`1`，这似乎代表了交易的找零。

***练习 4:***
这笔交易的模型是一个简单的支付。因此，我们可以对交易应用内部启发式方法，尝试识别找零。
我个人至少识别了两种支持同一假设的内部启发式方法：
- 重复使用相同类型的脚本；
- 输出一个整数金额。

最明显的启发式方法是重复使用相同类型的脚本。实际上，输出`0`是一个`P2SH`，可以通过其接收地址以`3`开头识别：

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

而输出`1`是一个`P2WPKH`，可以通过其地址以`bc1q`开头识别：

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

作为这笔交易输入的UTXO也使用了`P2WPKH`脚本：

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

因此，我们可以假设输出`0`对应于一次支付，而输出`1`是交易的找零，这意味着输入中的用户仍然拥有输出`1`。

为了支持或反驳这个假设，我们可以寻找其他启发式方法，这些方法要么确认我们的想法，要么降低我们的假设正确的可能性。

我至少发现了另一种启发式方法。它是输出一个整数金额。输出`0`的量为`70,000 sats`，而输出`1`的量为`22,962 sats`。因此，我们面对的是一个在BTC单位账户中完美整数的输出。整数输出的启发式方法表明，具有整数金额的UTXO很可能是支付，而另一个则代表找零。这种启发式方法因此进一步加强了我们最初的假设。

然而，在这个例子中，另一种启发式方法可能会质疑我们最初的假设。实际上，输出`0`大于输出`1`。如果我们基于最大输出通常是找零的启发式方法，我们可能会推断输出`0`是找零。然而，这个反假设似乎不太可能，因为其他两种启发式方法看起来比最大输出的启发式方法更有说服力。因此，尽管存在这种明显的矛盾，保持我们最初的假设似乎是合理的。
因此，看来提供输入UTXO的用户仍然持有`1`输出，这似乎代表了交易的找零。
***练习 5:***
我们可以看到，有8笔交易可以与Loïc的身份关联。其中，4笔涉及接收比特币：

```plaintext
***练习 6：***
如果我们检查这笔交易的模型，显然这是一种分组支出。事实上，该交易有一个输入和51个输出，这表明了重大的经济活动。因此，我们可以假设Loïc从一个交易平台提取了比特币。

几个元素加强了这一假设。首先，用于保护输入中UTXO的脚本类型是2/3多签名P2SH脚本，这表明了交易平台典型的高级安全级别：

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```
此外，分析的地址`3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF`在超过220,000个不同的交易中被重用，这通常是交易平台的特征，通常不关心他们的隐私。应用于此地址的时间启发式分析还显示，在3个月的时间里，几乎每天都有交易，全天24小时的延长时间，表明交易平台的持续活动。

最后，这个实体处理的交易量巨大。事实上，该地址在2022年12月到2023年3月之间，在222,262笔交易中收到并发送了44 BTC。这些显著的交易量进一步确认了交易平台活动性质的可能性。
通过分析交易的确认时间，可以注意到以下UTC时间：
```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

分析这些时间，似乎UTC-7和UTC-8时区与大多数时间的一系列常见人类活动（在08:00到23:00之间）一致：

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7

05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

![BTC204](assets/notext/35/2.webp)

UTC-7时区在夏季尤其相关，因为它包括如下州和地区：
- 加利福尼亚州（包括洛杉矶、旧金山和圣地亚哥等城市）；
- 内华达州（包括拉斯维加斯）；
- 俄勒冈州（包括波特兰）；
- 华盛顿州（包括西雅图）；
- 加拿大的不列颠哥伦比亚地区（包括温哥华和维多利亚等城市）。

这些信息表明，Loïc很可能居住在美国或加拿大的西海岸。

***练习8：***
这次交易的分析揭示了5个输入和一个输出，这似乎表明了一次整合。应用CIOH启发式分析表明，所有输入中的UTXOs都由单一实体持有，并且输出中的UTXO也属于这个实体。看来用户选择将他们拥有的几个UTXOs整合到输出中的单个UTXO中，目的是整合他们的硬币。这种方法可能是出于希望利用当时的低交易费用来减少未来费用的愿望。

___

*在撰写这部分关于链上分析的第3部分时，我依赖于以下资源：*
- *由Samourai Wallet在2021年制作的四篇文章系列：[Understanding Bitcoin Privacy with OXT](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923);*
- *[OXT Research](https://medium.com/oxt-research)的各种报告，以及他们的免费链上分析工具（目前由于Samourai Wallet的创始人被捕，该工具暂时不可用）;*
- *更广泛地，我的知识来自[@LaurentMT](https://twitter.com/LaurentMT)和[@ErgoBTC](https://twitter.com/ErgoBTC)的各种推文和内容；*
- *我参加了[Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)节目，与[@louneskmt](https://twitter.com/louneskmt)、[@TheoPantamis](https://twitter.com/TheoPantamis)、[@Sosthene___](https://twitter.com/Sosthene___)和[@LaurentMT](https://twitter.com/LaurentMT)一起。*
*我想感谢他们的作者、开发者和制作人。也感谢那些对作为本部分第3部分基础的文章进行了细致校正并赐予我专家建议的审稿人：*
- *[Gilles Cadignan](https://twitter.com/gillesCadignan);*
- *[Ludovic Lars](https://viresinnumeris.fr/).*

# 掌握最佳实践以保护您的隐私
<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## 地址重用
<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>
在研究了可能危害比特币隐私的技术后，我们在这第三部分将探讨为保护自己应采取的最佳实践。这部分的目标不是探索提高隐私的方法，这一主题将在后面讨论，而是理解如何正确地与比特币互动，以维护其自然提供的隐私，无需采用额外技术。
显然，要开始这第三部分，我们将讨论地址重用。这一现象构成了对用户隐私的主要威胁。因此，这一章可以说是整个培训中最重要的章节。

### 什么是接收地址？

比特币接收地址是一个字符串或标识符，用于在钱包中接收比特币。

技术上，比特币接收地址并不是字面意义上的“接收”比特币，而是定义了比特币可以被花费的条件。具体来说，当有人向你发送付款时，发送者的交易在其消耗的输入的UTXOs中创建了一个新的、意图给你的UTXO。在这个输出上，应用了一个定义如何以后花费这个UTXO的脚本。这个脚本被称为“*ScriptPubKey*”或“*锁定脚本*”。你的接收地址，更准确地说是它的有效载荷，被集成到这个脚本中。简化来说，这个脚本基本上规定：

> “*要花费这个新的UTXO，必须提供一个使用与此接收地址关联的私钥的数字签名。*”

![BTC204](assets/notext/41/01.webp)

比特币地址根据使用的脚本模型有不同的类型。最初的模型被称为“*Legacy*”，包括`P2PKH`（*Pay-to-PubKey-Hash*）和`P2SH`（*Pay-to-Script-Hash*）地址。P2PKH地址总是以`1`开头，P2SH以`3`开头。尽管这些格式仍然安全，但它们现在已经过时，因为它们导致更高的交易费用，并且与新标准相比提供较少的隐私。
SegWit V0（`P2WPKH` 和 `P2WSH`）以及 Taproot / SegWit V1（`P2TR`）地址代表了现代格式。SegWit 地址以 `bc1q` 开头，而在 2021 年引入的 Taproot 地址则以 `bc1p` 开头。例如，这是一个 Taproot 接收地址：

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

ScriptPubKey 的构造方式将取决于您使用的标准：
| 脚本模型        | ScriptPubKey                                                |
| ---------------- | ----------------------------------------------------------- |
| P2PKH           | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG |
| P2SH            | OP_HASH160 `<scriptHash>` OP_EQUAL                          |
| P2WPKH          | 0 `<pubKeyHash>`                                            |
| P2WSH           | 0 `<witnessScriptHash>`                                     |
| P2SH - P2WPKH   | OP_HASH160 `<redeemScriptHash>` OP_EQUAL                    |
| P2SH - P2WSH    | OP_HASH160 `<redeemScriptHash>` OP_EQUAL                    |
| P2TR            | 1 `<pubKey>`                                                |

关于接收地址的构造，它也取决于所选的脚本模型：
- 对于 `P2PKH` 和 `P2WPKH` 地址，载荷，即地址的核心，代表公钥的哈希；
- 对于 `P2SH` 和 `P2WSH` 地址，载荷代表脚本的哈希；
- 至于 `P2TR` 地址，载荷是一个调整过的公钥。`P2TR` 输出结合了 _向公钥支付_ 和 _向脚本支付_ 的方面。调整过的公钥是将经典的支付公钥与从一组也可用于支付比特币的脚本的默克尔根导出的“调整值”相加的结果。

您的钱包软件上显示的地址还包括一个 HRP（*人类可读部分*），通常为 SegWit 地址后的 `bc`，一个分隔符 `1`，以及版本号 `q` 用于 SegWit V0 和 `p` 用于 Taproot/SegWit V1。还添加了校验和以确保地址在传输过程中的完整性和有效性。

最后，地址被放入标准格式：
- 旧的 Legacy 地址使用 Base58check；
- SegWit 地址使用 Bech32；
- Taproot 地址使用 Bech32m。

这是从 base 10 到 bech32 和 bech32m 格式（SegWit 和 Taproot）的加法矩阵：

| +   | 0   | 1   | 2   | 3   | 4   | 5   | 6   | 7   |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0   | q   | p   | z   | r   | y   | 9   | x   | 8   |
| 8   | g   | f   | 2   | t   | v   | d   | w   | 0   |
| 16  | s   | 3   | j   | n   | 5   | 4   | k   | h   || 24  | c   | e   | 6   | m   | u   | a   | 7   | l   |
### 什么是地址重用？

地址重用指的是使用同一个接收地址来阻止多个不同的UTXOs的做法。

正如我们在前一节中看到的，每个UTXO都有自己的ScriptPubKey来锁定它，并且必须满足条件才能在新交易中作为输入被消耗。接收地址（有效载荷）就集成在这个ScriptPubKey中。

当不同的ScriptPubKeys包含相同的接收地址时，这就被称为地址重用。实际上，这意味着用户多次向发送者提供了相同的地址，通过多次支付来接收比特币。而实际上，这种做法对你的隐私是灾难性的。

### 为什么地址重用是一个问题？

鉴于区块链是公开的，很容易看到哪些地址锁定了哪些UTXOs以及有多少比特币。如果同一个地址用于多次交易，就有可能推断出与该地址关联的所有比特币属于同一个人。这种做法通过允许在不同交易之间建立确定性链接并追踪区块链上的比特币，从而妥协了用户的隐私。中本聪自己在比特币白皮书中强调了这个问题：

> *作为一个额外的防火墙，每一笔交易都可以使用一对新的密钥，以防止它们被链接到一个共同的所有者。*

![BTC204](assets/notext/34/02.webp)

来源：S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

中本聪在这个声明中寻求的目标是在比特币上用户的身份与一对密钥之间的关联的情况下，创建一个额外的防火墙，以避免他们的所有活动公开地与他们的身份联系起来。今天，随着链分析公司和KYC规定的增多，使用唯一地址不再是一个“额外的防火墙”，而是任何希望保持最低限度隐私的人的必要做法。

当你重用一个地址时，你几乎无可否认地将所有与该地址相关的交易联系起来。虽然这不会直接危及你的资金，因为椭圆曲线上的密码学确保了你的私钥的安全，但它便于监控你的活动。实际上，任何拥有节点的人都可以观察地址的交易和余额，从而完全妥协你的匿名性。

![BTC204](assets/en/34/01.webp)
为了说明这一点，让我们以Bob为例，他是一个定期以小额通过DCA（Dollar Cost Averaging）购买比特币的用户，并且总是将它们发送到同一个地址。两年后，这个地址包含了大量的比特币。如果Bob使用这个地址向一个本地商家进行支付，后者可以看到所有相关的资金并推断出Bob的财富。这可能导致个人安全风险，包括盗窃或勒索的企图。如果Bob使用了一个新地址来接收每次定期购买的比特币，他就会向商家透露出无限少的信息。

在链分析中，我们区分两种类型的地址重用：
- 外部重用；
- 交易内部的重用。

首先是在几个不同的比特币交易中重用一个地址时观察到的。这就是我们之前讨论的：这种启发式方法让我们能够推断出通过这个地址传递的所有UTXOs属于单一实体。
内部地址重用并非在跨多个交易时发生，而是在同一笔交易内部发生时观察到的。实际上，如果用于锁定输入的同一个地址在交易中被用作输出，那么我们可以推断这个输出仍然属于同一个用户（零钱），而第二个输出代表实际的支付。这种启发式方法允许跟踪跨多个交易的资金流动。

![BTC204](assets/en/33/02.webp)

地址重用对比特币来说是一个真正的祸害。根据网站OXT.me（目前无法访问），2022年比特币上的地址重用总率约为52%：

![BTC204](assets/notext/41/02.webp)

这个比率非常高，但主要是来自交易平台而不是个人用户。

### 如何避免地址重用？

避免地址重用相当简单：**对钱包中的每一笔新进款使用一个新的、未使用过的地址**。

多亏了BIP32，现代钱包现在是确定性的和层次化的。这意味着用户可以从单一的初始信息——种子，生成大量的地址。通过保存这个单一的信息，就可以恢复钱包的所有私钥，从而访问由相应地址保护的资金。

![BTC204](assets/notext/41/03.webp)
这就是为什么，当你在钱包软件中按下“*接收*”按钮时，每次都会提供给你一个未使用的接收地址。在这个地址上收到比特币后，软件会自动建议一个新的地址。
> *PS：最近，一些钱包软件宣布他们打算停止生成空白地址，担心这可能被当局视为一种洗钱形式。如果你的软件在这些之中，我强烈建议你立即更换它，因为这对用户来说是不可接受的。*

如果你需要一个静态标识符来接收支付，例如接收捐款，由于重用风险，建议不要使用经典的比特币地址。可以选择使用闪电网络地址，或者对于静态链上支付标识符，你可以选择BIP47或静默支付。这些协议的操作在本培训的第6部分有详细说明。

## 标记和币控制
<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>

正如我们在关于链分析的部分中发现的，有许多启发式方法和模式可以用来推断有关交易的信息。作为用户，了解这些技术以更好地保护自己是很重要的。

这涉及到对你的自管钱包进行严格管理，包括了解你的UTXO的来源，以及在支付时对UTXO进行深思熟虑的选择。这种有效的钱包管理依赖于好的比特币钱包的两个重要功能：标记和币控制。

在本章中，我们将研究这些功能，并看看你如何能够智能地使用它们，而不增加太多工作量，从而在比特币上大大优化你的隐私。

### 什么是标记？

标记是一种将注释或标签分配给比特币钱包中特定UTXO的做法。这些注释由钱包软件本地存储，永远不会通过比特币网络传输。因此，标记是一种个人管理工具。

例如，如果我拥有一个来自与Charles在Bisq上的P2P购买的UTXO，我可以给它分配标签“`非KYC Bisq Charles`”。
标记是一种良好的实践，有助于记住UTXO的来源或预期目的地，从而促进资金管理并优化隐私。实际上，您的比特币钱包很可能保护着几个UTXO。如果这些UTXO的来源不同，您将来可能不想合并这些UTXO，否则，您可能会暴露它们的共同所有权。通过适当地标记您的所有硬币，您确保在需要使用它们时记住它们的来源，即使那只是在几年后。

### 什么是硬币控制？

当与钱包软件上的硬币控制选项结合使用时，标记的积极使用变得更加有趣。

硬币控制是优秀的比特币钱包软件中存在的一个功能，它使您能够手动选择特定的UTXO作为输入来执行交易。实际上，为了满足输出中的支付，需要以输入中消耗一个UTXO作为回报。出于我们稍后将看到的几个原因，您可能希望准确选择哪些硬币作为输入来满足给定的支付。这正是硬币控制允许您做的事情。给您一个类比，这个功能类似于当您支付您的法棍面包时从钱包中选择特定硬币的行为。

![BTC204](assets/notext/42/01.webp)

使用具有硬币控制功能的钱包软件，结合UTXO的标记，允许用户区分并精确选择他们交易的UTXO。

### 如何正确标记您的UTXO？

没有适合每个人的标记UTXO的通用方法。由您来定义一个标记系统，以便您可以轻松找到您的钱包。无论如何，请记住，好的标记是您在需要时能够理解的标记。如果您的比特币钱包主要用于储蓄，可能几十年后标签才对您有用。因此，请确保它们清晰、准确且全面。

重要的是，如果有一天您的亲人需要访问您的钱包，他们可以轻松识别资金的来源。这可能会帮助他们出于隐私原因以及法律必要性，在他们需要向权威机构证明资金来源时提供帮助。
标记最重要的方面是记录UTXO的来源。您应该简单地指明这枚硬币是如何到达您的钱包的。它是来自交易平台上的购买吗？客户的支付？点对点交换？还是购买的找零？因此，您可以指定：
- `Withdrawal Exchange.com提现`;
- `Payment Client David客户大卫支付`;
- `P2P Purchase Charles点对点购买查尔斯`;
- `Change from sofa purchase沙发购买找零`

![BTC204](assets/en/42/02.webp)

为了细化您的UTXO管理并坚持您在钱包内的资金隔离策略，您可以用一个额外的指标丰富您的标签，以反映这些分隔。如果您的钱包包含两类您不希望混合的UTXO，您可以在标签中整合一个标记以清晰区分这些组。这些分隔标记将取决于您自己的标准，例如区分涉及KYC的获取过程中的UTXO，或者区分专业和个人资金。采用前面提到的标签示例，这可以转化为：
- `KYC - Withdrawal Exchange.com KYC提现`;
- `KYC - Payment Client David KYC客户大卫支付`;
- `NO KYC - P2P Purchase Charles 无KYC点对点购买查尔斯`;
- `NO KYC - Change from sofa purchase 无KYC沙发购买找零`

![BTC204](assets/en/42/03.webp)
建议在交易过程中持续标记一个硬币。例如，在合并无需KYC的UTXO时，确保将结果UTXO标记不仅仅为`consolidation`，而是具体为`no-KYC consolidation`，以保持对硬币起源的清晰追踪。
最后，给标签加上日期并非强制性的。大多数钱包软件已经显示了交易日期，并且总是可以使用其TXID在区块浏览器上检索到这些信息。

### 如何正确选择您的硬币？

当您进行交易时，硬币控制允许您特定选择哪些UTXO作为输入来满足支付的输出。在这个选择中应考虑两个方面：
- 支付接收者将您的身份的一部分与用作输入的UTXO关联的可能性；
- 外部观察者建立所有作为输入消耗的UTXO之间联系的能力。
为了说明第一点，让我们举一个具体的例子。假设您用比特币从当地面包师那里买了一条法棍。您使用一个或多个您拥有的UTXO作为输入，至少覆盖法棍的价格输出，以及交易费用。您的面包师随后可能将您的面孔，或他们知道的您身份的任何其他部分，与作为输入的硬币关联起来。知道了这种联系的存在，您可能更愿意在支付时选择特定的UTXO而不是另一个。
![BTC204](assets/notext/42/04.webp)

例如，如果您的一个UTXO来自一个交易平台，并且您希望面包师不知道您在该平台的账户，您会避免使用这个UTXO进行支付。如果您拥有一个揭示了大量比特币的高价值UTXO，您也可能选择不使用它，以防止面包师知道您的BTC财富。

因此，用于这第一点的UTXO选择基于个人决策，受您愿意透露或不透露的影响。您在收到UTXO时分配给它们的标签将帮助您选择那些，一旦花费，只暴露您愿意向接收者透露的信息。

除了可能向接收者透露的信息外，输入的选择还影响您向所有区块链观察者披露的内容。实际上，通过使用多个UTXO作为交易的输入，您揭示了它们由同一实体拥有，根据共同输入所有权启发式（CIOH）。

![BTC204](assets/notext/42/05.webp)

在选择您的硬币时，您必须意识到您即将广播的交易将在所有使用的UTXO之间创建链接。这种链接可能对您的个人隐私构成问题，特别是如果UTXO来自不同来源。

![BTC204](assets/notext/42/06.webp)

让我们回到我的无需KYC的UTXO从Bisq的例子；我想避免将其与来自例如知道我的身份的受管制交易平台的UTXO结合。实际上，如果我曾经在同一笔交易中使用这2个UTXO作为输入，受管制的平台将能够将我的身份与我在Bisq上购买的UTXO联系起来，而在此之前它并未与我的身份联系。

![BTC204](assets/notext/42/07.webp)
最后，为了正确选择哪些UTXO作为交易的输入，最重要的是避免使用多个UTXO。只要可能，就选择一个足够大的单一硬币来支付你的款项。通过这样做，你可以完全避免与COINJOIN相关的风险。然而，如果没有单个UTXO足以支付款项，而你必须使用几个，请确保它们来自类似的来源，以最小化不想要的链接的风险。同时，记住接收者可能会将他们对你的了解与作为输入的硬币的历史联系起来。

### 理解自动硬币选择

在前面的章节中，我们讨论了交易中UTXO的手动选择。但是，当钱包软件自动进行这种选择时会发生什么呢？存在几种确定要消费哪些硬币的方法，而UTXO的选择是比特币研究领域的一个真正领域。这个自动过程的主要目标通常是为用户最小化交易费用。

FIFO（*先进先出*）和LIFO（*后进先出*）等UTXO选择方法是最简单但也是最不高效的。使用FIFO，钱包中最旧的硬币首先被使用。这种方法通常在最小化交易费用和保护隐私方面都是低效的，除非在使用相对时间锁并且必须定期更新的情况下。相反，LIFO优先使用最新的UTXO。尽管简单，这两种方法通常被证明是低效的。

更高级的方法是*背包求解器*。这是比特币核心钱包直到0.17版本使用的方法。它涉及从钱包中迭代和随机选择UTXO，将它们加在子集中，并保留尽可能减少交易重量的解决方案，以减少用户的费用。
*分支定界法*（BNB），通常被昵称为“Murch's algorithm”，以其发明者命名，从0.17版本开始在比特币核心中取代了*背包求解器*。这种更高级的方法旨在找到一组UTXO，完全匹配交易输出所需的金额。BNB的目标是通过减少所谓的浪费标准（考虑到即时成本和预期的找零未来成本）来最小化找零金额以及费用。这种方法源自1960年由Ailsa Land和Alison Harcourt设计的原始*分支定界法*概念，并与*背包求解器*相比提供了更精确的费用优化。
所有这些自动UTXO选择方法在减少交易费用方面可能是有效的，但它们在保护用户隐私方面通常是低效的。实际上，这些算法可以将几个UTXO合并为输入，因此由于COH，揭示了这些UTXO的共同所有权。显然，这些方法不能考虑附加在UTXO上的标签，这对于有意识地选择向交易接收者透露哪些硬币至关重要。目前，优化选择硬币时的隐私的唯一解决方案是手动进行。

### UTXO标记教程

如果你想学习如何标记你的UTXO，我们已经创建了一个关于现有主要比特币钱包软件的完整教程：

https://planb.network/tutorials/privacy/utxo-labelling

## KYC和关键识别
<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>
KYC代表“了解你的客户”，这是一些在比特币领域运营的公司实施的一项监管程序。该程序旨在验证并记录其客户的身份，其声明的目标是打击洗钱和资助恐怖主义活动。
具体来说，KYC涉及收集客户的各种个人数据，这些数据根据司法管辖区的不同而有所不同，但通常包括身份证明文件、照片和居住证明。然后，这些信息被验证并保留以备将来使用。

这一程序已成为大多数西方国家所有受监管交易平台的强制性要求。这意味着任何希望通过这些平台将法定货币兑换为比特币的人都必须遵守KYC要求。
这一程序对用户的隐私和安全并非没有风险。在本章中，我们将详细检查这些风险，并分析KYC和身份验证过程对比特币用户隐私的具体影响。
### 促进链上追踪

与KYC相关的第一个风险是，它为链分析提供了一个有利的切入点。正如我们在前一部分中看到的，分析师可以使用交易模式和启发式方法对区块链上的活动进行分组和追踪。一旦他们设法将一个用户的链上活动进行聚类，找到他们所有交易和密钥中的任何一个切入点就足以完全破坏他们的隐私。

![BTC204](assets/notext/43/1.webp)

当你接受KYC时，你为链分析提供了一个非常高质量的切入点，因为你将从交易平台提取比特币时使用的接收地址与你的完整和验证过的身份链接起来。理论上，这些信息只有你提供给它的公司知道，但正如我们稍后将看到的，数据泄露的风险是真实存在的。此外，即使公司不分享这些信息，公司持有这些信息的事实本身也可能是有问题的。

因此，如果你不采取其他措施来限制你在区块链上活动的分组，任何知道KYC这个切入点的人都有可能将你在比特币上的所有活动与你的身份联系起来。从这家公司的角度来看，你使用比特币的行为因此失去了所有的保密性。

![BTC204](assets/notext/43/2.webp)

用一个比喻来说明，这就好比你的*X银行*的银行家不仅可以访问你在*X银行*进行的所有交易，还可以观察你与*Y银行*的交易以及你所有的现金交易。

请记住我们在本培训的第一部分中提到的：比特币的隐私模型，正如中本聪所设计的，依赖于用户身份与其密钥对之间的分离。尽管今天这层隐私已不再足够，但尽可能限制其退化仍然是明智的。

### 暴露于国家监视

KYC的第二个主要问题是，它向国家透露了你在某个时刻拥有过比特币。当你通过受监管的主体购买比特币时，国家就有可能知道这一拥有情况。目前，这可能看起来微不足道，但重要的是要记住，你国家的政治和经济未来并不掌握在你手中。
首先，国家可以迅速采取威权立场。历史上充满了政策突然改变的例子。今天，在欧洲，比特币爱好者可以撰写关于比特币的文章，参加会议，并以自我保管的方式管理他们的钱包。但谁能说明天会发生什么？如果比特币突然成为公敌，那么在国家记录中与之相关联可能会证明是有问题的。
接下来，在面临严重的经济危机时，国家可能会考虑没收公民持有的比特币。也许明天，比特币持有者会被视为危机投机者，并因面对法定货币贬值而获得的资本收益而被征收过高的税款。

你可能认为这不是问题，因为你的比特币已经混合，因此无法追踪。然而，追踪在这里并不是问题。真正的问题是国家知道你拥有过比特币。这简单的信息就足以使你受到指控或要求解释。你可以试图声称你已经花掉了你的比特币，但这应该反映在你的税务申报中，否则你会被抓到。你也可以说你在一次划船事故中丢失了你的密钥，但除了Twitter上的笑话，你真的认为这足以使你免受指控吗？

因此，重要的是要考虑到仅仅因为国家可能知道你拥有过BTC，即使这个风险今天看起来可能很遥远，也与之相关的风险。

KYC在国家监控方面带来的另一个问题是受监管平台的强制报告。虽然我不熟悉其他司法管辖区的规定，在法国，*数字资产服务提供商*（PSAN）被要求向金融监管机构报告他们认为可疑的任何资金流动。

因此，在2023年法国，PSANs报告了1,449起可疑行为。目前，这些行为的大多数与犯罪有关。然而，当局还要求受监管平台报告任何仅基于其结构的可疑比特币交易。如果你进行合作交易，或者仅仅是进行了某种不典型模式的交易，并且这笔交易发生在你从这些平台提取比特币的时候附近，你可能会发现自己被报告给当局。即使在没有不当行为和合法行使你的权利的情况下，这种报告也可能导致增加的检查和监视，这是你没有KYC就可以避免的不便。

### 个人数据泄露的风险
KYC的另一个问题在于，它要求在私人公司的服务器上存储你的所有个人数据。最近的事件提醒我们，无论是财务还是IT相关，没有人能免于失败。2022年，Celsius的客户就遭受了后果。随着公司破产，债权人的姓名和他们的资产金额在行政程序中被美国司法系统公开。

大约两年多前，加密货币领域的一家领先的网络安全实体经历了其客户个人数据的盗窃。尽管这起事件并不直接与购买比特币有关，但对于交易平台来说，这种风险仍然存在。因此，这些个人数据相关的风险是确定的。

的确，我们已经将大量个人数据托付给私人公司。然而，这里的风险是双重的，因为这些数据不仅允许你被识别，而且还与比特币上的活动相关联。事实上，当黑客设法访问交易平台客户的数据时，他们可以合理地假设这些客户拥有比特币。因此，由于比特币和任何其他有价值的资产一样，吸引了小偷的兴趣，这种风险因此而增加。

在数据泄露事件中，最好的情况是，你可能成为针对性网络钓鱼尝试的目标。在最坏的情况下，你可能发现自己成为对你家的物理威胁的中心。
除了与比特币相关的特定风险外，还需要考虑与身份证件传输相关的危险。实际上，在数据泄露的情况下，有可能成为身份盗窃的受害者。因此，风险不仅仅限于保护交易的保密性，还涉及每个个人的个人安全。

### 关于KYC的常见误解

重要的是要揭穿一些关于KYC（了解你的客户）的常见误解，这些误解经常在Twitter上或在比特币用户之间的讨论中发现。
首先，认为通过KYC获得的比特币保护个人隐私是徒劳的，这种想法是错误的。比特币隐私的工具和方法多种多样，服务于不同的目的。例如，对通过KYC获得的比特币使用coinjoin交易并非坏主意。当然，需要谨慎使用受监管的交易平台，以避免冻结或禁用账户，但从纯技术角度来看，这些做法并不矛盾。Coinjoin的效果是打破了一个币的历史记录，这有助于你对抗与KYC相关的链分析风险。尽管它不能消除所有风险，但已经代表了一个重大的好处。
![BTC204](assets/notext/43/3.webp)

比特币上的隐私不应该以二元的方式来看待，即区分“匿名”比特币和其他非匿名的比特币。通过KYC获得的比特币并不意味着一切都失去了；相反，使用隐私工具可能会更加有益。

相反，通过非KYC方法获得比特币并不能保证完美的隐私，也不免除需要采取其他保护措施的必要性。如果你持有非KYC比特币但多次重用接收地址，你的交易可以被追踪和分组。与比特币世界外部的最轻微的联系都可能妥协你唯一的隐私层。因此，考虑所有提高比特币上隐私的工具和方法是重要的，它们是互补的。每种技术解决特定的风险，并可以增加额外的保护层。因此，拥有非KYC比特币绝对不免除采取其他预防措施的必要性。

### KYC能否撤销？

有时人们会问我，在完成KYC后是否可以“回头”，正如你从前面的段落中想象的那样，答案是复杂的。为了避免与KYC相关的风险，最简单的方法是在获取比特币时不使用它。我们将在下一章更深入地讨论这个话题。然而，如果已经进行了KYC并且已经购买了比特币，是否有办法减轻所承担的风险？

关于交易可追溯性的风险，使用coinjoin是一个解决方案。我们将在培训的后面详细讨论这种方法，但请注意，coinjoin可以打破一个币的历史记录，防止其过去-现在和现在-过去的追踪。即使是通过受监管平台获得的BTC，这种技术也可以防止它们的可追溯性。
然而，coinjoin并不能消除与KYC相关的第二个风险：即国家知晓你的比特币持有情况的事实。实际上，即使你的币不再可追踪，根据不同的司法管辖区，国家可能有权访问你的加密资产处置声明。由于这个风险不是技术性的，而是行政性的，除了最初不暴露自己于KYC之外，没有特定于比特币的解决方案来消除它。减轻这种风险的唯一合法方法是在受监管的平台上出售通过受监管平台获得的比特币，然后通过无KYC的方式重新购买它们。通过出售并声明处置，行政机关应该注意到你不再拥有它们。

至于你的个人数据和身份证件泄露的风险，这是比特币外部的危险，没有技术解决方案可以避免。一旦你的数据被泄露，很难逆转这一操作。你可以尝试关闭平台上的账户，但这并不能保证你的KYC数据被删除，特别是当身份验证是外包的时候。验证你的信息是否完全删除是不可能的。因此，没有解决方案可以完全预防这种风险并确保它不再存在。

### KYC与关键识别之间的区别

有时，一些比特币用户倾向于将“KYC”这个术语扩展到任何涉及转账或信用卡支付的BTC交易，因为这些手段也可以揭示支付的来源，就像KYC一样。然而，重要的是不要将KYC与关键识别混淆。就个人而言，我必须承认我对这个主题的看法随着时间的推移而发展。

KYC特指一些公司实施的一种监管程序，用于验证和记录其客户的身份。这是一个二元的事情：在获取你的比特币时，要么你经历KYC，要么你不经历。然而，关键识别，涉及将用户身份的某个方面与链上活动联系起来，并不是二元的，而是代表一个连续体。实际上，在获取或处置比特币的背景下，这种识别总是可能在不同程度上发生。
例如，如果你在瑞士的受监管平台购买比特币，不需要KYC（了解你的客户）。然而，可能会有你的密钥识别，因为购买是通过你的银行账户进行的。这就是与KYC相关的前两个风险 —— 促进链上追踪和暴露于国家监视 —— 也可能在非KYC交易中显现的地方。如果瑞士实体向你所在国家的当局报告可疑交易，他们可以简单地检查用于购买的银行账户来发现你的身份。因此，在受监管的平台上无KYC购买的风险在关键识别风险等级上相当高。

![BTC204](assets/notext/43/4.webp)

然而，避免使用受监管的平台并选择P2P（点对点）获取方法并不能完全消除关键识别的风险，而只是减少了它。考虑在Bisq或另一个P2P平台上的购买示例。为了与你的交易对手结算，你可能会使用你的银行账户。如果当局询问你交易的那个人并要求提供你的姓名，我们就遇到了前面提到的风险1和2。这些风险当然比在平台上的非KYC购买期间要低得多，甚至比KYC购买期间还要低，但在较小程度上仍然存在。

![BTC204](assets/notext/43/5.webp)
最后，即使您通过现金的实体交易获得比特币，您也不是完全匿名的。与您交易的人已经看到了您的面孔，这是您身份的一部分。尽管在这个例子中影响很小，但仍然存在关键识别的可能性。
![BTC204](assets/notext/43/6.webp)

总之，在比特币与其他资产的交换过程中，无论是用法定货币购买还是出售实物商品，总会有某种形式的关键识别。根据所选择的交换方式，这种识别的强度可能会有所不同。重要的是不要将此识别与KYC混淆，后者是一个定义明确的监管过程。然而，KYC与识别范围之间存在联系，因为KYC位于此范围的上端，它系统地便于当局识别用户的密钥。

## 销售和获取的方法
<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>
阅读了前一章后，您可能会想知道如何在不必经历身份验证过程的情况下购买或出售比特币，以避免与KYC相关的风险。有几种方法可以进行交换。

### 现金P2P交换

正如我们所见，就隐私而言，最佳方法仍然是通过现金结算进行的P2P（点对点）交换。这种方法可以最大限度地减少留下的痕迹，并显著降低关键识别的可能性，无论您是买家还是卖家。

![BTC204](assets/notext/44/01.webp)

然而，这种做法对个人安全带来风险。主要危险在于，在交换过程中，对方会知道您持有大量现金或比特币。这一信息可能会吸引恶意个体的注意。实际上，通常建议对您的比特币持有保持谨慎。这一建议也可以应用于现金。然而，在面对面交换时，不可避免地会暴露您拥有比特币的事实，这可能引起他人的觊觎。

![BTC204](assets/notext/44/02.webp)

为了限制这种风险，我建议您优先与可信赖的个人进行现金交易，如家庭成员或密友。或者，您也可以考虑在[当地比特币聚会](https://btcmap.org/communities/map)上进行交换，在多次参加后再进行。这将使您能够更好地了解其他参与者，并且在进行实体交换时不会孤身一人。然而，重要的是要认识到，现金P2P交换本质上带来的个人安全风险是在通过受监管平台和您的银行账户进行购买时不存在的。

此外，根据您居住的地方，携带和储存大量现金可能会带来风险，无论是比特币还是现金。

现金交换在警察检查或其他情况下也可能带来法律风险。尽管在大多数国家，携带的现金金额没有限制，但过大的金额可能会引起怀疑。因此，要小心，特别是如果您需要长途旅行，并避免一次进行过大的交易，以免不得不解释拥有大量现金的原因。
最后，P2P购买的另一个缺点是价格通常高于在受监管平台上观察到的价格。卖家通常会加价1%到有时超过10%。几个原因可以解释这种价格差异。首先，这是P2P卖家之间随着时间建立起来的一种常见做法。接下来，卖家有与向买家发送资金相关的交易费用。与平台上的交易相比，P2P销售的盗窃风险也增加了，这就证明了对所承担风险的补偿。最后，附加费可能与需求和交换的质量有关，特别是在隐私方面。作为买家，隐私的增益是有代价的，这反映在卖家应用的加价中。一些比特币用户还相信，P2P购买中BTC价格的上涨反映了其真实价值，并认为受监管平台上的较低价格是对个人数据隐私妥协的结果。

### 通过匹配平台进行P2P交换

就个人安全而言，一个较少风险的替代方案是通过电子支付方法（如PayPal、银行转账或Revolut）仅在线上进行P2P交换。

这种方法有助于避免与现金交易相关的许多风险。然而，在线交换期间对方不履行承诺的风险更大。实际上，在物理交换中，如果你将钱交给卖家，而卖家没有反过来发送比特币给你，你可以立即追究他们的责任，因为他们就在你面前。另一方面，在线上，通常不可能找到从你这里偷窃的人。

为了降低这种风险，可以使用专门用于P2P交换匹配的平台。这些平台使用冲突解决机制来保护受损用户。通常，他们提供一个托管系统，在卖家确认收到法定货币支付之前，比特币将被保留。

就个人安全而言，这种购买方法比实体现金交换要安全得多。然而，如前所述，在线P2P交换比物理交换留下更多痕迹，这可能对比特币上的隐私不利。通过使用在线法定支付方法，如银行，你暴露了更多可能促进密钥识别的信息。

再次，我建议不要在这些平台上一次性进行大额交换。通过分割你的交易，你分散了与对方潜在盗窃相关的风险。
再次提到，P2P购买的另一个缺点是价格通常高于在受监管平台上看到的价格。卖家通常会加价，范围从1%到有时超过10%。这种价格差异有几个原因。首先，这是P2P卖家之间随时间建立起来的常见做法。接下来，卖家有与向买家发送资金相关的交易费用。与平台上的交易相比，P2P销售的盗窃风险也增加了，这就证明了对所承担风险的补偿。最后，附加费可能与需求和交换的质量有关，特别是在隐私方面。作为买家，隐私的增加是有代价的，这反映在卖家应用的加价中。一些比特币用户还相信，通过P2P购买的BTC价格上涨反映了其真实价值，并认为受监管平台上的较低价格是对个人数据隐私妥协的结果。

关于解决方案，我个人一直使用[Bisq](https://bisq.network/)，对此非常满意。他们的系统建立得很好，看起来很可靠。然而，Bisq只能在PC上使用，其界面对初学者来说可能过于复杂。另一个缺点是Bisq仅与链上交易一起操作，这在比特币交易费用高昂的时期可能变得昂贵。

[-> 查看我们关于Bisq的教程。](https://planb.network/en/tutorials/exchange/bisq)

对于更简单的选项，您可以尝试[Peach](https://peachbitcoin.com/)，这是一个移动应用程序，通过集成的争议解决系统促进买家和卖家之间的联系。其过程比Bisq的更直观。

[-> 查看我们关于Peach的教程。](https://planb.network/en/tutorials/exchange/peach-wallet)
另一个在线选项是[HodlHodl](https://hodlhodl.com/)，这是一个建立良好的平台，提供良好的流动性，尽管我个人没有测试过它。
[-> 查看我们关于HodlHodl的教程。](https://planb.network/en/tutorials/exchange/hodlhodl)

对于基于闪电网络的解决方案，您可以尝试[RoboSats](https://learn.robosats.com/)和[LNP2PBot](https://lnp2pbot.com/)。RoboSats可以通过网站访问，使用起来相对简单。LNP2PBot更为特别，因为它通过Telegram消息应用程序上的交换系统操作。

[-> 查看我们关于RoboSats的教程。](https://planb.network/en/tutorials/exchange/robosats)
[-> 查看我们关于LNP2PBot的教程。](https://planb.network/en/tutorials/exchange/lnp2pbot)

### 不需要KYC的受监管平台

根据您居住的国家，您可能可以访问不需要进行KYC程序就能买卖比特币的受监管平台。例如，在瑞士，您可以使用像[Relai](https://relai.app/)和[MtPelerin](https://www.mtpelerin.com/)这样的平台。

[-> 查看我们关于Relai的教程。](https://planb.network/en/tutorials/exchange/relai)
正如我们在上一章中看到的，这类平台免除了与KYC程序相关的风险，但它们在关键识别方面呈现出更高的风险水平。就比特币的隐私而言，这些平台因此提供比带KYC的购买方法更好的保护，但它们不如P2P交易所有趣。
然而，在个人安全方面，使用这些平台的风险显著低于P2P交易所。它们通常也比促进P2P交易的平台更简单易用。

### ATM机

另一个不需KYC就能买卖比特币的选项是加密货币ATM机（ATM）。个人而言，我从未有机会测试这个解决方案，因为我的国家里没有。但这种方法根据你居住的地方可能非常有趣。

![BTC204](assets/notext/44/09.webp)
ATM机的问题在于，它们在一些国家被禁止或在其他国家受到严格监管。如果一个ATM机需要身份验证过程，那么它就面临与受监管KYC平台相同的风险。然而，如果ATM机允许小额无身份验证交易，那么其使用可以提供与基于现金的P2P交易所相当的隐私水平，同时避免了与这类交易所相关的大部分风险。
ATM机的主要缺点在于它们通常有很高的兑换费用，这些费用从几个百分点到有时交换金额的15%不等。

### 礼品卡

最后，我还想介绍一个对那些希望日常使用比特币进行购买而不是将它们卖出换取法币的人来说很好的解决方案。

花费BTC的最佳方式显然是直接使用比特币或通过闪电网络购买商品或服务。然而，在许多国家，接受比特币的商家数量仍然有限。一个实用的替代方案是使用礼品卡。

一些不要求KYC程序的平台提供了将比特币换成可在主要商店使用的礼品卡的可能性。在这些平台中，我们找到了[CoinsBee](https://www.coinsbee.com/)、[The Bitcoin Company](https://thebitcoincompany.com/)和[Bitrefill](https://www.bitrefill.com/)。这些平台极大地方便了你日常使用比特币，允许你在不需要转换成法币的情况下访问广泛的产品和服务。

![BTC204](assets/notext/44/10.webp)

### 其他获取方式

在保护隐私的同时获取比特币的其他方法显然包括挖矿。开始挖掘sats不需要透露你的身份；你只需要找到一个有效的工作证明并提交给网络。如果你选择池挖矿，一些矿池需要一种身份验证形式，如KYC，而其他矿池则不需要。

另一种方法是通过工作换取比特币。这种获取方法可能很有趣，但所需的身份识别程度根据情况而大不相同。

*写这一章时，我使用了由[@pivi___](https://x.com/pivi___)在PlanB Network上创建的课程[BTC205](https://planb.network/fr/courses/btc205)（目前仅提供法语版本）。*

## 合并、UTXO管理和CIOH
<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>
在您拥有自己的自管钱包时，管理最复杂的方面之一无疑是整合（Consolidation）。您应该进行整合吗？目的是什么？您应该追求什么大小的UTXO？在隐私方面有哪些权衡？这就是我们将在本节中尝试探索的内容。

### 什么是整合？

比特币的运作类似于一个拍卖市场，矿工倾向于选择提供最佳费用的交易。然而，每个区块都有一个最大重量，限制了可以包含的交易数量。由于平均每10分钟产生一个区块，每个区块中的可用空间是一种稀缺资源。

矿工的活动在电力、资本和维护方面产生了显著的成本，他们自然寻求最大化其盈利能力。他们倾向于支持那些相对于其重量提供最多费用的交易。

实际上，并非所有比特币交易的重量都相同。那些有更多输入和输出的交易将会更重。例如，考虑2笔交易：
- 交易A包括1个输入和1个输出。它分配了1,994 sats的费用，其重量为141 vB；
- 交易B，更复杂，有2个输入和2个输出，为重量220 vB的交易分配了2,640 sats的费用。

![BTC204](assets/notext/45/01.webp)

在这个例子中，尽管交易B提出了更高的总费用，矿工会偏好交易A，因为它提供了更好的费用与重量比。这是每笔交易的计算，以每虚拟字节的sats（sat/vB）表示：

```text
TXA: 1994 / 141 = 14 sats/vB

TXB: 2640 / 220 = 12 sats / vB
```

这意味着对于每个重量单位，交易A提供的费用比交易B更多，尽管后者在绝对值上提供了更多的费用。

![BTC204](assets/notext/45/02.webp)

因此，对于用户来说，总是更有趣的是在他们的交易中尽可能少地消耗输入。然而，需要消耗足够的金额以能够满足输出中的支付。在管理他们的钱包时，人们因此必须拥有足够大的UTXOs。

整合的原则正是在比特币上的费用较低时期利用这一点，将一个人的小UTXOs合并成一个更大的UTXO。因此，当比特币上的费用增加时，一个人可以用最少的输入进行交易，因此在绝对费用上花费更少。目标是计划在高费用时期进行必须进行的交易。

![BTC204](assets/en/45/03.webp)
除了在交易费用上的节省外，整合UTXOs有助于避免产生“尘埃”。尘埃指的是UTXOs的sats值如此之低，以至于不足以覆盖花费它们所需的交易费用。只要交易费用保持高昂，使用这些UTXOs在经济上是不合理的。通过主动整合您的UTXOs，您可以防止它们变成尘埃，确保您的所有资金保持可用。

### 您的UTXOs的最小大小是多少？

有时，我被问及UTXO的推荐最小值是多少。不幸的是，没有通用答案，因为它取决于您的偏好和费用市场条件。然而，这里有一个公式可以帮助您确定适合您需求的阈值：

$$
\frac {P \times F}T = M
$$

其中：
- $P$ 是交易的重量；
- $F$ 代表您愿意承担的每虚拟字节（sats/vB）的最大费率；
- $T$ 是您愿意支付的交易费用相对于UTXO总值的百分比；
- $M$ 是每个UTXO的最小金额，以satoshi计。

假设您计划为标准的SegWit交易支付费用，该交易有1个输入和2个输出，重量为141 vB。如果您最多愿意支付800 sats/vB的费用，并且最多愿意支付UTXO价值的12%作为费用，那么计算将是：

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

在这个例子中，保持钱包中UTXO的最小值为940,000 sats是明智的。

### 合并和COIH

链分析中最常用的启发式之一是COIH（*Common Input Ownership Heuristic*，共同输入所有权启发式），它允许假设比特币交易的所有输入属于同一实体。确切地说，合并的原则是使用多个UTXO作为输入，并创建一个单一的UTXO作为输出。因此，合并允许应用COIH。

![BTC204](assets/notext/45/04.webp)

实际上，这意味着外部观察者可以推断，所有被合并的UTXO很可能属于同一个人，并且生成的单一输出也属于他们。这种情况可能会通过链接不同的交易历史来妨碍您的隐私。例如，假设我将在P2P中获得的3个UTXO与通过需要KYC的平台获得的一个UTXO合并：
![BTC204](assets/notext/45/05.webp)

这样做，任何能够访问交易平台数据的实体，包括可能的政府机构，都可以识别出我拥有其他数量的BTC。以前，这些UTXO并未直接与我的身份链接；现在，它们却是。此外，这向所有来源揭示了我拥有一定数量的比特币。

在管理UTXO时，推动合并以减少费用的经济考虑与推荐永远不合并您的UTXO的良好隐私实践之间存在冲突。因此，经济与隐私之间的选择取决于每个用户的优先级。

如果您能够避免合并同时保持较大的UTXO大小，那是理想的。为此，请优化您的获取方法。如果您通过DCA购买比特币，尽可能地将一次性购买间隔开，以将价值集中到更少的UTXO中。每2个月进行一次1000欧元的一次性购买，比每周购买120欧元更容易管理。这样可以减少生成的UTXO数量，并简化您的钱包管理，同时保护您的隐私。

如果您发现自己需要合并比特币，首先优先考虑合并来自同一来源的UTXO。例如，合并来自单一平台的10个UTXO对您的隐私影响会小于将来自平台A的5个UTXO与来自平台B的5个UTXO混合。如果不可避免地需要从各种来源合并，尝试根据它们的特性将它们分开。例如，将通过KYC获得的UTXO在一个交易中分组，而将通过P2P获得的UTXO在另一个交易中分组。
无论如何，请记住，任何整合行为不可避免地会导致隐私的损失。因此，在考虑风险的情况下，仔细评估这一操作的必要性及其对您隐私的潜在影响。

## 其他好的实践
<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>

让我们一起探索一些其他好的实践，这些实践可以帮助您在比特币上优化您的隐私。

### 完整节点
拥有自己的比特币自我保管是好的，但使用自己的完整节点更好！以下是拥有自己的节点对于完全主权使用比特币至关重要的原因：
- **抗审查性**：您的交易不会被任何人阻止；
- **独立于第三方**：您不再依赖任何外部服务来验证区块链数据；
- **主动参与**：您有能力设置自己的验证规则并直接参与共识；
- **对网络的贡献**：通过运行节点，您帮助加强并分发比特币网络；
- **技术教育**：管理完整节点是深入了解比特币技术知识的绝佳方式。

除了这些好处，使用完整节点在广播您的交易时也能提高您的隐私。当您发起一笔交易时，首先通过您的钱包创建并签名。要在比特币网络上广播它，至少需要一个节点知道。通过使用您自己的节点，您直接控制这种广播，从而增强您的隐私并限制数据泄露的风险。

![BTC204](assets/notext/46/01.webp)

如果您没有自己的比特币节点，您将被迫使用第三方的节点，例如您的钱包软件提供商提供的节点。除了交易广播外，您的钱包需要访问各种信息，如待处理交易、与您的地址相关联的余额，或您的交易的确认次数。要访问所有这些数据，您需要查询一个节点。

![BTC204](assets/notext/46/02.webp)

当您不使用自己的比特币节点时，主要风险是第三方节点的运营者可能观察您在区块链上的活动，甚至与其他实体分享这些信息。为了限制这种风险，一个中间解决方案是使用允许您通过Tor掩盖连接的钱包软件。这可以减少您的数据暴露。然而，最佳解决方案仍然是拥有自己的比特币节点，并使用它来广播您的交易。显然，您还需要确保您的节点没有信息泄露，但这是我们将在后续部分探讨的另一个话题。
除了对您的隐私明显的优势外，拥有自己的完整节点还确保了区块链上数据的真实性，保护免受审查，并允许您积极参与比特币的治理。通过使用自己的节点，您将自己的经济权重贡献给您选择的链，这在社区内的冲突中非常重要，例如在2015到2017年的区块大小战争期间。在发生分叉的情况下，使用第三方的节点可能会导致您支持一个您不希望支持的链，因为节点运营者为您做出了选择。
正如您所理解的，在关注隐私和更广泛的个人主权方面，运行和使用自己的完整节点是至关重要的！

### 欺骗分析启发式方法
更广泛地说，理解我们在前一部分讨论的启发式方法很重要，以便更好地避免或欺骗它们。采用一系列良好的实践可以证明是有益的，即使它们不是必不可少的。它们提供了一个额外的保护层，对于在使用比特币时保持良好的隐私至关重要。

我能给出的第一条建议是融入最密集的人群中。在比特币上，这意味着使用最广泛采用的脚本模式。例如，经常用于SegWit V0多签配置的P2WSH脚本非常罕见。它们不允许你隐藏在一个大的匿名集合中。对于旧模型如P2PKH或P2SH也是如此。尽管它们在UTXO集合中广泛存在，但用于新交易的情况越来越少。

一般来说，转向最新的脚本标准更安全，前提是它足够广泛地被采用。因此，如果在2022年，我会建议不使用P2TR（Taproot）因为它的采用率低，到了2024年，我会推荐选择这种类型的脚本，或者如果不行，选择SegWit V0脚本，因为使用P2TR的交易数量开始占据非常显著的比例。

![BTC204](assets/notext/46/03.webp)

来源：[txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)
保护隐私的另一个提示是尝试规避交易的内部启发式方法。例如，在进行支付时，你可能会尝试避免创建一个圆整数额的输出，因为这可能表明另一个输出代表找零。如果你需要向朋友发送100k sats，考虑转移稍高一些的金额以逃避这种启发式方法。同样，尽量不要创建与支付金额相比不成比例高的找零输出，因为这也可能揭示哪个输出代表找零。
![BTC204](assets/notext/46/04.webp)

最后，如果你定期进行比特币交易，确保不要总是在同一时间广播它们。通过在一天和一周内分散你的交易广播时间，你避免了让外部观察者能够依据时区检测出时间模式，这可能增强他们的分析。

除了每天要采取的所有这些良好实践之外，还有更有效的方法可以完全打破你的比特币的可追踪性。其中，显然包括我们将在下一部分深入研究的coinjoin交易。

# 理解Coinjoin交易
<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## 什么是Coinjoin交易？
<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>

在研究了隐私保护的基础知识之后，我们现在将讨论更复杂的技术，这些技术旨在积极保护你的隐私，特别是通过分离你的比特币的历史记录。在接下来的部分，我们将探索许多小技巧，但首先，我想和你谈谈coinjoin。

Coinjoin通常被认为是保护比特币用户隐私的最有效方法。但coinjoin交易到底是什么呢？让我们一起找出答案。

### Coinjoin的基本原理

Coinjoin是一种打破比特币在区块链上可追踪性的技术。它依赖于一种具有特定名称的协作交易：coinjoin交易。
正如我们在本次培训的前几部分所见，比特币上的交易对所有用户都是公开的，通过他们的节点可以知晓。因此，很容易验证每个硬币的电子签名链并观察其历史。这意味着所有用户都可以尝试分析其他用户的交易。结果，交易层面的匿名是不可能的。然而，在个人识别层面上，匿名性得到了保留。与每个账户都与个人身份链接的传统银行系统不同，在比特币上，资金与加密密钥对（或脚本）相关联，从而为用户提供了一种在加密标识符后的伪匿名形式。

因此，当外部观察者设法将特定的UTXO与已识别的用户关联起来时，比特币上的保密性就会受到损害。一旦建立了这种关联，就有可能追踪他们的交易并分析他们比特币的历史。Coinjoin正是为了打破UTXO的可追踪性而开发的技术，以便在交易层面为比特币用户提供一定程度的保密性。

Coinjoin通过使链分析对外部观察者复杂化来增强比特币用户的保密性。它们的结构允许将来自不同用户的多个硬币合并到一个交易中，从而模糊了轨迹，使得难以确定输入和输出地址之间的链接。

重要的是要理解，coinjoin交易的目标是打破一个硬币的历史。这种技术并不赋予永久匿名，也不会彻底阻止比特币的追踪，与人们可能认为的相反。Coinjoin的目标仅仅是在执行coinjoin交易的点打破历史。然而，在这个操作之前和之后，硬币仍然面临同样的隐私风险。

### Coinjoin是如何工作的？

Coinjoin的原理依赖于一种协作方法：几个希望混合他们的比特币的用户在同一个交易的输入中存入相同金额。然后，这些金额在输出中以等值重新分配给每个用户。

在交易结束时，不可能将特定的输出与输入中的已知用户关联起来。输入和输出之间不存在直接链接，这打破了用户及其UTXO之间的关联，以及每个硬币的历史。

让我们以Alice为例。她想在妹妹Eve的生日时发送大约100,000 sats。然而，Alice不希望Eve能够追踪她的交易历史，因为她不想透露她持有多少比特币或她是如何获得它们的。为此，Alice决定通过一个coinjoin交易打破她的UTXO历史。她与Bob、Charles、David和Frank组织进行一次协作交易：
- Alice、Bob、Charles、David和Frank每人提交一个105,000 sats的UTXO（包括5,000 sats的挖矿费）作为交易的输入：

- 为了消耗这些输入，每个人生成一个新地址来创建五个相同的输出，每个输出100,000 sats。每人取回一个输出：

- Alice最终得到一个历史被混合的100,000 sats的UTXO。她使用这个UTXO在一个新的交易中将金额发送给Eve作为她的生日礼物：
- 如果夏娃试图分析这笔交易以提取信息，她将面对涉及爱丽丝、鲍勃、查尔斯、大卫和弗兰克的coinjoin交易。由于金额的统一性，夏娃无法区分哪个输入属于谁，因此无法追踪爱丽丝的UTXO历史，也无法确定她的姐姐拥有多少比特币或她是如何获得它们的：

在这个场景中，爱丽丝使用了coinjoin技术来增加她对回溯分析的隐私保护。实际上，爱丽丝保护自己免受夏娃可能从特定交易开始向后追踪UTXO历史的分析。这种从现在到过去的分析保护，我们称之为回溯匿名集。我们将在本部分的最后几章中更详细地探讨这个概念。

然而，coinjoin还提供了增强从过去到现在分析的隐私保护的可能性，这被称为前瞻匿名集。让我们回到我们的例子，爱丽丝给夏娃发送了98,000 sats作为她的生日礼物，但角色互换。现在想象是夏娃关心她的隐私。实际上，爱丽丝可能会被诱惑跟踪她发送给夏娃的硬币以收集信息。夏娃可以将她刚收到的这个UTXO与她所有其他的UTXO合并，这可能会向爱丽丝透露她钱包中持有的比特币数量。为了避免这种情况，夏娃也可以打破她刚收到的硬币的历史。
- 夏娃、格蕾丝、玛洛里、奥斯卡和维克多每人投入一个98,000 sats的UTXO作为比特币交易的输入：

- 作为消耗这些输入的交换，每个人提供一个新地址来创建5个各为97,500 sats的输出，完全相等。每个用户检索一个输出：

- 夏娃现在持有一个带有断裂历史的97,500 sats的UTXO。她可以在未来的交易中无忧使用。实际上，如果爱丽丝试图跟踪她发送给夏娃的比特币，她将遇到一个coinjoin交易。她将无法确定哪个输出UTXO属于夏娃。然后分析变得不可能：

在第一个例子中，我们看到了coinjoin如何保护一个硬币与其过去的隐私，而在第二个例子中，我们看到了它如何也保护一个硬币与其未来的历史。这就是为什么我提到coinjoin应该被视为一个一次性事件，它在两个方向上切割了一个硬币的历史：

### 混合、coinjoins、混合器...有什么区别？

“混合”一词有时用来描述coinjoins，一些比特币用户因为担心与托管混合器混淆而拒绝使用这个术语。然而，我认为这种担忧是没有根据的，因为在数学上下文中，coinjoin准确地体现了混合的概念。
在数学的一般领域中，混合指的是动态系统的一种属性，即经过一段时间后，初始空间的所有部分理论上都可以与任何其他部分混合。混合意味着粒子的位置或系统的状态以这样一种方式演变：其未来的分布与其初始分布无关，从而达到一种状态，即初始状态的特征在系统空间中均匀分布。这正是在比特币的coinjoin中发生的情况。因此，在我看来，coinjoin确实是一种混合币的方法。
![BTC204](assets/notext/51/12.webp)

然而，区分coinjoin和混币器是重要的。混币器是一种服务，用户将他们的比特币发送到这里进行混合。这些服务在2010年代很受欢迎，但由于与coinjoin相比有两个主要缺点，它们的使用已经减少：
- 它们要求用户在混合过程中放弃对资金的控制，这使他们面临被盗的风险；
- 无法保证混币器不记录交易详情，甚至将这些信息出售给链分析公司。
![BTC204](assets/notext/51/13.webp)

如今，用户因此更喜欢coinjoin，因为它允许他们在整个过程中完全控制自己的资金。参与coinjoin的人不会冒着被其他参与方偷走比特币的风险。让我们一起探索在下一章中如何实现这一切。

## Zerolink和Chaumian Coinjoins
<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>

coinjoin提供的隐私是基于我们的部分隐藏在其中的群体的大小。因此，需要找到尽可能多的参与者。完全可以手动执行coinjoin，与自己找到的用户一起，但这种方法复杂，并且不允许实现大的匿名集。

这就是为什么在比特币上发展出了coinjoin协调员。他们的角色是连接不同的用户并传递完成协作交易所需的信息。

![BTC204](assets/notext/52/01.webp)

但我们如何确保协调员永远不会控制用户的比特币，并且尽管他们是构建coinjoin交易的人，我们如何确保他们不能链接用户的输入和输出，这可能构成隐私泄露？

### Chaum的盲签名

coinjoin的现代实现使用David Chaum的盲签名来避免信息泄露。让我们一起快速学习这些盲签名是如何工作的。

Chaum的盲签名是一种数字签名形式，签名发行者不知道他们正在签名的消息内容。然而，稍后可以使用原始消息验证签名。这项技术由密码学家David Chaum在1983年开发。

![BTC204](assets/notext/52/02.webp)

以一家公司想要认证一个机密文件，如合同，而不透露其内容为例。公司应用一个掩码过程，以可逆的方式对原始文件进行密码学转换。这个修改过的文件被发送到一个认证机构，该机构应用一个盲签名而不知道底层内容。在收到签名的文件后，公司取消掩码签名。结果是一个由机构签名认证的原始文件，而该机构从未看到原始内容。
Chaum的盲签名因此允许在不知道文档内容的情况下验证文档的真实性，这既保证了用户数据的保密性，也保证了签名文档的完整性。

### Chaumian Coinjoins
在“Chaumian CoinJoins”中，结合使用Tor和David Chaum的盲签名以确保协调者无法知道哪个输出属于哪个用户。构建coinjoin交易的过程围绕3个主要步骤展开：注册输入、注册输出和签署交易。让我们通过Alice的例子来检查这个过程，Alice是coinjoin中的一名参与者。所有其他参与者都遵循与Alice相同的步骤，每个人都独立进行。

**步骤1：注册输入。**
- Alice向协调者发送她希望用作交易输入的UTXO，以及她希望用作接收比特币的输出的掩码接收地址。因此，协调者无法知道Alice的地址。他只看到其掩码版本：

![BTC204](assets/notext/52/03.webp)

- 协调者验证输入的有效性，然后用他的私钥对Alice的掩码地址进行签名。他将盲签名发回给Alice：

![BTC204](assets/notext/52/04.webp)

**步骤2：注册输出。**
- Alice现在可以揭开由协调者的私钥签名的地址。她在不同的Tor身份下建立新的连接。协调者无法识别这是Alice在这个新身份下连接：

![BTC204](assets/notext/52/05.webp)

- Alice将揭开的地址和签名发送给协调者（他仍然不知道是Alice）：

![BTC204](assets/notext/52/06.webp)

**步骤3：签署交易。**
- 协调者类似地从所有参与者那里检索揭开的输出。感谢相关签名，他可以验证每个匿名提交的输出确实是之前由他的私钥签名的，确保它们的合法性。然后他准备构建coinjoin交易并将其发送给参与者以供他们签名：

![BTC204](assets/notext/52/07.webp)

- Alice和其他参与者一样，验证她的输入和输出是否正确地包含在协调者构建的交易中。如果一切都令人满意，她将解锁她输入的脚本的签名发送给协调者：

![BTC204](assets/notext/52/08.webp)

- 在收集了coinjoin的所有参与者的签名后，协调者可以在比特币网络上广播交易，以便将其添加到一个区块中。
在这个系统中，协调者无法将输入链接到特定的输出。此外，他们也无法占有参与者的资金，因为他们从未拥有解锁他们的UTXOs所需的私钥。在整个过程中，直到第3步结束，他们也没有访问签名的权限。当Alice和其他参与者在确保一切正确后签署全局交易时，协调者无法再修改这笔交易，包括输出，而不使其失效。因此，这防止了协调者盗取比特币。
最终，在记录交易中的输出时，coinjoin用户希望获得类似于公民在选举中投票的保证。这些行动的公共和私人方面之间存在一种二元性。一方面，有人希望保持私密的东西：对于选民来说，他们不希望自己的选票与自己的身份关联；对于coinjoin用户来说，他们不希望自己的输出与自己的输入关联。事实上，如果协调者或任何其他方设法建立输入和输出之间的链接，coinjoin就失去了所有的目的。如前所述，coinjoin必须作为一个硬币历史的中断来运作。这种停止正是因为在coinjoin交易中（前瞻性匿名集）将特定输入与特定输出关联起来的不可能性，反之亦然（回顾性匿名集）。

另一方面，有公共方面：选民希望确保他们的选票被包含在投票箱中；同样，coinjoin用户希望确保他们的输出被包含在coinjoin交易中。事实上，coinjoin的参与者能够在签署交易之前验证他们的输出的存在是绝对必要的，否则协调者可能会窃取资金。

正是这2个公共和私人方面，通过使用David Chaum的盲签名技术成为可能，保证了Chaumian coinjoins的参与者他们的比特币不会被盗，他们的资金无法被追踪。

### 谁发明了coinjoin的概念？

很难确定谁最先在比特币上引入了coinjoin的概念，以及谁想到在这个背景下使用David Chaum的盲签名。人们通常认为是Gregory Maxwell在2013年[在BitcoinTalk上的一条消息](https://bitcointalk.org/index.php?topic=279249.0)中首次谈到了它：
使用Chaum盲签名：用户登录并提供输入（和找零地址）以及他们希望发送私人硬币的地址的加密盲版本；服务器对令牌进行签名并将它们返回给用户。用户匿名重新连接，揭示他们的输出地址，并将它们发送回服务器。服务器可以看到所有输出都已由它签名，因此，所有输出都来自有效参与者。后来，人们重新连接并签名。
Maxwell, G. (2013, August 22). *CoinJoin: Bitcoin privacy for the real world*. BitcoinTalk Forum. https://bitcointalk.org/index.php?topic=279249.0

![BTC204](assets/notext/52/09.webp)

然而，早在2011年6月，Duncan Townsend就在BitcoinTalk上[提出了一个使用Chaum签名的混合器](https://bitcointalk.org/index.php?topic=12751.0)，其方式与现代Chaumian coinjoins非常相似。
在同一讨论线程中，有[hashcoin回复Duncan Townsend的消息](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793)，提出改进他的混币器的建议。这条消息中描述的过程正是最接近coinjoins的实现方式。还有一条消息提到了一个类似的系统，是[Alex Mizrahi在2012年](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry)向Tenebrix的创造者提供建议时提到的，Tenebrix是最早的替代币之一，后来成为了Litecoin的基础。甚至"coinjoin"这个术语本身也不是Greg Maxwell发明的，而是来自Peter Todd的一个想法。
![BTC204](assets/notext/52/10.webp)

### Zerolink

Zerolink是一个综合性的混币协议，它整合了Chaumian coinjoins和多种策略来保护用户的匿名性，特别是最小化与钱包管理相关的错误。这个协议[由nopara73和TDevD在2017年引入](https://github.com/nopara73/ZeroLink/blob/master/README.md)。

![BTC204](assets/notext/52/11.webp)

正如其名称所示，Zerolink的原则是执行coinjoin交易，确保无法追踪输入和输出之间的链接。这一特性是通过确保所有输出呈现完全相同的金额来实现的。

![BTC204](assets/notext/52/12.webp)
Zerolink的一个重要预防措施是通过使用不同的加密密钥集合，甚至是分开的钱包，来完全分离未混合的UTXOs和已混合的UTXOs。这样，用于混币前的“预混”钱包，与用于已混合币的“混后”钱包就被区分开来。
![BTC204](assets/notext/52/13.webp)

这种UTXOs的严格分离主要是为了防止混合UTXO和未混合UTXO之间的意外关联。实际上，如果发生这样的链接，混合UTXO上的coinjoin的效果就会被抵消，而用户并不知情，从而危及到用户认为其历史已被切断的UTXO的保密性。这些链接可能是通过在保护混合UTXO时重用地址与未混合的一个进行关联，或者通过应用Common-Input-Ownership Heuristic (CIOH)，如果用户在同一笔交易中使用混合和未混合的UTXOs作为输入。通过分离预混币和混后币钱包，可以避免这些意外的关联，并保护用户免受非自愿错误的影响。

![BTC204](assets/notext/52/14.webp)

这种分离还提供了在预混币和混后币钱包之间应用不同规则的可能性，这在钱包软件层面上实现。例如，在混后币钱包中，软件可以禁止将UTXOs合并成输入，以防止应用CIOH，这将危及用户的匿名集。也可以标准化脚本和交易选项的使用（例如，标记RBF），以防止通过钱包指纹识别。

目前，Whirlpool是唯一严格应用Zerolink协议的coinjoin实现。在接下来的章节中，我们将探讨不同的coinjoin实现及其各自的优缺点。
<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>
*到2024年，我们见证了希望在比特币上执行coinjoin操作的用户可用工具的重大变化。我们目前正处于一个关键时期，coinjoin市场正在经历重大重组。因此，本章可能会随着时间的推移而更新。*

目前，比特币上主要有3种不同的coinjoin实现方式：
- Whirlpool；
- Wabisabi；
- JoinMarket。
这些实现的目标都是通过coinjoin交易打破UTXOs的历史记录。然而，它们的机制有很大的不同。因此，理解每种工作方式对于选择最适合您需求的选项至关重要。

### JoinMarket

JoinMarket由Adam Gibson和Chris Belcher在2015年创建，得益于其独特的用户匹配模型，从其他coinjoin实现中脱颖而出。这个系统基于一个P2P交换市场，其中一些用户，即“makers”，将他们的比特币用于混合，而其他用户，即“takers”，则使用这些资金执行coinjoins并支付费用。

![BTC204](assets/notext/53/01.webp)

在这个模型中，“makers”将他们的比特币提供给“takers”使用，并为他们的服务收取费用。“takers”则支付费用，使用“makers”的比特币进行自己的coinjoin交易。服务费用根据角色而异：“makers”为他们提供的流动性积累费用，而“takers”支付费用。这个市场自由运营，没有使用条件。

JoinMarket的一个主要缺点是其使用的复杂性，这需要对终端有一定的熟悉度才能有效利用。尽管这种复杂性对于经验丰富的用户来说不是障碍，但它可能限制了普通公众的访问。然而，最近引入的名为JAM的网络界面在一定程度上简化了其使用。

![BTC204](assets/notext/53/02.webp)

来源：[JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

然而，技术障碍仍然是一个主要障碍。在coinjoin生态系统中，保密性通过参与者数量增强，任何减少可访问性的限制直接影响可用流动性，这是混合效率的关键因素。比特币，作为金融交易中的一个小众市场，其coinjoin的使用被视为一个子小众市场，而JoinMarket代表了一个更加专业化的部分，从而限制了其增加用户匿名集的潜力。

尽管JoinMarket的P2P匹配模型对于coinjoins来说是创新的，但它在交易结构方面存在一些显著的缺点，特别是与Whirlpool等其他实现相比，JoinMarket无法保证输出之间的完美等价，有可能追踪输入和输出之间的确定性链接。此外，它缺乏防止已经混合在一起的硬币再次混合的工具，这可能会损害用户寻求的保密性。
最后，尽管JoinMarket的概念特别适合对动态流动性市场感兴趣的人，但由于其结构性弱点和技术复杂性，在我看来，无论是对于新手还是寻求coinjoin实现的专家来说，它都显得不那么吸引人。
### Wabisabi
Wabisabi 是另一种实现了 coinjoin 的方法，采用了集中协调交易的方式。这个模型由 Ádám Ficsór (nopara73)、Yuval Kogman、Lucas Ontivero 和 István András Seres 在 2021 年设计，并于次年集成到了 Wasabi 2.0 软件中。Wabisabi 正是 2018 年推出的 Wasabi 软件的 coinjoin 模型的一次演进。
![BTC204](assets/notext/53/03.webp)

在 2010 年代末期，Wasabi 采用了一种与 Whirlpool 截然不同的 coinjoin 交易结构。为了增加参与者的匿名集，Wasabi 使用了将数十名参与者组合在一起的非常大的 coinjoin 交易。相比之下，Whirlpool 选择了多个小型交易，允许每个周期的匿名集以指数方式增加。

两种实现在管理零钱方面也有所区别。在 Whirlpool 中，通过 TX0（我将在下一章进一步解释这个概念），零钱在 coinjoin 周期之前被排除并与 UTXOs 隔离。而在 Wasabi 中，零钱则形成了 coinjoin 交易的一个输出，这维持了某些输入和输出之间的确定性链接。

![BTC204](assets/notext/53/04.webp)

在 Wabisabi 中，Wasabi 的 2.0 版本调整了其对 coinjoins 的方法，使之更接近 Whirlpool 的模式。尽管 coinjoin 交易仍然非常大，但现在可以连续进行多个周期，从而遵循 Whirlpool 的模型。在管理零钱方面也做出了特别的努力：与 Wasabi 1.0 不同，其中零钱直接与用户的输入相关联，Wabisabi 试图将零钱细分为多个小额，以相同的面额分配给所有参与者。

让我们用一个只涉及 2 个用户的简化示例来说明这一点：Alice 想混合 115,000 sats，Bob 想混合 210,000 sats。忽略手续费，使用 Wasabi 1.0，一个 coinjoin 交易将生成 3 个输出，每个 100,000 sats，加上 1 个给 Alice 的 15,000 sats 的零钱和 1 个给 Bob 的 10,000 sats 的零钱。零钱输出总是与输入相关联：

![BTC204](assets/notext/53/05.webp)
在 Wabisabi 下，同样的交易将产生 3 个输出，每个 100,000 sats 和 5 个输出，每个 5,000 sats，从而以一种不直接可追溯到特定输入的方式分散零钱：
![BTC204](assets/notext/53/06.webp)

就我个人而言，我认为 Wabisabi 在管理零钱方面存在几个风险，可能会损害其在隐私方面的有效性：
- 当用户贡献的 UTXO 显著大于其他参与者时，他们不可避免地会得到一笔将与其输入相关联的零钱。这与协议的初衷相违背，其目标是消除任何可识别的零钱；
- 为了分割零钱而增加面额的做法，反而可能损害混合的效率。这一过程可能导致某些输出的匿名集减少，因为它们变得更容易被识别；
- 此方法还会生成价值较低的UTXO，这对用户来说是一个管理问题。这些小额UTXO，如果它们的花费成本相对于其价值变得过高，就会变成“尘埃”。这种现象迫使用户在未来的交易中合并多个UTXO为输入，或者对它们进行整合。在这两种情况下，由于COH的原因，这可能会降低获得的匿名集，或者完全取消最初通过coinjoin获得的隐私利益。
与实现ZeroLink协议、确保预混和后混UTXO之间严格分离的Whirlpool不同，Wabisabi没有保持这种严格的隔离。Wasabi的一些客户端还出现了地址重用的问题，这显然对用户非常不利。

在Wasabi的2.0版本中，实施了新的coinjoin费用政策。现在，对于大于0.01比特币的UTXO，协调员费用设定为0.3%，而对于较小的UTXO，这些费用完全免除。此外，这些小UTXO的重混是免费的，尽管所有交易（包括重混）的挖矿费用仍由用户承担。

这一政策与Whirlpool的政策形成对比，后者的费用保持固定，不论获得的匿名集大小如何。尽管对于小UTXO，Wasabi 2.0免除了协调员费用，用户仍必须支付所有交易（包括重混）的挖矿费用。
在撰写本文时，鉴于最近的事件，使用Wabisabi变得明显更加复杂。实际上，在Samourai Wallet的创始人被逮捕后，负责资助和管理Wasabi开发的公司zkSNACKs宣布将在2024年6月1日停止其coinjoin协调服务。这个默认设置在Wasabi上的协调员拥有绝大多数的流动性。

随着这个主要协调员的关闭，用户现在必须连接到新的独立协调员。这一变化引发了担忧：一方面，新的协调员可能没有足够的流动性，从而降低了coinjoin在隐私方面的有效性。另一方面，存在遇到恶意协调员的风险。这种情况为那些希望使用Wabisabi的人增加了新的重大风险。

除了技术问题外，zkSNACKs（Wasabi背后的公司）决定使用链分析公司的服务来筛选coinjoin参与者，这引发了严重的伦理和战略问题。最初的想法是防止犯罪分子在Wasabi上使用coinjoin，这一举措看似合理。然而，这引发了一个悖论：向协调员支付费用，其主要任务是增强用户的隐私，却反过来资助一个旨在破坏该隐私的公司。

更令人担忧的是筛选原则，这与旨在提供一个开放和不可审查的金融系统的比特币哲学形成了鲜明对比。虽然想要排除犯罪活动似乎是合理的，但这种筛选也可能影响到那些行为虽然在某些情境下被归类为非法，但可能在道德上是正当的或对社会有益的个体。爱德华·斯诺登的例子完美地说明了这种二分法：他因其揭露行为被一些政府视为犯罪分子，而被其他人视为为公共利益行动的告密者。这种复杂性突显了筛选的潜在危险，尽管出发点是好的，但最终可能侵犯合法用户的权利和安全。我还可以提到在某些专制政权下受到迫害的活动家和记者。
正如您所理解的，我无疑更偏爱使用Whirlpool模型来进行比特币上的coinjoins。这个系统因其严谨性而脱颖而出，并在隐私保障方面提供了更高的保证。它也是唯一一个在数学上提出被认为是完美混合的模型。在我看来，这个模型代表了比特币上coinjoins的未来。因此，我邀请您在下一章更深入地探索这个模型。

## Whirlpool的运作机制
<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>

Whirlpool与其他coinjoin方法的不同之处在于使用了“_ZeroLink_”交易，这确保了所有输入和所有输出之间绝对没有技术上的联系。这种完美的混合是通过一种结构实现的，其中每个参与者以相同的金额输入（挖矿费用除外），从而生成完全相等的输出金额。

这种对输入的限制性方法赋予了Whirlpool coinjoin交易一个独特的特征：输入和输出之间完全没有确定性的联系。换句话说，每个输出都有相同的可能性被任何参与者所拥有，与交易中所有其他输出相比。

![BTC204](assets/notext/54/01.webp)

### Whirlpool的一般运作机制

最初，每个Whirlpool coinjoin中的参与者数量限制为5个，包括2个新参与者和3个重混者（我们将进一步解释这些概念）。然而，2023年观察到的链上交易费用的增加促使Samourai团队重新思考他们的模型，以在降低成本的同时提高隐私。因此，考虑到费用的市场情况和参与者的数量，协调者现在可以组织包括6、7或8个参与者的coinjoins。这些增强的会话被称为“_Surge Cycles_”。重要的是要注意，无论配置如何，Whirlpool coinjoins中总是只有2个新参与者。

因此，Whirlpool交易的特点是输入和输出的数量相同，可以是：
- 5个输入和5个输出；

![BTC204](assets/notext/54/02.webp)

- 6个输入和6个输出；

![BTC204](assets/notext/54/03.webp)

- 7个输入和7个输出；

![BTC204](assets/notext/54/04.webp)

- 8个输入和8个输出。

![BTC204](assets/notext/54/05.webp)
Whirlpool提出的模型是基于小型coinjoin交易。与Wabisabi和JoinMarket不同，后者的匿名集的强度依赖于单个周期（或几个周期）中参与者的数量，Whirlpool则押注于多个小型周期的链接。在这个模型中，用户只在最初进入一个池时产生费用，允许他们参与多次重混而不产生额外费用。是新参与者为重混者支付挖矿费用。

每当一个币参与一个额外的coinjoin，连同它在过去遇到的同伴，匿名集将呈指数级增长。因此，目标是利用这些免费的重混，每发生一次，就有助于加强与每个混合币相关联的匿名集的密度。

![BTC204](assets/notext/54/06.webp)

Whirlpool在设计时考虑了两个重要要求：
- 移动设备上实施的可访问性，鉴于Samourai Wallet主要是一款智能手机应用程序；
- 重混周期的速度，以鼓励匿名集的显著增加。

这些要求指导了Samourai Wallet开发者在设计Whirlpool时的选择，使他们限制了每个周期的参与者数量。参与者太少会妨碍coinjoin的有效性，极大地减少每个周期产生的匿名集，而参与者过多则会在移动应用程序上造成管理问题，并且会阻碍周期的流动。

最终，由于匿名集是通过几个coinjoin周期的累积而形成的，因此在Whirlpool的每次coinjoin中没有必要有大量的参与者。这里最重要的原则是所有参与者的UTXOs的同质性，因为这允许完美的混合，从而充分利用混合和重混周期。

### 池和coinjoin费用

为了使这些多个周期有效地增加混合币的匿名集，必须建立一定的框架来限制使用的UTXOs的金额。Whirlpool因此定义了不同的池。

一个池代表一组希望一起混合的用户，他们同意使用UTXOs的金额以优化coinjoin过程，同时保持币的完美同质性。每个池指定了UTXO的固定金额，用户必须遵守这个金额才能参与。因此，要使用Whirlpool进行coinjoins，你需要选择一个池。目前可用的池如下：
- 0.5比特币；
- 0.05比特币；
- 0.01比特币；
- 0.001比特币（= 100,000 sats）。
通过将你的比特币加入一个池，它们将被分割以生成与池中其他参与者完全同质的UTXOs。每个池都有一个最大限额；因此，对于超过此限额的金额，你将被迫要么在同一个池内进行两次单独的输入，要么转向另一个金额更高的池：
| 池（比特币） | 每次输入的最大金额（比特币） |
|--------------|----------------------------|
| 0.5          | 35                         |
| 0.05         | 3.5                        |
| 0.01         | 0.7                        |
| 0.001        | 0.025                      |

当UTXO准备好被整合到coinjoin中时，它被认为属于一个池。然而，这并不意味着用户失去了它的所有权。正如我们在这部分的前几章中所看到的，通过不同的混合周期，你保留了对你的密钥和因此你的比特币的完全控制。这是coinjoin技术与其他集中化混合技术的区别。

要进入一个coinjoin池，你必须支付服务费以及挖矿费。每个池的服务费是固定的，旨在补偿负责Whirlpool开发和维护的团队。

使用Whirlpool的服务费是在进入池时一次性支付的。完成这一步骤后，你有可能参与无限次数的重混，无需额外费用。以下是每个池当前的固定费用：

| 池（比特币） | 入场费（比特币）         |
|--------------|-------------------------|
| 0.5          | 0.0175                  |
| 0.05         | 0.00175                 |
| 0.01         | 0.0005（50,000 sats）   |
| 0.001          | 0.00005（5,000 sats）        |
这些费用本质上充当了所选池的入场券，无论您在coinjoin中投入多少金额。因此，无论您是准确地加入0.01 BTC的0.01池，还是以0.5 BTC进入，费用在绝对值上将保持不变。

在进行Whirlpool coinjoins之前，用户因此有两种策略可选：
- 选择较小的池以最小化服务费，知道他们将收到几个较小的UTXOs作为回报；
- 或者选择较大的池，同意支付更高的费用以获得数量较少的大额UTXOs。
通常不建议在coinjoin周期后合并几个混合的UTXOs，因为这可能会损害获得的隐私，特别是由于共同输入所有权启发式（CIOH: *Common-Input-Ownership-Heuristic*）。因此，即使这意味着支付更多，选择一个较大的池可能是明智的，以避免输出太多小额UTXOs。用户必须权衡这些折中选择，以选择他们偏好的池。
除了服务费外，还必须考虑任何比特币交易固有的挖矿费。作为Whirlpool用户，您将被要求支付准备交易（`Tx0`）以及第一次coinjoin的挖矿费。所有后续的remix都将是免费的，这得益于Whirlpool的模型，该模型依赖于新参与者的支付。

实际上，在每次Whirlpool coinjoin中，输入中的2个用户是新参与者。其他输入来自remixers。因此，交易中所有参与者的挖矿费用由这2个新参与者承担，他们随后也将从免费remix中受益：

![BTC204](assets/en/54/07.webp)

得益于这种费用系统，Whirlpool真正区别于其他coinjoin实现，因为UTXOs的匿名集并不与用户支付的价格成正比。因此，仅通过支付池的入场费和2笔交易（`Tx0`和初始混合）的挖矿费，就有可能实现相当高水平的匿名性。

重要的是要注意，用户还必须支付挖矿费用，以在执行了多次coinjoins后从池中提取他们的UTXOs，除非他们选择了`mix to`选项，该选项允许提供一个外部地址，该地址将直接作为coinjoin输出接收资金，无需任何额外的交易。

### HD钱包账户

要通过Whirlpool执行coinjoin，钱包必须生成几个不同的账户。这是ZeroLink协议的原则。在HD（*层次确定性*）钱包的上下文中，一个账户构成了与其他账户完全隔离的一个部分，这种分离发生在钱包层次结构的第三深度级别，即`xpub`的级别。

![BTC204](assets/en/54/08.webp)

一个HD钱包理论上可以派生出`2^(32/2)`个不同的账户。默认使用的初始账户，对应于索引`0'`。

为了适应Whirlpool，使用了4个账户以满足ZeroLink过程的需求：
- **存款账户**，由索引`0'`标识；
- **坏账银行**账户（或“doxxic change”），由索引`2 147 483 644'`标识；
- **预混账户**，由索引`2 147 483 645'`标识；- **后混账户**，由索引`2 147 483 646'`标识。

这些账户中的每一个都在coinjoin过程中扮演了特定的功能，我们将在接下来的部分探讨。

所有这些账户都链接到一个单一的种子上，允许用户使用他们的恢复短语和必要时的密码短语，恢复对所有比特币的访问。然而，在这个恢复操作期间，有必要向软件指定所使用的不同账户索引。

现在让我们来看看在这些账户中Whirlpool coinjoin的不同阶段。

### TX0

任何Whirlpool coinjoin的起点都是**存款账户**。这个账户是你在创建新的比特币钱包时自动使用的账户。这个账户必须存入你希望混合的比特币。

`Tx0`代表Whirlpool混合过程的第一步。它的目标是为coinjoin准备和均衡UTXOs，将它们分成对应于所选池量的单位，以确保混合的同质性。均衡后的UTXOs随后被发送到**预混**账户。至于不能进入池的差额，则被分离到一个特定的账户：**坏账银行**（或称为"有害变更"）。

这个初始交易`Tx0`还用于支付因coinjoin协调者而产生的服务费用。与后续步骤不同，这笔交易不是协作性的；用户因此必须承担全部的挖矿费用：

![BTC204](assets/en/54/09.webp)

在这个`Tx0`交易的例子中，我们的**存款**账户的一个输入`372 000 sats`被分成几个输出UTXOs，分布如下：
- 一个`5 000 sats`的金额，用于支付协调者的服务费，对应于进入池的`100 000 sats`；
- 3个为混合准备的UTXOs，重定向到我们的**预混**账户并注册给协调者。这些UTXOs在`108 000 sats`每个，以支付它们未来初始混合的挖矿费用；
- 无法进入池的剩余部分，因为太小而被视为有害变更。它被发送到其特定账户。这里，这个变更金额为`40 000 sats`；
- 最后，有`3,000 sats`不构成输出，但是是确认`Tx0`所需的挖矿费用。
例如，这里是一个真实的Tx0 Whirlpool（不是我的）：[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/notext/54/10.webp)

### 有害变更

无法整合进池的多余部分，这里相当于`40,000 sats`，被重定向到**坏账银行**账户，也称为"有害变更"，以确保与钱包中其他UTXOs的严格分离。
这个UTXO对用户的隐私是危险的，因为它不仅仍然与其过去相关联，因此可能与其所有者的身份相关联，而且还被标记为属于参与了coinjoin的用户。
![BTC204](assets/notext/54/11.webp)

如果这个UTXO与混合输出合并，它们将失去在coinjoin周期中获得的所有隐私，特别是因为CIOH（*Common-Input-Ownership-Heuristic*，共同输入所有权启发式）。如果它与其他有毒的变化合并，用户可能会失去隐私，因为这将链接来自coinjoin周期的不同条目。因此，必须小心处理。我们将在本章的最后一节更详细地讨论这些有毒UTXO的管理。

### 初始混合

完成`Tx0`后，等值的UTXOs被发送到我们钱包的**premix**账户，准备引入它们的第一个coinjoin周期，也称为“初始混合”。如果像我们的例子那样，`Tx0`生成了几个用于混合的UTXOs，每个都将被集成到一个单独的初始混合中。

在这些首次混合结束时，**premix**账户将为空，而我们的硬币，在支付了这第一次coinjoin的挖矿费用后，将被精确调整到所选池定义的金额。在我们的例子中，我们最初的`108,000 sats` UTXOs将被减少到`100,000 sats`。

![BTC204](assets/notext/54/12.webp)

### 重新混合
在初始混合之后，UTXOs被转移到**postmix**账户。这个账户既收集了已经混合的UTXOs，也收集了等待重新混合的UTXOs。当Whirlpool客户端活跃时，**postmix**账户中的UTXOs自动可用于重新混合，并将被随机选择参与这些新的周期。
作为提醒，重新混合然后是100%免费的：不需要额外的服务费或挖矿费。因此，保持UTXOs在**postmix**账户中，既保持了它们的完整价值，同时提高了它们的匿名集。这就是为什么让这些硬币参与多个coinjoin周期很重要。这对你来说完全没有成本，并且增加了它们的匿名度。

当你决定花费混合的UTXOs时，你可以直接从这个**postmix**账户进行。建议将混合的UTXOs保留在此账户中，以享受免费的重新混合，并防止它们离开Whirlpool循环，这可能会降低它们的隐私。

### 如何正确管理你的postmix？

在执行coinjoin周期后，最佳策略是将你的UTXOs保留在**postmix**账户中，等待它们未来的使用。甚至建议让它们无限期地重新混合，直到你需要花费它们。

一些用户可能会考虑将他们混合的比特币转移到由硬件钱包保护的钱包中。这是可能的，但重要的是要严格遵循Samourai Wallet的建议，以免损害获得的保密性。

合并UTXOs是最常犯的错误。为了避免共同输入所有权启发式（CIOH），必须避免在同一笔交易中将混合的UTXOs与未混合的UTXOs结合起来。这需要在钱包内仔细管理你的UTXOs，特别是在标记方面。

![BTC204](assets/notext/54/13.webp)
在处理混合后的UTXO时，也要小心不要将混合的UTXO之间进行合并。如果你的混合UTXO拥有较高的匿名集，适度的合并是可以考虑的，但这无疑会降低你的币的保密性。确保合并既不过大也不在重混次数不足的情况下进行，以免在coinjoin周期前后建立起你的UTXO之间可推导的链接。如果对这些操作有疑问，最佳做法是不要合并postmix UTXO，而是一次将它们逐一转移到你的硬件钱包，每次生成一个新的空白地址。同样，记得为每个收到的UTXO正确标记。还建议不要将你的postmix UTXO转移到使用不常见脚本的钱包。例如，如果你从使用`P2WSH`脚本的多签钱包进入Whirlpool，你与其他使用原始同类型钱包的用户混合的机会很小。如果你将postmix提取到同一个多签钱包，你混合比特币的隐私级别将大大降低。除了脚本，还有许多其他钱包指纹可能会欺骗你。
与任何比特币交易一样，也重要的是不要重用接收地址。每个新交易都应该在一个新的空白地址上接收。

最简单和最安全的解决方案是让你的混合后的UTXO在它们的**postmix**账户中休息，让它们重新混合，只在需要花费时才动用。Samourai和Sparrow钱包对所有这些链分析相关风险有额外的保护。这些保护帮助你避免犯错。

### 如何正确管理你的有毒变化？

接下来，你必须小心管理你的有毒变化，即那些无法进入coinjoin池的变化。这些来自Whirlpool使用的有毒UTXO，因为它们建立了你与coinjoin使用之间的链接，对你的隐私构成风险。因此，必须谨慎处理它们，尤其是不要将它们与其他UTXO结合。

以下是考虑使用它们的不同策略：
- **在较小的池中混合它们：**如果你的有毒UTXO足够大，可以单独进入一个较小的池，考虑混合它。这通常是最佳选项。然而，不鼓励合并几个有毒UTXO以进入一个池，因为这可能会链接你的不同条目；
- **将它们标记为“不可花费”：**另一种方法是不再使用它们，将它们在其专用账户中标记为“不可花费”，并且只是持有。这确保你不会意外花费它们。如果比特币的价值增加，可能会出现更适合你的有毒UTXO的新池；
- **进行捐赠：**考虑进行捐赠，即使是微小的捐赠，也可以给在比特币及其相关软件上工作的开发者。你也可以捐赠给接受BTC的组织。如果管理你的有毒UTXO似乎太复杂，你可以通过捐赠来简单地处理它们。
- **购买礼品卡：**像[Bitrefill](https://www.bitrefill.com/)这样的平台允许你用比特币换取可以在各种商家使用的礼品卡。这可以是一种处理你的有毒UTXO而不失去相关价值的方式。
- **在门罗币上整合它们：**Samourai Wallet提供BTC和XMR之间的原子交换服务。这对于通过在门罗币上整合这些有毒的UTXO来管理它们非常理想，无需通过KYC妥协您的隐私，然后再将它们发送回比特币。然而，由于流动性限制，这个选项在挖矿费用和溢价方面可能成本较高。
- **将它们发送到闪电网络：**将这些UTXO转移到闪电网络以受益于降低的交易费用是一个有趣的选项。然而，这种方法可能会根据您使用闪电网络的方式揭露某些信息，因此应谨慎实践。

### 如何使用Whirlpool？

随着Samourai Wallet的创始人在2024年4月24日被逮捕以及他们的服务器被查封，即使对于那些拥有自己的Dojo的用户来说，Whirlpool工具也不再工作。之前，它在Samourai Wallet和Sparrow Wallet上可用。

![BTC204](assets/notext/54/14.webp)

然而，根据审判的结果，这个工具在未来几周内可能会重新投入使用，或以不同的方式重新启动。无论如何，我相信比特币上的coinjoin市场不会长时间没有供应，因为有明显的需求。此外，Whirlpool模型作为隐私方面最先进的模型，将来肯定会在其他实现中使用。

我们正在密切关注这个案件的进展以及与之相关工具的发展。请放心，一旦有新信息可用，我们将更新此培训。

在下一章中，我们将发现什么是“匿名集”（anonsets），如何计算这些指标，以及它们如何帮助我们估计coinjoin周期的有效性。

https://planb.network/tutorials/privacy/coinjoin-sparrow-wallet

https://planb.network/tutorials/privacy/coinjoin-samourai-wallet

https://planb.network/tutorials/privacy/coinjoin-dojo

## 匿名集
<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>

在研究coinjoins如何工作以及与有效混合相关的挑战之后，我们现在将学习如何衡量这种有效性。如何确定coinjoin过程是否有效以及一个币获得了什么程度的匿名性？这就是我们将在本章中探索的，使用匿名集或英文中的“anonsets”。

### 关于Coinjoin的效用提醒
CoinJoin的效用在于它能够通过将您的币浸入一组无法区分的币中来产生合理的否认性。这个行动的目标是打破过去到现在以及从现在到过去的可追溯性链接。
换句话说，一个知道您在CoinJoin周期入口的初始交易（`Tx0`）的分析师，不应该能够确定地识别出您在重混周期出口的UTXO（从周期入口到周期出口的分析）。

![BTC204](assets/en/55/01.webp)

相反，一个在CoinJoin周期出口知道您的UTXO的分析师，应该无法确定周期入口时的原始交易（从周期出口到周期入口的分析）。

![BTC204](assets/en/55/02.webp)
为了评估分析师将过去与现在联系起来（反之亦然）的难度，必须量化在其中隐藏您的硬币的同质硬币群组的大小。这个度量告诉我们具有相同可能性的分析数量。因此，如果正确的分析在其他3个等概率的分析中淹没，那么您的隐藏级别非常低。然而，如果正确的分析在一个包含20,000个分析的集合中，所有这些分析都同样可能，那么您的硬币隐藏得非常好。而且，这些群组的大小代表了称为“匿名集”的指标。

### 理解匿名集

匿名集作为评估特定UTXO隐私程度的指标。更具体地说，它们衡量在包含被研究硬币的集合内不可区分的UTXOs的数量。对同质UTXO集的要求意味着匿名集通常在CoinJoin周期上计算。这些指标的使用对于Whirlpool CoinJoins特别相关，因为它们的统一性。

在适当的情况下，匿名集允许判断CoinJoins的质量。较大的匿名集大小意味着高度的匿名性，因为在同质集内区分特定UTXO变得困难。

有两种类型的匿名集：
- **前瞻性匿名集；**
- **回顾性匿名集。**

### 前瞻性匿名集

前瞻性匿名集指的是在周期退出时，已知入口处的UTXO，隐藏其中的群组大小，即此群组内不可区分硬币的数量。用英语，这个指标的名称是“前向匿名集”，或“前瞻性指标”。
这个指标允许衡量硬币对抗从过去到现在的分析（输入到输出）的隐私抵抗力。

例如，如果您的交易参与了其第一个coinjoin周期，并且完成了两个额外的后代周期，那么您的硬币的前瞻性匿名集将是`13`：

![BTC204](assets/notext/55/04.webp)

例如，假设我们的硬币在coinjoin周期的入口处享有`86,871`的前瞻性匿名集。实际上，这意味着它隐藏在`86,871`个不可区分的硬币中。对于一个在coinjoin周期开始时就知道这个硬币并试图追踪其退出的外部观察者，他们将面临`86,871`个可能的UTXOs，每个都有相同的可能性是被寻找的硬币。

![BTC204](assets/en/55/05.webp)

### 回顾性匿名集

回顾性匿名集指的是在周期退出时已知UTXO的情况下，给定硬币的可能来源数量。这个指标衡量硬币对抗从现在到过去的分析（退出到输入）的隐私抵抗力，即分析师追溯到您的硬币在coinjoin周期之前的起源有多困难。用英语，这个指标的名称是“后向匿名集”，或“后向指标”。

![BTC204](assets/en/55/06.webp)

知道您在周期退出时的UTXO，回顾性匿名集确定了可能构成您进入coinjoin周期的Tx0交易的数量。在下面的图表中，这对应于所有橙色气泡的总和。
![BTC204](assets/notext/55/07.webp)
例如，让我们想象一下，我们的硬币在coinjoin周期结束时获得了`42,185`的回顾性匿名集。实际上，这意味着这个UTXO有`42,185`个潜在来源。如果一个外部观察者在周期结束时识别出这枚硬币并试图追踪其来源，他们将面临`42,185`个可能的来源，所有这些来源都有同等的可能性成为被寻找的起源。

![BTC204](assets/en/55/08.webp)

### 如何具体计算匿名集？
对于小型集合，可以使用区块浏览器手动计算某人的匿名集。然而，对于更大的匿名集，使用专门的工具变得必不可少。据我所知，唯一能够执行此任务的软件是*Whirlpool Stats Tool*，这是一个由Samourai和OXT团队开发的Python工具。不幸的是，由于Samourai的创始人被逮捕以及OXT的停运（OXT用于从区块链提取数据），这个工具目前已经停止服务。
![BTC204](assets/notext/55/09.webp)

正如我们在本章中所看到的，只有当coinjoins的结构具有一定的同质性时，才能计算匿名集。而确切地说，在下一章中，我们将发现如何在比特币交易中量化这种同质性，无论它是coinjoin还是更传统的交易。

https://planb.network/tutorials/privacy/wst-anonsets

## 熵
<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>

正如我们在关于coinjoins的这部分中所看到的，输入和输出中UTXOs的同质性在提高比特币交易的保密性方面起着重要作用。这个参数允许对抗链分析的合理否认。有几种方法可以测量这种同质性，但我认为最有效的一种是使用由OXT和Samourai Wallet团队开发的*Boltzmann*工具提供的指标，特别是交易的熵。这就是我们将在本章中详细研究的内容。

与匿名集不同，后者是在一组交易上计算的，我们将在这里介绍的指标仅专注于单个交易，无论它是coinjoin还是更传统的交易。

### 解释的数量

可以在比特币交易上观察到的第一个指标是外部观察者分析交易时可能的总解释数量。考虑到交易中涉及的UTXOs的值，这个指标指出了输入可以与输出关联的方式数量。换句话说，它确定了从外部观察者分析比特币流动的角度，一笔交易可以生成的可能解释数量。

例如，一个带有1个输入和2个输出的简单支付交易只会有一个解释，即输入#0资助了输出#0和输出#1。没有其他可能的解释：

![BTC204](assets/notext/56/01.webp)

相比之下，根据Whirlpool 5x5模型构建的coinjoin呈现出$1,496$个可能的组合：
![BTC204](assets/notext/56/02.webp)
一个Whirlpool Surge Cycle 8x8 coinjoin自身呈现出$9,934,563$个可能的解释：

![BTC204](assets/notext/56/03.webp)

### 熵
从比特币交易的可能解释数量中，我们可以计算出其熵值。

在密码学和信息理论的一般背景下，熵是与数据源或随机过程相关联的不确定性或不可预测性的量化度量。换句话说，熵是衡量信息预测或猜测难度的一种方式。

在链分析的特定背景下，熵也是一个指标的名称，该指标源自香农熵，并由[LaurentMT发明](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf)，可以在比特币交易上计算得出。

当一个交易呈现出高数量的可能解释时，通常更有意义地参考其熵值。这个指标允许测量分析师对交易确切配置的知识缺乏程度。换句话说，熵值越高，分析师识别比特币输入和输出流向的任务就越困难。

实际上，熵揭示了从外部观察者的角度来看，一个交易是否基于输入和输出的金额呈现出多种可能的解释，而不考虑其他外部或内部模式和启发式规则。因此，高熵与交易的更好保密性同义。

熵被定义为可能组合数量的二进制对数。这里是使用的公式，其中$E$是交易的熵值，$C$是可能解释的数量：

$$
E = \log_2(C)
$$

在数学中，二进制对数（基数为2的对数）对应于指数化2的逆运算。换句话说，$x$的二进制对数是必须将$2$提升到的指数，以获得$x$。因此，这个指标以比特为单位表示。

让我们以计算根据Whirlpool 5x5模型构建的coinjoin交易的熵为例，如前一节所述，该交易呈现出$1,496$种可能的解释：

$$
\begin{align*}
C &= 1,496 \\
E &= \log_2(1,496) \\
E &= 10.5469 \text{比特}
\end{align*}
$$
因此，这个coinjoin交易显示的熵为$10.5469$比特，这被认为是非常令人满意的。这个值越高，交易承认的不同解释就越多，从而增强了其隐私级别。
对于呈现$9,934,563$种解释的8x8 coinjoin交易，熵值将是：

$$
\begin{align*}
C &= 9,934,563 \\
E &= \log_2(9,934,563) \\
E &= 23.244 \text{比特}
\end{align*}
$$

让我们再举一个例子，一个标准的支付交易，具有1个输入和2个输出：[1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/notext/56/04.webp)

在这个交易的情况下，唯一可能的解释是：`(In.0) > (Out.0 ; Out.1)`。因此，其熵值被确定为$0$：

$$
\begin{align*}
### 效率

从交易的熵出发，我们也可以计算其在隐私方面的效率。这一指标通过将交易与在相同配置下可想象的最优交易进行比较来评估交易的效率。

这引出了最大熵的概念，它对应于特定交易结构理论上能达到的最高熵。然后，通过将这个最大熵与分析交易的实际熵进行对比来计算交易的效率。

使用的公式如下：
- $E_R$：交易的实际熵，以比特为单位；
- $E_M$：交易结构可能的最大熵，也以比特为单位；
- $Ef$：交易的效率，以比特为单位：

$$
Ef = E_R - E_M
$$

例如，对于一个Whirlpool 5x5类型的coinjoin结构，最大熵是$10.5469$：

$$
\begin{align*}
E_R &= 10.5469 \\
E_M &= 10.5469 \\
Ef &= E_R - E_M \\
Ef &= 10.5469 - 10.5469 \\
Ef &= 0 \text{ 比特}
\end{align*}
$$

这个指标也以百分比表示。使用的公式如下：
- $C_R$：可能的实际解释数量；
- $C_M$：具有相同结构的最大可能解释数量；
- $Ef$：效率，以百分比表示：

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1\,496}{1\,496} \\
E_f &= 100\%
\end{align*}
$$

因此，$100\%$的效率表明，基于其结构，交易最大化了其隐私潜力。

### 熵密度

熵是衡量交易隐私的一个好指标，但它部分依赖于交易中的输入和输出数量。为了比较两个不同交易的熵，这些交易的输入和输出数量不同，可以计算熵密度。这一指标提供了关于交易中每个输入或输出相对的熵的视角。密度对于评估和比较不同大小的交易的效率很有用。

计算方法是将交易的总熵除以交易中涉及的输入和输出的总数：
- $E_D$：熵密度，以比特为单位；
- $E$：交易的熵，以比特为单位；
- $T$：交易中输入和输出的总数：

$$
E_D = \frac{E}{T}
$$

以Whirlpool 5x5 coinjoin为例：

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ 比特}
\end{align*}
$$

我们也来计算Whirlpool 8x8 coinjoin的熵密度：

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
通过分析这两种类型的coinjoin的熵密度，显然即使在通过元素数量标准化熵之后，"Surge Cycle 8x8" coinjoin产生的不确定性更大。

### Boltzmann得分
在交易分析中另一个被分析的信息是每个元素相对于另一个的Boltzmann得分。这是一个输入和输出之间匹配概率的表格。通过Boltzmann得分，这个表格指出了一个特定输入与给定输出链接的条件概率。因此，它是一个定量测量，在一次交易中输入与输出之间的关联发生的条件概率，基于这个事件发生的有利情况数量与可能发生的总情况数量的比率，在一组解释中建立。

以Whirlpool coinjoin为例，条件概率表将突出显示每个输入与输出之间链接的机会，提供交易中关联模糊性的定量测量：

| %       | 输出0 | 输出1 | 输出2 | 输出3 | 输出4 |
| ------- | ----- | ----- | ----- | ----- | ----- |
| 输入0 | 34%   | 34%   | 34%   | 34%   | 34%   |
| 输入1 | 34%   | 34%   | 34%   | 34%   | 34%   |
| 输入2 | 34%   | 34%   | 34%   | 34%   | 34%   |
| 输入3 | 34%   | 34%   | 34%   | 34%   | 34%   |
| 输入4 | 34%   | 34%   | 34%   | 34%   | 34%   |

这里，很明显每个输入与任何输出关联的机会都是相等的，这增强了交易的保密性。

计算Boltzmann得分涉及到将某一事件表现出的解释数量除以可用解释的总数。因此，要确定将输入#0与输出#3关联的得分（在$512$种解释中出现的事件），过程如下：

$$
\begin{align*}
\text{解释（输入.0 > 输出.3）} &= 512 \\
\text{总解释} &= 1496 \\
\text{得分} &= \frac{512}{1496} \\
\text{得分} &= 34\%
\end{align*}
$$

如果我们重新审视Whirlpool coinjoin 8x8 Surge Cycle的例子，Boltzmann表格将如下所示：

|       | 输出.0 | 输出.1 | 输出.2 | 输出.3 | 输出.4 | 输出.5 | 输出.6 | 输出.7 |
|-------|-------|-------|-------|-------|-------|-------|-------|-------|
| 输入.0 | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.1  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.2  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.3  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.4  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.5  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.6  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.7  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |

然而，在涉及单一输入和2个输出的简单交易中，情况有所不同：

| %       | 输出0 | 输出1 |
|---------|------|------|
| 输入0 | 100%  | 100%  |

在这里，我们观察到每个输出来源于输入#0的概率是100%。因此，较低的概率转化为通过稀释输入和输出之间的直接链接来增加隐私。

### 确定性链接

也可以计算交易中的确定性链接数量。这个指标揭示了在分析的交易中，输入和输出之间有多少连接是无可争议的，概率为100%。然后，可以通过计算确定性链接的比率来补充这个指标。这个比率提供了一个视角，关于这些确定性链接在所有交易链接中的权重。

例如，一个Whirlpool类型的coinjoin交易显示输入和输出之间没有确定性链接，因此显示出0链接和0%的比率指标。相反，在我们检查的第二个简单支付交易中（有一个输入和2个输出），指标告诉我们有2个确定性链接，比率达到100%。因此，一个空指标表示由于缺乏输入和输出之间直接和无可争议的连接，隐私性极好。

### 如何计算这些指标？
使用我提供的方程手动计算这些指标相对简单。主要困难在于确定交易的可能解释数量。对于标准交易，这个计算可以手工进行。然而，对于coinjoin，任务显著更复杂。

以前，有一个名为_Boltzmann Calculator_的Python工具，由OXT和Samourai的团队开发，它允许自动计算比特币交易的所有这些指标：

![BTC204](assets/notext/56/05.webp)

也可以使用网站KYCP.org进行这些分析：

![BTC204](assets/notext/56/06.webp)
不幸的是，随着Samourai的创始人被逮捕，这些工具目前无法使用。
现在我们已经详细讨论了coinjoins，我们将在我们培训的最后一部分探索比特币上可用的其他隐私技术。我们将检查payjoins、特定的交易类型伪coinjoins、静态地址协议，以及旨在增强隐私的措施，不仅在交易层面上，而且在节点网络层面上。

https://planb.network/tutorials/privacy/boltzmann-entropy

# 理解其他高级隐私技术的关键点
<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Payjoin交易
<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>

Coinjoin目前代表了在链分析中引入对币追踪不确定性的最有效方法。正如我们在前几章中看到的，为了实现有效的混合，输入和输出需要尽可能同质化。此外，将硬币整合到尽可能大的群体中以最大化匿名集是至关重要的。因此，要使coinjoins有效，它们必须涉及大量统一的硬币。这一多重要求意味着coinjoin交易具有非常严格的结构：金额是预先确定的，所有参与者必须遵守这些金额以确保过程的统一性。此外，coinjoins要求所有参与者和协调者在交易构建期间进行同步。
这些要求使得coinjoin不适合直接支付。例如，如果你在coinjoin池中拥有1M sats的份额，直接将其用作支付将是复杂的。这将需要与其他参与者和协调者同步，以在你需要进行支付的那一刻精确构建协作交易，而且购买金额必须完全匹配你的份额值，这在实践中几乎是不可能实现的。因此，coinjoin交易本质上是一种清扫式协作交易，意味着输入的同一所有者通常会出现在输出中。
然而，如果有交易结构能够允许实际支付的同时在链分析中引入疑问，那将是有趣的。这正是我们将在本章和下一章中探索的内容。

### 什么是payjoin交易？

Payjoin是一种特定的比特币交易结构，在支付过程中通过与支付接收者合作来增强用户隐私。

LaurentMT首次在2015年提到了这种方法，当时称之为“*隐写术交易*”，可以在[这里](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt)访问相关文档。这项技术后来被Samourai Wallet采用，Samourai Wallet在2018年成为第一个用Stowaway工具实现它的客户端。payjoin的概念也出现在[BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki)和[BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki)中。因此，有几个术语被用来指代payjoin：
- Payjoin；
- Stowaway；
- P2EP（*Pay-to-End-Point*）；
- 隐写术交易。
Payjoin 的特殊性在于它能够生成一笔乍看之下普通的交易，但实际上是两个人之间的迷你 Coinjoin。为此，交易结构涉及到除了实际发送者之外，还有支付接收者的输入。因此，接收者在交易中间包含了一笔对自己的支付，这允许他们得到支付。
让我们通过一个例子来更好地理解这个过程。Alice 使用一个 10,000 sats 的 UTXO 买了一个 4,000 sats 的法棍，并选择了 payjoin。她的面包师 Bob，在输入中添加了一个属于他的 15,000 sats 的 UTXO，他在输出中完全取回这部分，加上 Alice 的 4,000 sats。

![BTC204](assets/notext/61/01.webp)
在这个例子中，面包师 Bob 输入了 15,000 sats，并且带着 19,000 sats 出来，差额正好是 4,000 sats，这是法棍的价格。在 Alice 这边，她输入了 10,000 sats，并以 6,000 sats 的输出结束，这代表了 -4,000 sats 的余额，即法棍的价格。为了简化例子，我故意省略了这笔交易中的挖矿费用。

### Payjoin 的目的是什么？

Payjoin 交易实现了两个目标，允许用户提高他们支付的隐私性。

首先，payjoin 旨在通过在链分析中创建一个假象来误导外部观察者。这得益于 CIOH 启发式（*Common Input Ownership Heuristic*）。正如我们在第三部分看到的，通常情况下，当区块链上的一笔交易有多个输入时，假设所有这些输入属于同一个实体或用户。

因此，当分析师检查一笔 payjoin 交易时，他们会被引导认为所有的输入都来自同一个人。然而，这种感知是不正确的，因为支付的接收者也在实际支付者旁边贡献了输入。因此，链分析被误导到一个结果上，这个结果是错误的。

让我们回到我们的一个例子，一个为支付法棍的 payjoin 交易：

![BTC204](assets/notext/61/02.webp)

在区块链上看到这笔交易的外部观察者，遵循链分析的常规启发式，会这样解释："*Alice 合并了 2 个 UTXO 作为交易的输入，以支付给 Bob 19,000 sats*”。

![BTC204](assets/en/61/03.webp)

这种解释显然是不正确的，正如你已经知道的，两个输入中的 UTXO 并不属于同一个人。一个来自于购买法棍的 Alice，另一个来自于面包师 Bob。

![BTC204](assets/notext/61/04.webp)

因此，外部观察者的分析被引向了一个错误的结论，这确保了参与者的隐私性得到了保护。

### 隐写术交易

Payjoin 的第二个目标是欺骗外部观察者关于实际支付金额的大小。通过检查交易的结构，分析师可能会认为支付等同于其中一个输出的金额。
如果我们重新审视买法棍面包的例子，分析师会认为支付金额要么对应于6,000 sats的UTXO，要么对应于19,000 sats的UTXO。在这种情况下，分析师更有可能认为支付金额是19,000 sats，因为输出中有2个UTXO，其中至少有一个大于6,000 sats（当单个UTXO就足以支付这笔款项时，没有逻辑理由使用2个UTXO来支付6,000 sats）。![BTC204](assets/en/61/05.webp)

但实际上，这种分析是不正确的。支付金额并不对应于任何输出。实际上，它是收款人在输出中的UTXO与收款人在输入中的UTXO之间的差额。

![BTC204](assets/en/61/06.webp)

在这种情况下，payjoin交易属于隐写术的范畴。它允许在充当诱饵的假交易中隐藏真实交易金额。

隐写术是一种在其他数据或对象中隐藏信息的技术，以这样一种方式，隐藏信息的存在不被察觉。例如，可以在与之无关的文本中的一个点内隐藏一条秘密信息，使其对肉眼不可检测（这是[micropoint](https://fr.wikipedia.org/wiki/Micropoint)技术）。

与加密不同，加密使信息在没有解密密钥的情况下变得不可理解，隐写术不改变信息。它仍然是显而易见的。其目的是隐藏秘密信息的存在本身，而加密则明显揭示了隐藏信息的存在，尽管没有密钥就无法访问。这就是为什么payjoin最初的名称是“*隐写交易*”。

可以在密码学与coinjoin之间，以及隐写术与payjoin之间做一个类比。实际上，coinjoin具有类似于加密的属性：方法是可识别的，但信息是不可解读的。相反，payjoin类似于隐写术：信息理论上是可访问的，但由于其隐藏方法不可识别，它变得无法访问。

### 如何使用payjoin？

支持payjoin的已知软件包括Sparrow Wallet、Wasabi Wallet、Mutiny、BitMask、BlueWallet和JoinMarket，以及支付处理器BTCPay。

![BTC204](assets/notext/61/07.webp)
payjoin最先进的实现只有Samourai Wallet上的Stowaway。然而，由于软件创始人被逮捕，这个工具现在只能部分工作。Stowaway的优势在于它是一个完整且非常易于使用的协议，支持接收和发送payjoins。可以通过扫描多个QR码手动交换部分签名的交易，或者通过Tor通过Soroban自动交换。目前，后一种通信选项已经停止服务。
![BTC204](assets/notext/61/08.webp)

使用payjoin的难点在于它依赖于商家的参与。作为顾客，如果商家不支持payjoin，使用payjoin是不可能的。这在购买过程中增加了额外的难度：不仅找到接受比特币的商家很复杂，如果还寻找支持payjoins的商家，那就更加复杂了。
一种解决方案是使用引入链分析歧义的交易结构，而不需要收款人的合作。这将允许我们在不依赖商家主动参与的情况下，提高我们支付的隐私性。这正是我们将在下一章中研究的内容。
https://planb.network/tutorials/privacy/payjoin-sparrow-wallet

https://planb.network/tutorials/privacy/payjoin-samourai-wallet

## 支付迷你-Coinjoins
<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>

当寻求在保持一定程度隐私的同时进行支付交易时，payjoin是一个不错的选择。但正如我们所见，payjoin需要收款人的参与。那么，如果后者拒绝参与payjoin，或者如果您简单地更愿意不让他们参与呢？一种替代方案是使用Stonewall或Stonewall x2交易。让我们更仔细地看看这两种类型的交易。

### Stonewall交易

Stonewall是一种特定形式的比特币交易，旨在通过模仿两个人之间的伪coinjoin来增加用户在支出时的隐私，而实际上并不是一个合作交易。确实，这种交易不是协作性的。用户可以单独构建它，只涉及他们拥有的UTXOs作为输入。因此，您可以在任何场合创建Stonewall交易，无需与另一个用户或收款人同步。

Stonewall交易的操作如下：在交易的输入中，发送者使用属于他们的2个UTXOs。在输出中，交易产生4个UTXOs，其中2个将是完全相同的金额。另外2个UTXOs将构成找零。在相同金额的2个输出中，只有一个实际上会去给支付的收款人。
Stonewall交易中只有2个角色：
- 发送者，进行支付；
- 收款人，可能不知道交易的特定性质，只是在等待来自发送者的支付。

让我们通过一个例子来理解这种交易结构。Alice在面包师Bob那里买她的法棍，价格是4,000 sats。她想在保持一定隐私水平的同时用比特币支付。因此，她决定为支付构建一个Stonewall交易。

![BTC204](assets/notext/62/01.webp)

分析这笔交易，我们可以看到面包师Bob确实收到了4,000 sats作为法棍的支付。Alice使用了2个UTXOs作为输入：一个是10,000 sats，另一个是15,000 sats。在输出中，她收到了3个UTXOs：一个是4,000 sats，一个是6,000 sats，另一个是11,000 sats。Alice在这笔交易上的净余额是-4,000 sats，这正好对应于法棍的价格。

在这个例子中，我故意忽略了挖矿费用以便于理解。实际上，交易费用完全由发送者承担。

### Stonewall交易的目标是什么？
Stonewall结构大大增加了交易的熵值，并模糊了链分析的踪迹。从外部看，这样的交易可以被解释为两个人之间的小型coinjoin。但实际上，这是一笔支付。因此，这种方法在链分析中产生了不确定性，甚至可能导致错误的线索。
让我们回到Alice在面包师Bob那里的例子。区块链上的交易看起来会是这样的：

![BTC204](assets/notext/62/02.webp)

依赖常见链分析启发式方法的外部观察者可能会错误地得出结论：“*两个人进行了一个小型的coinjoin，每个人输入一个UTXO，输出两个UTXO*”。从外部分析这笔交易并不会应用到常见输入所有权启发式（CIOH），因为两个相同金额的输出暗示了一个coinjoin模式。因此，从外部视角看，CIOH在这个特定案例中不适用。

![BTC204](assets/notext/62/03.webp)

这种解释是不准确的，因为，正如你所知，一个UTXO被发送给了面包师Bob，2个输入的UTXO来自Alice，她找回了3个零钱输出。

![BTC204](assets/notext/62/04.webp)
特别有趣的是，从外部观察者的角度看，Stonewall交易的结构看起来完全像是Stonewall x2交易。

### Stonewall x2交易

Stonewall x2是比特币交易的另一种特定形式，也旨在增加用户在支出时的隐私，但这次是通过与第三方合作，而第三方并不参与支出。这种方法像是两个参与者之间的伪coinjoin，同时向第三人支付。

Stonewall x2交易的操作相对简单：使用一个人拥有的UTXO进行支付，并请求第三方帮助，第三方也用他们拥有的UTXO贡献。交易结束时有四个输出：两个等额的，一个用于支付接收者的地址，另一个用于合作者的地址。第三个UTXO被发送回合作者的另一个地址，允许他们回收初始金额（对他们来说是一个中性行为，减去挖矿费），最后一个UTXO返回给我们的地址，构成了支付的找零。

因此，在Stonewall x2交易中定义了三种不同的角色：
- 发送者，进行实际支付；
- 接收者，可能不知道交易的特定性质，只是等待来自发送者的支付；
- 合作者，提供比特币以在交易分析中制造疑问，同时在最后完全回收他们的资金（对他们来说是一个中性行为，减去挖矿费）。

让我们回到我们的例子，Alice在面包师Bob那里买她的法棍，价格是4,000 sats。她想用比特币支付，同时保持一定程度的支付隐私。所以，她请求她的朋友Charles帮助她进行这个过程。

![BTC204](assets/notext/62/05.webp)
分析这笔交易，我们可以看到面包师Bob确实收到了4,000 sats作为法棍面包的付款。Alice使用了10,000 sats作为输入，并收回了6,000 sats作为输出，结果净余额为-4,000 sats，这对应于法棍面包的价格。至于Charles，他提供了15,000 sats作为输入，并收到了两个输出：一个是4,000 sats，另一个是11,000 sats，使得余额为0。
在这个例子中，我故意忽略了手续费以便于理解。实际上，挖矿费用通常由支付发起者和合作者平均分担。

### Stonewall x2交易的目标是什么？
像Stonewall结构一样，Stonewall x2结构增加了交易的熵量，并且模糊了链分析的踪迹。从外部视角来看，这样的交易可以被解释为两个人之间的小型coinjoin。但实际上，它是一次支付。因此，这种方法在链分析中产生了不确定性，甚至导致了错误的踪迹。

让我们重新审视Alice、面包师Bob和Charles的例子。区块链上的交易看起来会是这样的：

![BTC204](assets/notext/62/06.webp)

依赖常见链分析启发式方法的外部观察者可能会错误地得出结论，认为“*Alice和Charles进行了一个小型的coinjoin，每人输入一个UTXO并各自输出两个UTXO*”。再次强调，从外部分析这笔交易并不会导致应用Common Input Ownership Heuristic (CIOH)，因为两个相同金额的输出的存在暗示了一个coinjoin模式。因此，从外部视角来看，这个特定情况下CIOH并不适用。

![BTC204](assets/notext/62/07.webp)

这种解释是不准确的，因为正如你所知，一个UTXO被发送给了面包师Bob，Alice只有一个找零输出，而Charles有两个。

![BTC204](assets/notext/62/08.webp)

而且，再次强调，Stonewall x2交易结构特别有趣的一点是，从外部观察者的视角来看，它看起来完全像是一个Stonewall交易。

### Stonewall和Stonewall x2之间有什么区别？

StonewallX2交易的操作方式与Stonewall交易完全相同，除了前者是协作的，而后者不是。正如我们所见，Stonewall x2交易涉及第三方（Charles）的参与，他对支付是外部的，并提供他的比特币来增强交易的保密性。在经典的Stonewall交易中，合作者的角色由发送者扮演。

![BTC204](assets/notext/62/09.webp)

因此，从外部视角来看，交易的模式完全相同。

![BTC204](assets/notext/62/10.webp)

这两种交易结构共享完全相同的模式这一事实意味着，即使外部观察者设法识别出“Stonewall(x2)”模式，他们也不会拥有所有信息。他们将无法确定两个相同金额的UTXOs中哪一个对应于支付。此外，他们也无法确定两个输入的UTXOs是来自两个不同的人（Stonewall x2）还是属于一个人合并了它们（Stonewall）。
这最后一点是因为Stonewall x2交易遵循与Stonewall交易完全相同的模式。从外部来看，如果没有关于上下文的额外信息，就不可能区分Stonewall交易和Stonewall x2交易。然而，前者不是协作交易，而后者是。这在分析这些交易中的一个时增加了更多的疑问。

### 何时使用Stonewall和Stonewall x2交易？

在想要使用隐私工具进行交易时，逻辑应该如下：
- 优先选择进行payjoin支付；
- 如果商家不支持payjoin，可以使用Stonewall x2结构与支付之外的另一个人进行协作交易；
- 如果找不到人进行Stonewall x2交易，可以单独进行Stonewall交易，这将模仿Stonewall x2交易的行为。

### 如何使用Stonewall和Stonewall x2交易？

Stonewall和Stonewall x2交易都可以在Samourai Wallet应用程序和Sparrow Wallet软件上使用。

![BTC204](assets/notext/62/11.webp)

然而，就像payjoins一样，随着Samourai的创始人被逮捕，Stonewall x2交易现在只能通过手动交换参与方之间的PSBT来进行。通过Soroban自动交换目前不可用。

也可以从任何比特币钱包软件手动执行此类交易。

在下一章中，我们将研究另一种隐私技术，这种技术相对不为人知，但是作为我们已经研究的内容的补充非常有用。

https://planb.network/tutorials/privacy/stonewall

https://planb.network/tutorials/privacy/stonewall-x2

## Ricochets

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>

使用增加链分析中的模糊性的比特币交易结构，如coinjoin，对于隐私保护特别有益。然而，正如我们在讨论payjoins的章节中所讨论的，coinjoin交易在链上自然是可识别的。记住我们建立的加密和coinjoins之间的类比：当某人加密一个文件时，第三方发现这个加密文件不能访问其内容，但可以清楚地识别出文件已被修改以隐藏其内容。对于coinjoin也是如此：当分析师检查一个coinjoin交易时，尽管他们不能建立输入和输出之间的直接链接（反之亦然），但他们仍然可以认出观察到的交易是一个coinjoin。
根据您在经历coinjoin周期后对您的硬币的预期用途，它经过这个过程可能会有问题。例如，如果您计划在受监管的交易平台上出售您的硬币，但它最近经历了coinjoin，平台的链分析工具将检测到这一事实。平台可能会拒绝接受您经过coinjoin的UTXO，甚至要求您解释，有被冻结账户或资金的风险。在某些情况下，平台还可能向国家机关报告您的行为（例如，这是TRACFIN要求法国的数字资产服务提供商（PSAN）做的）。
![BTC204](assets/notext/63/01.webp)
为了避免这种情况，我们需要一种能够模糊比特币过去记录的工具，以恢复某种形式的可替代性。这正是ricochet的目标。

![BTC204](assets/notext/63/02.webp)

### 什么是ricochet?

Ricochet是一种技术，涉及对自己进行多次虚构交易（清扫），以模拟比特币所有权的转移。这种工具与我们讨论过的其他交易结构不同，因为它不允许预期匿名性，而是一种回顾性匿名性。实际上，ricochet允许模糊可能妨碍比特币因其过去而损害可替代性的具体细节。

为了模糊过去事件在硬币上留下的印记，例如coinjoin周期，ricochet执行四次连续交易，在不同地址上将资金转给自己。

![BTC204](assets/en/63/03.webp)

经过这一系列交易后，ricochet工具最终将比特币路由到它们的最终目的地，例如交易平台。

![BTC204](assets/en/63/04.webp)

目标是创建影响硬币可替代性的距离，例如coinjoin交易，以及最终的消费行为可能因其过去而拒绝这枚硬币。因此，链分析工具可能会得出结论，事件发生后可能已经发生了所有权变更，并认为这枚硬币是可替代的。在coinjoin的情况下，链分析工具可能会假设发送比特币和执行coinjoin的不是同一个人，因此没有必要针对发送者采取行动。

![BTC204](assets/notext/63/05.webp)

### 为什么这有效？
面对这种ricochet方法，人们可能会想象，链分析软件会加深他们超过四个跳数的检查。然而，这些平台面临着优化检测阈值的困境。他们必须设定一个跳数限制，超过此限制，他们承认所有权很可能已经发生变更，并且应该忽略与之前事件（如coinjoin）的联系。
![BTC204](assets/en/63/06.webp)

然而，确定这个阈值证明是有风险的：观察到的跳数的每一次扩展都会指数级增加误报的数量，即错误标记为事件参与者的个体，当操作实际上是由其他人执行的。这种情况对这些公司构成了重大风险，因为误报会导致不满，这可能会将受影响的客户推向竞争对手。从长远来看，过宽的检测阈值会导致一个平台比其竞争对手失去更多的客户，这可能会威胁到其生存。因此，对这些平台来说，增加观察到的跳数是复杂的，而4通常是足以对抗他们的分析的。

这里观察到的现象在某种程度上类似于六度分隔理论。

六度分隔理论表明，地球上的任何人都通过不超过六个中间人的熟人链与任何其他人相连。只需通过一系列六个人，每个人都亲自认识下一个人，就足以到达世界上的任何个体。

对于比特币交易，发现了类似的现象。通过追溯足够数量的比特币交易，最终不可避免地会遇到coinjoin。ricochet方法利用了这一原理，使用的跳数高于交易平台可以合理跟踪的数量。如果平台决定跟踪更多交易，那么只需简单地添加一个额外的跳数来规避这一措施。

### 何时以及如何使用ricochet?
对于 ricochet（弹道跳转）的最常见用途是在需要隐藏自己曾经参与过某个 UTXO 上的 coinjoin（混币）活动时。理想情况下，最好避免将经过 coinjoin 处理的比特币转移到受监管的实体。然而，在没有其他选择的情况下，特别是在急需将比特币兑换成法币的紧急情况下，ricochet 提供了一个有效的解决方案。
这种方法不仅对于 coinjoins 有效，对于任何可能损害硬币可替代性的标记也同样有效。
这种 ricochet 方法最初是由 Samourai Wallet 的团队提出的，他们将其集成到他们的应用程序中，以自动化这一过程。在 Samourai 上，使用 ricochet 需要支付服务费，为 100,000 sats，另外还需支付矿工费。因此，这种方法更推荐用于大额转账。

![BTC204](assets/notext/63/07.webp)

Samourai 应用提供了两种 ricochet 方式：
- 增强型 ricochet，或称为“分阶段交付”，它的优势在于将 Samourai 服务费用分散到五个连续的交易中。这个选项还确保每笔交易在不同的时间广播并记录在不同的区块中，这样尽可能地模拟所有权变更的行为。虽然速度较慢，但对于不急于转账的人来说，这种方法更可取，因为它通过增强其对链分析的抵抗力，最大化了 ricochet 的效率；

![BTC204](assets/notext/63/08.webp)

- 经典 ricochet，旨在通过在短时间内广播所有交易来快速执行操作。因此，这种方法提供的隐私性和抵抗分析的能力低于增强方法。它只应用于紧急发送。

![BTC204](assets/notext/63/09.webp)

Ricochet 本质上涉及将比特币发送给自己。完全可以在任何钱包软件上手动执行 ricochet，无需使用专门的工具。只需连续使用新的空白地址将同一硬币转账给自己。

在接下来的章节中，我们将探讨不同的秘密财产转移技术。这些方法与我们迄今为止审查的方法在操作和结果上有着根本的不同。

https://planb.network/tutorials/privacy/ricochet
 
## 秘密财产转移
<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>

在比特币的隐私技术中，还有秘密财产转移的方法。这种方法旨在将比特币的所有权从一个人转移到另一个人，反之亦然，而这笔交易在区块链上不会明显可见。让我们一起研究不同的技术以及它们的优缺点。

### CoinSwap

CoinSwap 基于一个相对简单的概念：它使用智能合约来促进两个用户之间的比特币所有权转移，无需信任，且这种转移在区块链上不会明显可见。

![BTC204](assets/notext/64/01.webp)
让我们想象一个简化的例子，有 Alice 和 Bob。Alice 拥有 1 BTC，用私钥 $A$ 保护，Bob 也拥有 1 BTC，用私钥 $B$ 保护。理论上，他们可以通过外部通信渠道交换他们的私钥来进行秘密转移。
![BTC204](assets/notext/64/02.webp)
然而，这种天真的方法在信任方面存在很高的风险。没有什么能阻止爱丽丝在交换后保留私钥$A$的副本，并在该密钥处于鲍勃手中后使用它来窃取比特币。

![BTC204](assets/notext/64/03.webp)

此外，没有保证可以阻止爱丽丝收到鲍勃的私钥$B$后，不发送她的私钥$A$作为回报。因此，这种交换依赖于双方之间的过度信任，并且在确保安全地秘密转移所有权方面效率低下。

![BTC204](assets/notext/64/04.webp)

为了解决这些问题并允许不信任彼此的双方之间进行交换，我们可以改用智能合约系统。智能合约是一种程序，当预定义的条件满足时自动执行，这在我们的案例中，确保了所有权的交换自动发生，无需相互信任。

为此，我们可以使用HTLC（*哈希时间锁定合约*）或PTLC（*点时间锁定合约*）。这两种协议通过使用时间锁定系统来类似地工作，保证交换要么成功完成，要么完全取消，从而保护双方资金的完整性。HTLC和PTLC之间的主要区别在于HTLC使用哈希和预像来保护交易，而PTLC使用适配器签名。

在使用HTLC或PTLC的coinswap场景中，爱丽丝和鲍勃之间的交换是安全的：要么成功，双方各自收到对方的BTC，要么失败，各自保留自己的BTC。因此，双方中的任何一方都不可能欺骗或窃取对方的BTC。

> *HTLC也是在闪电网络的双向通道中安全路由支付的机制。*

在这种情况下，使用适配器签名特别有趣，因为它允许绕过传统脚本（这是一种有时被称为“_无脚本脚本_”的机制）。这一特性有助于降低与交换相关的费用。适配器签名的另一个主要优势是它们不需要交易双方使用共同的哈希，从而避免在某些类型的交换中揭示它们之间的直接联系。
### 适配器签名

适配器签名是一种加密方法，它将有效签名与额外的签名（称为“_适配器签名_”）结合起来，以揭示一个秘密数据片段。这种机制的设计方式是，如果我们知道以下三个元素中的两个：有效签名、适配器签名和秘密，就可以推断出缺失的第三个元素。这种方法的一个有趣属性是，如果我们知道对方的适配器签名和与用于计算这个适配器签名的秘密相关联的椭圆曲线上的特定点，我们可以推导出自己的适配器签名，这个签名将与同一个秘密兼容，而无需直接访问秘密本身。

在coinswap中，使用适配器签名允许参与者之间同时揭示两个敏感信息，从而避免了对相互信任的需求。让我们以爱丽丝和鲍勃希望交换各自1 BTC的所有权，但彼此不信任为例，来说明这个过程。他们使用适配器签名来消除这种交换中对信任的需求。以下是他们的操作方式：
* Alice通过创建一个交易$m_A$来启动交换，该交易将1 BTC发送给Bob。她使用自己的私钥$p_A$（$P_A = p_A \cdot G$）、一个随机数$n_A$（$N_A = n_A \cdot G$）和一个秘密$t$（$T = t \cdot G$）生成一个签名$s_A$，以验证这笔交易：
$$s_A = n_A + t + H(N_A + T \parallel P_A \parallel m_A) \cdot p_A$$

* Alice通过从她真实的签名$s_A$中减去秘密$t$来计算适配器签名$s_A'$：

$$s_A' = s_A - t$$

* Alice将她的适配器签名$s'_A$、未签名的交易$m_A$、对应于秘密的点（$T$）和对应于随机数的点（$N_A$）发送给Bob。这些元素构成了所谓的“*适配器*”。重要的是要注意，仅凭这些信息，Bob无法恢复Alice的BTC。
* 然而，Bob有能力验证Alice不是在试图从他那里偷窃。为了做到这一点，他检查Alice的适配器签名$s_A'$是否真的对应于提议的交易$m_A$。如果以下等式正确，他就可以确信Alice的适配器签名是有效的：
$$s_A' \cdot G = N_A + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$

* 这种验证为Bob提供了足够的保证，以自信地进行交换。然后，他创建自己的交易$m_B$，意图将1 BTC发送给Alice，并生成他自己的适配器签名$s_B'$，这也将与同一个秘密$t$相关联。此时，只有Alice知道$t$的值；Bob只知道Alice传给他的对应点$T$：

$$s_B' = n_B + H(N_B + T \parallel P_B \parallel m_B) \cdot p_B$$

* Bob将他的适配器签名$s_B'$、未签名的交易$m_B$、以及对应于秘密（$T$）和对应于随机数（$N_B$）的点传输给Alice。Alice，知道秘密$t$，现在可以将Bob的适配器签名$s_B'$与这个秘密结合，为将Bob的BTC转移给她的交易$m_B$生成一个有效的签名$s_B$：

$$s_B = s_B' + t$$

$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \parallel P_B \parallel m_B) \cdot P_B$$

* Alice在比特币区块链上广播这个已签名的交易$m_B$，以恢复Bob承诺的BTC。当Bob在区块链上看到这笔交易时，他可以提取签名$s_B = s_B' + t$。有了这个信息，Bob就能够分离出他所需要的著名的秘密$t$：

$$t = (s_B' + t) - s_B' = s_B - s_B'$$

* 的确，这个秘密$t$是Bob从Alice的适配器签名$s_A'$生成有效签名$s_A$的唯一缺失元素。这个签名允许验证将一个BTC从Alice发送给Bob的交易$m_A$。Bob然后计算$s_A$，反过来在区块链上广播交易$m_A$：

$$s_A = s_A' + t$$
让我们总结一下适配器签名在币币交换中是如何工作的。最初，Alice向Bob发送了一笔未签名的交易以及一个适配器，这允许Bob验证稍后揭示的秘密将使他能够访问比特币。作为回报，Bob向Alice发送他自己的未签名交易和他的适配器。然后，Alice可以通过使用秘密广播有效交易来完成Bob的交易并回收比特币。当这笔交易在区块链上发布时，Bob有能力提取秘密，从而解锁Alice的交易。因此，如果Alice启动了Bob比特币的转移，他反过来可以访问Alice的比特币，而不需要相互信任。
值得注意的是，币币交换最初是由[Gregory Maxwell在2013年10月在BitcoinTalk上提出的](https://bitcointalk.org/index.php?topic=321228.0)。

### 原子交换

与币币交换类似，并使用相同类型的智能合约，也可以执行原子交换。原子交换允许两个用户直接交换不同的加密货币，例如BTC和XMR，无需信任或中介的干预。这些交换被称为“原子”，因为它们只有两种可能的结果：要么交换成功且双方都满意，要么失败且各自保留原来的加密货币，从而消除了对另一方的信任需求。

![BTC204](assets/notext/64/05.webp)

原子交换和币币交换有着类似的操作方式，并在隐私方面提供相同的优势和劣势。实际上，从比特币的角度来看，原子交换可与两步进行的币币交换相比较。首先，我们将我们的BTC换成另一种加密货币，然后这种加密货币可以换成其他BTC。最终，我们回收了另一个用户的BTC。这就是为什么在隐私问题的分析中，我将这两种协议归类为所有权的秘密交换。

![BTC204](assets/notext/64/06.webp)

然而，与币币交换不同的是，原子交换在可用流动性方面可能存在不平衡，特别是在BTC/XMR交换中。通常，将比特币换成山寨币更容易，因为对比特币的高需求保持了这一转换方向的低溢价。然而，将山寨币换成BTC可能会更复杂，因为需求较低，通常会导致非常高的溢价。

最后，当原子交换涉及链上比特币和闪电网络上的比特币时，我们将其称为“*潜艇交换*”。

### 它真的有用吗？
像币币交换和原子交换这样的秘密财产转移具有欺骗链分析启发式方法的优势。这些方法可以给人一种印象，即交易涉及同一用户，尽管实际所有权已经易手。然而，这些方法的主要缺点是，如果不使用额外的技术来打破币的历史，它们将非常有风险。

实际上，当Alice与Bob进行币币交换或原子交换时，她与Bob交换了她的比特币所有权。在原子交换的情况下，交换包括一种山寨币，但原理保持不变。因此，Alice最终得到了币$B$，而Bob得到了币$A$。这在链分析中增加了疑问，但币的历史仍然可以追溯。如果分析师检查币$A$，他们可以追溯到Alice之前的活动，反之亦然对于币$B$。
从爱丽丝的角度来看，风险在于硬币$B$的历史可能被某些实体视为可疑。例如，如果鲍勃通过犯罪行为如黑客攻击获得了硬币$B$，这枚硬币将与他的非法活动保持联系。爱丽丝可能会发现自己拥有一枚她无法在受监管的交易平台上转移的硬币，而不冒着资金被冻结的风险，甚至被指控犯有鲍勃的罪行，尽管她与这些罪行无关。

当然，像coinswap或atomic swap这样的隐私方法受到那些资金受到当局监控的犯罪分子的青睐。这些协议为他们提供了机会，以受监控的比特币交换完全可互换的比特币。这也允许他们制造转移视线，将当局引向其他用户。因此，对这些个体来说，这有着双重用途。

通过coinjoin，即使你的硬币与受监控的比特币混合，硬币的历史也被打断，这提供了一种不存在于像coinswap或atomic swap这样的秘密财产转移协议中的合理否认形式。

如果爱丽丝想要避免任何风险，她必须使用一种打断硬币$B$历史的方法，例如通过coinjoins。这引发了一个关于结合秘密所有权转移和coinjoin的实用性的问题。coinjoin通过打断硬币的历史，已经为爱丽丝提供了足够的隐私级别。因此，我的观点是，如果爱丽丝寻求保护她的隐私，直接进行coinjoin而不是先进行coinswap然后再coinjoin会更为谨慎。为了让秘密所有权转移的方法真正有效并避免将用户$A$的历史与用户$B$联系起来的风险，这些使用方式需要被广泛知晓。如果coinswap被大规模使用并且当局意识到这种常见做法，那么一种合理的否认形式就可以建立。然而，只要这些转移的使用仍然是边缘的，我相信这些方法对用户来说仍然太冒险。

到目前为止，我们主要研究了交易级别本身的隐私方法。在下一章中，我们将探讨网络级别和交易传播的问题。

## P2P网络上的隐私
<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>

在第4部分，我们讨论了使用全节点保护交易隐私的重要性。然而，重要的是要理解，你的节点本身可能会受到试图提取有关你活动的信息的攻击。因此，在本章中，我们将研究不同的隐私保护措施，不是在交易本身或比特币流动的层面，而是在网络层面。

### 蒲公英（Dandelion）

避免各种去匿名化攻击的一种方法是使用Dandelion提议。这种广播协议在BIP156中得到了正式化，但它从未在比特币上实施。

Dandelion的想法是改善比特币网络中交易路由的隐私，以抵御各种形式的攻击。其主要目标是隐藏最初在网络上广播交易的源节点。如果节点在明网上操作，披露这个节点可能会将比特币交易与特定的IP地址联系起来，这可能为链分析提供一个切入点。
将比特币活动与IP地址的关联，对用户隐私构成了重大风险。实际上，许多实体可以轻松地将IP地址与个人身份联系起来。这特别包括政府和互联网服务提供商。此外，这些信息可能变得公开可访问，例如，如果您的IP地址和个人数据因网站数据库被黑而泄露。

在比特币的标准操作中，用户在其钱包软件上构建的交易被传输到他们的个人节点。这个节点立即将新交易广播给它连接的所有对等节点。

![BTC204](assets/notext/65/01.webp)

这些对等节点随后验证交易以确保其符合共识规则和本地标准化规则。一旦验证通过，每个对等节点依次将交易传输给它自己的对等节点，依此类推。

![BTC204](assets/notext/65/02.webp)

交易待整合进区块的分布是相当平衡且统计上可预测的。这种漏洞可以被串通的间谍节点所利用，这些节点合作监视和分析网络，以识别首个广播交易的节点。如果观察者设法定位到源节点，他们可以假设交易起源于该节点的操作者。这种类型的观察可以将通常匿名的交易与特定的IP地址联系起来。

![BTC204](assets/notext/65/03.webp)

BIP156的目标是解决这个问题。为此，它在新交易的广播中引入了一个额外的阶段，以在广泛的公共传播之前保持匿名。蒲公英首先使用一个“茎”阶段，其中交易通过节点的随机路径发送。

![BTC204](assets/notext/65/04.webp)

然后在“绒球”阶段将交易广播到整个网络。

![BTC204](assets/notext/65/05.webp)

茎和绒球是对交易通过网络传播行为的引用，类似于蒲公英的形状。

因此，间谍节点可能能够追踪到启动绒球阶段（大规模广播）的节点，但这个节点不是首个广播交易的节点，因为它是从茎的最后一个节点接收到交易的。如果间谍节点不能追溯到茎的上游，他们也无法识别源节点。

![BTC204](assets/notext/65/06.webp)
即使在茎阶段存在间谍节点，也总是存在疑问，因为一旦他们在扩散图中遇到一个诚实节点，间谍就无法确定这个节点是原始源还是仅仅是一个中介。
![BTC204](assets/notext/65/07.webp)

这种路由方法模糊了通往源节点的路径，使得通过网络追踪交易回到其起源变得困难。蒲公英因此通过限制敌手去匿名化网络的能力来提高隐私。当交易在“茎”阶段穿越一个加密其网络通信的节点时，这种方法更为有效，如使用Tor或P2P Transport V2。
BIP156尚未整合进比特币核心(Bitcoin Core)，目前被归类为“已拒绝”状态。关于这一协议的主要担忧之一在于，在茎阶段(stem phase)，交易必须由中间节点转发后才能被验证。正如我们所见，在比特币的常规模型中，每个节点首先验证交易，然后再将其广播给同伴节点。如果交易不符合共识规则或节点的本地标准化规则，它将忽略并不广播该交易。这一过程对于抵御DoS攻击至关重要，因为只有有效的交易才会被广播到整个网络。可能被大量生成以重载网络的无效交易，在遇到的第一个节点处就会被停止，不会传播。蒲公英(Dandelion)的主要风险在于，这一新协议可能通过允许通过网络的一部分广播无效交易，引入了DoS攻击的新途径。

### P2P传输V2

P2P传输V2是在BIP324中提出的另一种网络协议。它是比特币P2P传输协议的新版本，加入了机会性加密(opportunistic encryption)以提高节点间通信的保密性和安全性。

这一改进旨在解决P2P协议基础版本的几个问题。一方面，它使交换的数据对被动观察者而言与互联网上流通的其他类型数据无法区分。主要目标是防止政府、互联网服务提供商或VPN提供商大规模监控比特币用户。这也使这些实体更难确定一个互联网用户是否也是比特币用户，即他们是否在运行一个完整节点。
P2P V2还有助于通过检测数据包中的特定模式，减少审查和攻击的风险。它使执行各种类型的Sybil攻击在网络层面变得更加复杂和成本更高。Sybil攻击发生在一个行为体创建多个虚假身份以获得不正当优势时。在比特币网络的背景下，这通常表现为一个行为体控制大量的完整节点，并积极使用它们来增加连接。Sybil攻击可以是被动的，旨在收集信息和妥协用户的保密性，或者是主动的，以Eclipse攻击的形式出现。后者将特定节点从网络的其余部分隔离开来，允许审查用户或改变他们接收的数据。最后，P2P V2也使得*中间人攻击*(MITM)更加昂贵和易于检测。
P2P V2实施的加密不包括认证，以免增加不必要的复杂性，并且不妨碍网络连接的无需许可性。这种新的P2P传输协议尽管提供了更好的抵御被动攻击的安全性，并且使主动攻击显著更加昂贵和可检测。在网络消息中引入伪随机数据流，使得希望审查或操纵通信的攻击者的任务变得复杂。

P2P V2传输作为一个选项（默认禁用）被包含在2023年12月部署的比特币核心版本26.0中。然后在2024年4月的版本27.0中默认启用。它可以通过配置文件中的`v2transport=`选项进行修改。

### Tor

另一个相对简单的解决方案，用于避免节点在网络层面上丢失保密性的风险，是完全在Tor下运行它。
Tor是一个由中继服务器（节点）组成的网络，它可以匿名化互联网上TCP连接的来源。它通过将数据封装在多层加密中来工作。每个中继节点移除一层以揭示下一个节点的地址，直到到达最终目的地。Tor网络通过防止中间节点同时知道数据的来源和目的地来确保匿名性，这使得观察者很难追踪用户的活动。
![BTC204](assets/notext/65/08.webp)
因此，Tor不仅加密了通信数据，还允许掩盖通信的起源和目的地。通过使用Tor进行个人节点的通信，我们增强了交易的隐私性：互联网服务提供商（ISP）无法解密通信，比特币网络中的其他节点无法识别源节点的IP地址。此外，Tor还隐藏了您对比特币的使用，使您的ISP无法知晓。

与这种方法相关的主要风险是，Tor是一个独立于比特币的协议。如果您在Tor下有一个比特币节点，而Tor停止工作，那么您的比特币节点将无法再进行通信。

此外，值得注意的是，Tor上的通信速度较慢。这种延迟在节点初次启动时尤其令人烦恼，因为初始块下载（IBD）需要大量通信。因此，使用Tor进行的比特币网络的初始同步可能会明显变长。也可以在明网上执行IBD，然后再激活Tor。尽管这种方法会向您的ISP透露您的比特币节点的存在，但一旦切换到Tor，就可以保护与您个人交易相关的信息。

在探索了不同的网络级隐私方法后，我还想在接下来的章节中介绍两种避免地址重用的优雅解决方案：BIP47和静默支付。

## BIP47和可重用支付代码
<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>

正如我们在第3部分看到的，地址重用对比特币协议上的用户隐私构成了严重的障碍。为了降低这些风险，强烈建议为钱包中收到的每笔新支付生成一个新的接收地址。尽管今天通过使用现代软件和分层确定性钱包，生成新地址已经简化，但这种做法可能看起来违反直觉。

![BTC204](assets/notext/66/1.webp)

例如，在传统银行系统中，我们习惯于分享我们的IBAN，它始终保持不变。一旦与某人沟通，他们可以在不再与我们互动的情况下向我们发送多次支付。新银行还提供了更现代的可能性，如在PayPal上使用独特的电子邮件地址或在Revolut上使用RevTags。即使在金融领域之外，我们的日常标识符，如我们的邮政地址、电话号码和电子邮件地址，也是独一无二且永久的。我们不必在每次新的互动中更新它们。

![BTC204](assets/notext/66/2.webp)
然而，比特币的运作方式不同：对于每笔进账交易，生成一个新的接收地址是必须的。这种易用性与隐私之间的折衷可以追溯到比特币白皮书的最初起源。自2008年底第一个版本的文档发布以来，中本聪就已经警告我们这个风险：
**“*作为一个额外的防火墙，每笔交易都可以使用一对新的密钥，以保持它们不与一个共同的所有者关联。*”**
接收多笔支付到单一标识符而不引起地址重用有许多方法。每种方法都有其自身的妥协和缺点。其中一种方法是BIP47，这是由Justus Ranvier开发并于2015年发布的提案。该提案旨在创建可重用的支付代码，允许向同一人进行多次交易同时避免地址重用。本质上，BIP47旨在提供一个像唯一标识符一样直观的支付系统，同时保留交易的隐私性。
![BTC204](assets/notext/66/3.webp)

BIP47并不直接提高用户隐私，因为BIP47支付提供的隐私级别与使用新地址的经典比特币交易相同。然而，它使比特币的使用更加方便直观，这种便利性通常应该会损害隐私。多亏了BIP47，这种易用性达到了与经典交易相同的隐私级别。这就是为什么BIP47是保护隐私的有价值工具。

最初，BIP47是一个提议，旨在集成到比特币核心中，但它从未被采纳。一些软件仍然选择在应用程序级别自行实现它。因此，Samourai Wallet的团队开发了他们自己的BIP47实现，名为"PayNym"。

### BIP47和PayNym的一般原则

BIP47的目标是允许接收多笔支付而不引起地址重用。它依赖于使用可重用的支付代码，该代码允许不同的发送者向属于另一用户的单一代码发送多次支付。因此，接收者不必为每笔交易提供一个新的新鲜地址，这极大地方便了他们的交换同时保护了他们的隐私。

![BTC204](assets/en/66/4.webp)

用户因此可以自由分享他们的支付代码，无论是在社交网络上还是在他们的网站上，而不会像使用经典接收地址或公钥那样冒失去隐私的风险。
要进行交易，双方必须拥有一个实现了BIP47的比特币钱包，例如Samourai Wallet或Sparrow Wallet上的PayNym。他们的支付代码的共同使用在他们之间创建了一个秘密通道。为了有效地建立这个通道，发送者必须在比特币区块链上执行一个特定的交易，称为“通知交易”（稍后我会给你更多细节）。

两个用户的支付代码的组合生成共享秘密，这反过来允许创建大量唯一的比特币接收地址（准确地说是2^32个，或大约40亿个）。因此，通过BIP47进行的支付实际上并不是直接发送到支付代码本身，而是发送到从涉及用户的支付代码派生的经典接收地址。

支付代码因此充当从钱包的种子派生的虚拟标识符。在钱包的层次化派生结构中，支付代码位于第3级，即账户级别。

![BTC204](assets/en/66/5.webp)

BIP47的派生目标由索引`47'`（`0x8000002F`）标识，指的是BIP47。一个可重用支付代码的派生路径示例如下：
```plaintext
m/47'/0'/0'/
```

为了给你一个支付代码长什么样的概念，这是我的：
```plaintext
这段代码也可以编码成二维码，以便于传播，就像一个经典的接收地址一样。

关于PayNym机器人，这些有时在Twitter上看到的机器人，它们是由Samourai Wallet创建的支付代码的视觉表现。它们通过哈希函数生成，这使得它们几乎是唯一的。它们以`+`开头的一小串字符形式出现：
```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

这些头像也可以以图像的形式表示：

![BTC204](assets/notext/66/6.webp)

尽管这些机器人在BIP47框架内没有特定的技术功能，但它们通过提供易于识别的视觉身份，在促进用户之间的互动中发挥作用。
在本章接下来关于BIP47的部分，我们将详细检查其工作原理，特别强调所使用的加密方法。要完全理解这些有些技术性的解释，首先了解HD钱包的结构、密钥派生过程以及基于椭圆曲线的加密基本原则是必要的。如果您希望深入了解这些概念，PlanB网络上还提供了另一门免费课程：[CRYPTO 301](https://planb.network/en/courses/crypto301)。我仍然建议您跟随它们，因为理解BIP47的技术工作原理将使您更容易理解我们将在接下来的章节中讨论的其他类似提议。
### 可重用支付代码

如前所述，可重用支付代码位于HD钱包的第3层，使其与`xpub`相当，无论是在钱包结构中的位置还是在其角色上。

80字节的支付代码分解如下：
- **字节`0`：版本**。对于BIP47的第一个版本，此字节设置为`0x01`；
- **字节`1`：位字段**。这个空间保留用于在特定用途中集成额外的指示。对于与PayNym的标准使用，此字节定义为`0x00`；
- **字节`2`：`y`奇偶性**。这个字节是`0x02`或`0x03`，表示公钥的纵坐标是偶数还是奇数，因为使用了压缩公钥；
- **从字节`3`到字节`34`：`x`值**。这些字节代表公钥的横坐标。`x`值和`y`奇偶性的连接形成完整的压缩公钥；
- **从字节`35`到字节`66`：链码**。这个空间包含与公钥相关的链码；
- **从字节`67`到字节`79`：填充**。这个空间用于可能的未来发展。对于当前版本，简单地放置零以达到`OP_RETURN`输出所需的80字节大小。

这是我在前一节中已经介绍的可重用支付代码的十六进制表示：
首先，需要在开头添加前缀字节`P`，以明确表示这是一个支付代码。这个字节由`0x47`表示：
```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

最后，为了确保支付代码的完整性，使用`HASH256`进行校验和计算，这包括使用`SHA256`函数进行两次哈希。然后将这个哈希的前四个字节连接到支付代码的末尾：
```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

完成这些步骤后，支付代码就准备好了。剩下的只是将其转换为base 58，以获得其最终版本：
```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

在这个支付代码创建过程中，我们使用了一个压缩的公钥和一个链码。这两者都是从钱包的种子通过确定性和层次化的派生得到的。用于实现这一点的派生路径是：
```plaintext
m/47'/0'/0'/
```
为了生成可重用支付代码的压缩公钥和相关链码，我们首先从钱包的种子计算出主私钥。然后我们继续使用索引`47 + 2^31`（强化派生）派生一对子密钥。这一步之后，还有两次使用索引`2^31`（强化派生）的子对派生。

### 椭圆曲线Diffie-Hellman（ECDH）密钥交换
BIP47协议核心的加密协议被称为ECDH，即*椭圆曲线Diffie-Hellman*。这种方法是原始Diffie-Hellman密钥交换的一个变种。
Diffie-Hellman密钥协议于1976年引入，它是一种密钥协议，允许两个各自拥有一对密钥（公钥和私钥）的方，即使仅通过公共且不安全的通道通信，也能就一个共同的秘密达成一致。

![BTC204](assets/en/66/10.webp)

这个共同的秘密（这里是蓝色的钥匙），随后可以用于其他操作。通常，这个共享的秘密可以用来加密和解密在不安全网络上的通信：

![BTC204](assets/notext/66/11.webp)

为了实现这种交换，Diffie-Hellman使用模运算来计算共享的秘密。这里是一个简化的解释说明它是如何工作的：
- Alice和Bob同意一个共同的颜色，这里是黄色，这构成了公共数据（攻击者知道这个颜色）；
- Alice选择一个秘密颜色，这里是红色，并将两者混合以获得橙色；
- Bob也选择一个秘密颜色，这里是蓝色，并将其与黄色混合以获得绿色；
- 然后他们交换获得的颜色，橙色和绿色。这种交换可以在一个不安全且被观察的网络上进行；
- 通过将Bob的绿色与她自己的秘密颜色混合，Alice产生了棕色；
- Bob做同样的事情，将Alice的橙色和他的秘密蓝色混合，也获得了棕色。

![BTC204](assets/en/66/12.webp)

在这个简化中，棕色代表Alice和Bob之间的共享秘密。重要的是要理解，在现实中，攻击者不可能将橙色和绿色分开来发现Alice或Bob的秘密颜色。

现在，让我们来看看这个协议实际是如何工作的，不是用颜色类比，而是使用真实的数字和模运算！
在讨论Diffie-Hellman机制之前，让我简要提醒您我们将需要的两个基本数学概念：

- **质数**是只有两个除数的自然数：$1$和它本身。例如，$7$是一个质数，因为它只能被$1$和$7$整除。另一方面，$8$不是质数，因为它可以被$1$、$2$、$4$和$8$整除。因此，它有四个正整数除数，而不是两个；
- **模运算**（表示为$mod$或$\%$）是一种数学运算，它在两个整数之间返回第一个数除以第二个数的欧几里得除法的余数。例如，$16 \bmod 5 = 1$。

**Alice和Bob之间的Diffie-Hellman密钥交换如下进行：**

- Alice和Bob同意两个共同的数字：$p$和$g$。$p$是一个质数，这个数字越大，Diffie-Hellman就越安全。$g$是$p$的原根。这两个数字可以通过一个不安全的网络公开通信。它们代表了前面简化中的**黄色**。因此，Alice和Bob使用$p$和$g$的确切相同的值是非常重要的。
- 一旦这些参数被定义，Alice和Bob各自选择一个秘密的随机数。Alice将她的秘密随机数命名为$a$（相当于**红色**），Bob将他的命名为$b$（相当于**蓝色**）。这些数字必须严格保密。
- 代替直接交换数字$a$和$b$，双方各自计算$A$和$B$如下：

$A$等于$g$的$a$次方对$p$取模：

$$
A = g^a \bmod p
$$

$B$等于$g$的$b$次方对$p$取模：

$$
B = g^b \bmod p
$$

- 数值$A$（相当于**橙色**）和$B$（相当于**绿色**）在两方之间交换。这种交换可以公开地在一个不安全的网络上进行；

- Alice收到$B$后，按照以下方式计算$z$的值：

$z$等于$B$的$a$次方对$p$取模：

$$
z = B^a \bmod p
$$

回顾一下：

$$
B = g^b \bmod p
$$

因此，我们得到：

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

应用指数规则：
$$
(x^n)^m = x^{nm}
$$

然后我们得到：

$$
z = g^{ba} \bmod p
$$

- 在他方面，Bob收到$A$后，也以以下方式计算$z$的值：

$z$等于$A$的$b$次方对$p$取模：

$$
z = A^b \bmod p
$$

因此，我们得到：

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

由于模运算的分配性，Alice和Bob得到完全相同的值$z$。这个数字代表他们的共同秘密，相当于之前用颜料罐简化的**棕色**。他们现在可以使用这个共同的秘密对他们在不安全网络上的通信进行对称加密。

![BTC204](assets/notext/66/13.webp)

即使攻击者拥有$p$、$g$、$A$和$B$（公开值），也无法计算$a$、$b$或$z$（私有值）。要做到这一点，需要逆转指数运算，这是一个不可能的操作，除非逐一尝试所有可能性，因为它相当于计算离散对数，即在有限循环群中指数的逆。

因此，只要$a$、$b$和$p$的值足够大，Diffie-Hellman协议就是安全的。通常，对于2048位参数（十进制中有600位数字），测试所有可能的$a$和$b$将是不切实际的。直到今天，对于这样的数字，这个算法被认为是安全的。
这正是Diffie-Hellman协议的主要缺点所在。为了保证安全，算法必须使用大数字。这就是为什么如今更倾向于使用ECDH算法（*椭圆曲线Diffie-Hellman*），一种依赖于代数曲线，更准确地说是椭圆曲线的Diffie-Hellman变体。这种方法允许在保持等效安全性的同时使用更小的数字，从而减少了计算和存储所需的资源。
算法的总体原理保持不变。然而，我们使用的不是通过模幂运算从随机数$a$计算得到的数$A$，而是建立在椭圆曲线上的一对密钥。我们不依赖模运算符的分配律，而是使用椭圆曲线上的群律，更具体地说是这一律的结合律。
简要解释椭圆曲线密码学的原理，私钥由$1$到$n-1$之间的随机数表示，其中$n$代表曲线的阶。另一方面，公钥是此曲线上的一个特定点，通过从生成点开始，根据方程进行点加和加倍操作，从私钥获得：
$$
K = k \cdot G
$$

在此公式中，$K$表示公钥，$k$表示私钥，$G$表示生成点。

这些密钥的一个基本特征是，从$k$和$G$计算$K$很容易，而从$K$和$G$找到$k$几乎是不可能的。这种不对称性创造了一个单向函数。换句话说，如果知道私钥，计算公钥很容易，但从公钥找到私钥是不可能的。这种安全性仍然基于离散对数的计算难度。

我们将利用这一属性来调整我们的Diffie-Hellman算法。**ECDH的操作原理如下：**

- Alice和Bob一起同意一个密码学上安全的椭圆曲线及其参数。这些信息是公开的；

- Alice生成一个随机数$ka$，这将是她的私钥。这个私钥必须保密。她通过在选定的椭圆曲线上进行点加和加倍来确定她的公钥$Ka$：

$$
K_a = k_a \cdot G
$$

- Bob也生成一个随机数$kb$，这将是他的私钥。他计算关联的公钥$Kb$：

$$
K_b = k_b \cdot G
$$

- Alice和Bob通过一个不安全的公共网络交换他们的公钥$Ka$和$Kb$。

- Alice通过将她的私钥$ka$应用于Bob的公钥$Kb$来计算曲线上的一个点$(x,y)$：

$$
(x,y) = k_a \cdot K_b
$$

- Bob通过将他的私钥$kb$应用于Alice的公钥$Ka$来计算曲线上的一个点$(x,y)$：

$$
(x,y) = k_b \cdot K_a
$$

- Alice和Bob在椭圆曲线上获得相同的点。共享的秘密将是这个点的x坐标$x$。

他们确实获得了相同的共享秘密，因为：
(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a$$
在未加密的公共网络中观察的攻击者只能获得各方的公钥和所选椭圆曲线的参数。如前所述，仅凭这些信息不足以确定私钥。因此，攻击者无法找到Alice和Bob之间的共享秘密。

因此，ECDH是一个允许密钥交换的算法。它经常与其他加密方法结合使用，以建立完整的协议。例如，ECDH被集成到TLS（*传输层安全性*）的核心中，TLS是用于互联网传输层的加密和认证协议。TLS使用ECDHE进行密钥交换，ECDHE是ECDH的一个变体，其中的密钥是临时的，以提供持久的保密性。此外，TLS使用诸如ECDSA的认证算法，如AES的加密算法，以及如SHA256的哈希函数。

TLS特别负责`https`中的`s`以及您浏览器地址栏中可见的锁形符号，这些都是加密通信的象征。通过遵循这个课程，您因此正在使用ECDH，而且很可能您每天都在使用它，即使您不知道。

### 通知交易

正如我们在前一节中看到的，ECDH是使用在椭圆曲线上建立的密钥对的Diffie-Hellman交换的变体。方便的是，我们的比特币钱包中已经拥有许多遵循这一标准的密钥对！BIP47的想法是使用双方的比特币确定性层次钱包中的密钥对之间建立共享和临时秘密。在BIP47的上下文中，使用ECDHE（*椭圆曲线Diffie-Hellman临时*）代替。

![BTC204](assets/notext/66/14.webp)

ECDHE在BIP47中首次用于将支付代码从发送方传输给接收方。这就是著名的**通知交易**。这一步骤是必要的，因为为了让BIP47有效工作，涉及的双方（发送方和接收方）必须知道对方的支付代码。这一知识允许派生临时公钥，进而关联空白接收地址。
在这次交换之前，发送方逻辑上已经知道接收方的支付代码，因为他们已经通过线下方式获得了它，例如，从他们的网站、发票或社交媒体上。然而，接收方可能不一定知道发送方的支付代码。然而，这个代码必须传输给他们；否则，他们将无法派生识别存储其比特币的地址所需的临时密钥，也无法访问他们的资金。尽管技术上可以通过其他通信方式线下传输发送方的代码，但如果只能从种子恢复钱包，这就会构成问题。
确实，与传统地址不同，BIP47地址不是直接从接收者的种子中派生出来的——在这种情况下使用`xpub`会更简单——而是由发送者和接收者的支付代码的计算组合结果。因此，如果接收者丢失了他们的钱包并尝试从他们的种子中恢复它，他们将恢复他们自己的支付代码，这是直接从他们的种子派生的。然而，要找到临时地址，对他们来说也必须拥有通过BIP47向他们发送比特币的每个人的支付代码。因此，通知交易的重要性在于，它允许在比特币区块链上保存这些信息，同时能够非常容易地找到它，而不必搜索自2009年启动以来执行的十亿笔交易。
![BTC204](assets/en/66/15.webp)

因此，如果每个用户保留他们同伴的支付代码的备份，就有可能实施BIP47而不需要通知交易。然而，只要没有开发出一种简单、稳健和高效的创建、存储和更新这些备份的解决方案，这种方法就难以管理。在当前情况下，通知交易几乎变得不可或缺。

在接下来的章节中，我们将研究与BIP47目标相似但不需要通知交易的其他协议。然而，这些替代方案引入了它们自己的妥协。

除了在备份支付代码方面的作用外，通知交易还为接收者提供了通知功能，正如其名称所示。它向接收者的客户端发出信号，表明已经建立了一个新的支付通道，因此建议监控产生的临时地址。

### BIP47的隐私模型

在详细讨论通知交易的技术操作之前，讨论与BIP47相关的隐私模型很重要，这为创建这个初始交易期间采取的某些措施提供了理由。
支付代码本身并不直接对隐私构成风险。与传统的比特币模型不同，后者旨在通过保护密钥和地址的匿名性来打破用户身份与他们的交易（这些交易是公开的）之间的联系，支付代码可以公开与一个身份关联而不构成威胁。
实际上，支付代码不用于直接派生接收BIP47支付的地址。这些地址是通过将两个参与方的支付代码派生的密钥之间应用ECDH生成的。

因此，支付代码本身并不直接导致隐私损失，因为只有通知地址是从中派生的。尽管这个地址可以透露一些信息，但通常不允许发现您正在进行交易的双方，除非通过彻底的链分析。实际上，如果发送者使用可以与他们的身份链接的UTXOs来执行通知交易，那么就有可能推断出他们的身份可能与向您的支付代码的BIP47支付有关。这不会揭示底层交易，但会表明它们可能的存在。

因此，保持用户支付代码之间这种严格的分离至关重要。为了实现这一目标，代码的初始通信步骤是支付隐私的关键时刻，但对协议的正确运行是必需的。如果其中一个支付代码可以公开获得（例如在网站上），那么第二个代码，即发送者的代码，绝不能以任何方式与第一个代码链接。

让我们举一个具体的例子：我想通过BIP47向一个政治运动捐款：
- 该组织在其网站或通过其社交网络公开了其支付代码；
- 这段代码因此与政治运动有关；
- 我检索这个支付代码；
- 在进行发送之前，我必须确保他们知道我的支付代码，这个代码也与我的身份相关联，因为我用它在我的社交网络上接收交易。

如何无风险地传输我的代码？使用常规通信手段可能会导致信息泄露，因此，可能会将我与这个政治运动联系起来。通知交易提供了一个解决方案，感谢加密层，它精确地防止了两个代码之间的关联。虽然这不是秘密传输发件人支付代码的唯一方法，但它被证明非常有效。

在下面的图表中，橙色线条指示信息流必须中断的点，黑色箭头显示可能被第三方观察到的连接：
![BTC204](assets/en/66/16.webp)
实际上，在比特币的传统隐私模型中，完全分离密钥对与用户之间的信息流通常很复杂，尤其是在远程交易期间。例如，在捐赠活动的背景下，接收者必须通过他们的网站或社交网络不可避免地公开一个地址或公钥。正确使用BIP47，特别是通过通知交易，得益于ECDHE和我们将进一步研究的加密层，可以规避这个问题。

当然，比特币的经典隐私模型仍然适用于从两个支付代码的组合派生的临时公钥。这两种模型实际上是互补的。我在这里想强调的是，与通常使用公钥接收比特币相反，支付代码可以与特定身份关联，因为信息“_Alice与Bob进行交易_”在另一个阶段被打破。支付代码用于生成支付地址，但仅基于对区块链的观察，除非涉及的UTXOs之前已经与某个身份关联，并且用户已将他们的支付代码与各自的身份关联，否则不可能将BIP47支付交易链接到用于执行它的支付代码。

总结来说，BIP47支付提供的隐私模型可以被认为是优于比特币基础的，尽管它绝非神奇。

### 通知交易的构建

现在，让我们看看这个通知交易是如何工作的。想象Alice想要通过BIP47向Bob发送资金。在我的例子中，Alice作为发送者，Bob作为接收者。后者已经在他的网站上发布了他的支付代码。因此，Alice已经知道Bob的支付代码。

**1- Alice通过ECDH计算一个共享密钥：**

- 她从位于与她的支付代码不同分支的HD钱包中选择一对密钥。注意，这对密钥不应该容易与Alice的通知地址或Alice的身份关联（见前一节）；

- Alice选择这对密钥中的私钥。我们称之为$a$（小写）；

$$
a
$$
- Alice检索与Bob的通知地址关联的公钥。这个公钥是从Bob的支付代码派生的第一个子公钥（索引$/0$）。我们称这个公钥为$B$（大写）。与这个公钥关联的私钥称为$b$（小写）。$B$是通过在椭圆曲线上用$b$（私钥）进行加法和倍点运算得到的：
$$ B = b \cdot G $$
- 爱丽丝通过使用她的私钥$a$对鲍勃的公钥$B$进行点加和点倍运算，在椭圆曲线上计算出一个秘密点$S$（大写）。
$$ S = a \cdot B $$

- 爱丽丝计算盲化因子$f$，这将允许她加密她的支付码。为此，她将使用HMAC-SHA512函数确定一个伪随机数。在这个函数的第二个输入中，她使用一个只有鲍勃能够检索的值：$x$，这是之前计算的秘密点的横坐标。第一个输入是$o$，这是这笔交易输入中消耗的UTXO（输出点）。

$$ f = \text{HMAC-SHA512}(o, x) $$

**2- 爱丽丝将她的个人支付码转换成二进制形式（base 2）。**

**3- 她使用这个盲化因子作为密钥对她支付码的有效载荷进行对称加密。**使用的加密算法是简单的`XOR`。执行的操作类似于Vernam密码，也称为“一次性密码本”。

- 爱丽丝首先将她的盲化因子分成两部分：前32字节命名为$f1$，后32字节命名为$f2$。因此，我们有：

$$ f = f1 || f2 $$

- 爱丽丝分别计算她的支付码公钥横坐标$x$的加密值$x'$和她的链码$c$的加密值$c'$。$f1$和$f2$分别作为加密密钥。使用的操作是`XOR`（异或）。

$$ x' = x \oplus f1 $$
$$ c' = c \oplus f2 $$

- 爱丽丝用加密后的值$x'$和$c'$替换她支付码中公钥横坐标$x$和链码$c$的真实值。
**4-** 爱丽丝目前拥有一个带有加密有效载荷的支付码。她将构建并广播一个交易，该交易以她的公钥$A$作为输入，一个输出到鲍勃的通知地址，以及一个包含她带有加密有效载荷的支付码的`OP_RETURN`输出。**这笔交易是通知交易**。
`OP_RETURN`是一个操作码，标记比特币交易输出为无效。如今，它被用来在比特币区块链上广播或锚定信息。最多可以存储80字节的数据，这些数据被写入链上，因此对所有其他用户可见。

正如我们在前面的部分中看到的，ECDH被用来在不安全的网络上通信的两个用户之间生成一个共享秘密，这个网络可能被攻击者观察。在BIP47中，ECDH被用于在比特币网络上通信，这本质上是一个被许多攻击者观察的透明通信网络。通过ECDH密钥交换计算出的共享秘密随后被用来加密要传输的秘密信息：发送者（爱丽丝的）支付码。

让我们回顾一下我们刚刚一起审查的执行通知交易的步骤：
- 爱丽丝检索鲍勃的支付码和通知地址；
- 爱丽丝在她的HD钱包中选择一个她拥有的UTXO及相应的密钥对；
- 她使用ECDH在椭圆曲线上计算一个秘密点；
- 她使用这个秘密点来计算一个HMAC，这是盲化因子；
- 她使用这个盲化因子来加密她个人支付码的有效载荷；
- 她使用一个`OP_RETURN`交易输出来向Bob传达遮蔽的支付代码。
![BTC204](assets/en/66/17.webp)

### 通知交易：具体研究

为了更详细地理解其功能，特别是`OP_RETURN`的使用，让我们一起来研究一个真实的通知交易。我在测试网上执行了这样一个交易，你可以[点击这里](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e)找到它。

![BTC204](assets/notext/66/18.webp)

观察这笔交易，我们可以看到它有一个输入和4个输出：
- 第一个输出是包含我的遮蔽支付代码的`OP_RETURN`；
- 第二个输出546 sats指向我的接收者的通知地址；
- 第三个输出15,000 sats代表服务费，因为我使用Samourai Wallet来构建这笔交易；
- 第四个输出2百万sats代表找零，意味着从我的输入中剩余的差额返回到另一个属于我的地址。
最值得研究的显然是使用`OP_RETURN`的输出0。让我们更仔细地看看它包含了什么。这里是十六进制的`scriptPubKey`：

```text
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

在这个脚本中，我们可以分解几个部分。首先是操作码：

```text
6a4c
```

在操作码中，我们可以识别`0x6a`，它指的是`OP_RETURN`，和`0x4c`，它指的是`OP_PUSHDATA1`。

这个操作码后面的字节指示了随后的有效载荷的大小。它指示的是`0x50`，或80字节：

```text
6a4c50
```

然后，我们有我的支付代码的元数据，以明文形式：

```text
010002
```

我的支付代码的公钥的加密x坐标：

```text
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

我的支付代码的加密链代码：

```text
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

最后，填充到80字节，`OP_RETURN`的标准大小：

```text
00000000000000000000000000
```

为了更好地理解，这里是我的支付代码的明文，以base 58表示：

```text
在前面的部分中，我们看到支付代码是使用XOR操作加密传输的。让我们花点时间来理解这个操作符是如何工作的，因为它在密码学中被广泛使用。

XOR是基于布尔代数的位逻辑操作符。对于两个位操作数，如果同等级的位不同，则返回`1`；如果同等级的位相同，则返回`0`。这是基于操作数值`D`和`E`的XOR真值表：

| D   | E   | D XOR E |
| --- | --- | ------- |
| 0   | 0   | 0       |
| 0   | 1   | 1       |
| 1   | 0   | 1       |
| 1   | 1   | 0       |

例如：

$$
0110 \oplus 1110 = 1000
$$

或者：

$$
010011 \oplus 110110 = 100101
$$

使用ECDH时，将XOR作为加密层尤其合适。首先，由于这个操作符，加密是对称的。这允许接收者使用用于加密的相同密钥来解密支付代码。加密和解密密钥是通过ECDH计算出的共享秘密得到的。这种对称性是由XOR操作符的交换律和结合律属性实现的：

- 其他属性：

$$
D \oplus D = 0
$$
D ⊕ 0 = D
- 交换律：

$$
D \oplus E = E \oplus D
$$

- 结合律：

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
$$

如果：

$$
D \oplus E = L
$$

那么：

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
$$

接下来，这种加密方法与Vernam密码（一次性密码本）非常相似，这是迄今为止唯一已知具有无条件（或绝对）安全性的加密算法。为了使Vernam密码具有这种特性，加密密钥必须完全随机，它的大小必须与消息相同，并且只能使用一次。在这里用于BIP47的加密方法中，密钥确实与消息大小相同，盲化因子的大小完全与公钥的x坐标与支付代码的链代码的连接相同。这个加密密钥确实只使用一次。然而，这个密钥不是完美随机的结果，因为它是一个HMAC。它相当于伪随机。因此，它不是Vernam密码，但方法是相似的。

### 接收通知交易

现在Alice已经向Bob发送了通知交易，让我们看看他是如何解读它的。提醒一下，Bob必须能够访问Alice的支付代码。如果没有这个信息，正如我们在下一节将看到的，他将无法推导出Alice创建的密钥对，因此，他将无法访问通过BIP47收到的比特币。目前，Alice的支付代码的有效载荷是加密的。让我们看看Bob是如何解密它的。

**1-** Bob监控创建输出到他的通知地址的交易。

**2-** 当一个交易在他的通知地址上有输出时，Bob分析它，看它是否包含一个遵循BIP47标准的OP_RETURN输出。

**3-** 如果OP_RETURN有效载荷的第一个字节是`0x01`，Bob开始寻找可能的共享秘密，使用ECDH：
- Bob选择交易输入中的公钥。即，Alice的公钥命名为$A$：

$$ A = a \cdot G $$

- Bob选择与他的个人通知地址相关联的私钥$b$：

$$ b $$
- Bob通过将他的私钥$b$应用于Alice的公钥$A$，在椭圆曲线上计算秘密点$S$（共享的ECDH秘密），通过加点和倍点来实现：
$$ S = b \cdot A $$

- Bob确定将允许他解密Alice支付代码有效载荷的盲化因子$f$。与Alice之前计算的方式相同，Bob将通过对秘密点$S$的x坐标$x$，以及在此通知交易中作为输入消耗的UTXO$o$，应用HMAC-SHA512来找到$f$：

$$ f = \text{HMAC-SHA512}(o, x) $$

**4-** Bob将通知交易中的OP_RETURN数据解释为一个支付代码。他将简单地使用盲化因子$f$解密这个潜在支付代码的有效载荷：
- 鲍勃将盲因子 $f$ 分为两部分：$f$ 的前32字节将是 $f1$，后32字节将是 $f2$；
- 鲍勃解密来自爱丽丝支付码的加密x坐标 $x'$：

$$ x = x' \oplus f1 $$

- 鲍勃解密来自爱丽丝支付码的加密链码值 $c'$：

$$ c = c' \oplus f2 $$

**5-** 鲍勃检查爱丽丝支付码中的公钥值是否确实属于 secp256k1 群。如果是这样，他将其解释为有效的支付码。否则，他将忽略此交易。

现在鲍勃知道了爱丽丝的支付码，她可以向他发送多达 `2^32` 次支付，而无需再次进行此类通知交易。

为什么这能工作？鲍勃如何能够确定与爱丽丝相同的盲因子，从而解密她的支付码？让我们更仔细地看看我们刚刚描述的 ECDH 的作用。

首先，我们正在处理对称加密。这意味着加密密钥和解密密钥是相同的值。通知交易中的这个密钥是盲因子：

$$ f = f1 || f2 $$

因此，爱丽丝和鲍勃必须获得相同的 $f$ 值，而不直接传输它，因为攻击者可能会窃取它并解密秘密信息。这个盲因子是通过对两个值应用 HMAC-SHA512 获得的：
- 一个秘密点的 x 坐标；
- 以及交易中作为输入消耗的 UTXO。
因此，鲍勃需要这两条信息来解密爱丽丝支付码的有效载荷。对于作为输入的 UTXO，鲍勃可以简单地通过观察通知交易来检索它。对于秘密点，鲍勃将不得不使用 ECDH。如前一节关于 Diffie-Hellman 所述，仅通过交换各自的公钥并秘密地将各自的私钥应用于对方的公钥，爱丽丝和鲍勃可以在椭圆曲线上找到一个特定的秘密点。通知交易依赖于这个机制：
- 鲍勃的密钥对：

$$ B = b \cdot G $$

- 爱丽丝的密钥对：

$$ A = a \cdot G $$

- 对于一个秘密 $S (x, y)$：

$$ S = a \cdot B = a \cdot (b \cdot G) = (b \cdot a) \cdot G = b \cdot A $$

![BTC204](assets/en/66/19.webp)

现在鲍勃知道了爱丽丝的支付码，他将能够检测到她的 BIP47 支付，并且他可以推导出锁定收到的比特币的私钥。

让我们回顾一下我们刚刚经历的接收和解释通知交易的步骤：
- 鲍勃监控发送到他的通知地址的交易输出；
- 当他检测到一个时，他检索包含在 OP_RETURN 中的信息；
- 鲍勃选择输入中的公钥并使用 ECDH 计算一个秘密点；
- 他使用这个秘密点来计算一个 HMAC，这是盲因子；
- 他使用这个盲因子来解密包含在 OP_RETURN 中的爱丽丝支付码的有效载荷。

![BTC204](assets/en/66/20.webp)

### BIP47 支付交易

现在让我们一起研究 BIP47 的支付过程。提醒您当前的情况：
- 爱丽丝知道鲍勃的支付码，她只是从他的网站上检索到的；
- 鲍勃得知爱丽丝的支付代码，这要归功于通知交易；
- 爱丽丝将向鲍勃进行首次支付。她将能够以同样的方式进行许多其他支付。

在解释这个过程之前，我认为重要的是回顾一下我们目前正在研究的索引。支付代码的派生路径如下所述：`m/47'/0'/0'`。下一个深度以这种方式分配索引：
- 第一个正常（非强化）子对是用来生成我们在前一部分讨论的通知地址的：`m/47'/0'/0'/0`；
- 正常子密钥对在ECDH中用于生成BIP47支付接收地址，正如我们将在本节中看到的：从`m/47'/0'/0'/0`到`m/47'/0'/0'/2 147 483 647`；
- 强化子密钥对是临时支付代码：从`m/47'/0'/0'/0'`到`m/47'/0'/0'/2 147 483 647'`。

每当爱丽丝希望向鲍勃发送支付时，她会再次通过ECDH协议派生一个新的唯一的处女地址：
- 爱丽丝选择从她的个人可重用支付代码派生的第一个私钥：

$$ a $$

- 爱丽丝选择从鲍勃的支付代码派生的第一个未使用的公钥。我们将这个公钥称为$B$。它与只有鲍勃知道的私钥$b$相关联：

$$ B = b \cdot G $$

- 爱丽丝通过将她的私钥$a$应用于鲍勃的公钥$B$，通过点加和加倍计算椭圆曲线上的一个秘密点$S$：

$$ S = a \cdot B $$

- 从这个秘密点，爱丽丝将计算共享秘密$s$（小写）。为此，她选择秘密点$S$的x坐标$Sx$，并将这个值通过SHA256哈希函数传递：

$$ S = (Sx, Sy) $$
$$ s = \text{SHA256}(Sx) $$

- 爱丽丝使用这个共享秘密$s$来计算一个比特币支付接收地址。最初，她验证$s$是否包含在secp256k1曲线的顺序中。如果不是，她增加鲍勃的公钥的索引以派生另一个共享秘密；
- 其次，她通过在椭圆曲线上加上点$B$和$s·G$来计算一个公钥$K0$。换句话说，爱丽丝将从鲍勃的支付代码派生的公钥$B$与另一个点相加，这个点是通过与secp256k1曲线的生成点$G$的共享秘密$s$进行点加和加倍计算得到的。这个新点代表一个公钥，我们将其命名为$K0$：

$$ K0 = B + s \cdot G $$

- 有了这个公钥$K0$，爱丽丝可以派生一个标准的处女接收地址（例如，SegWit V0 in bech32）。
一旦爱丽丝获得了鲍勃的接收地址$K0$，她就可以以标准方式进行比特币交易。为此，她选择一个她拥有的UTXO，该UTXO由她的HD钱包的不同分支的一对密钥保护，并将其花费以满足对鲍勃地址$K0$的输出。重要的是要注意，一旦派生了地址，这种支付遵循常规过程，不再依赖于与BIP47相关的密钥。
让我们回顾一下我们刚刚一起完成的步骤，以发送BIP47支付：
- Alice从她的个人支付代码中选择第一个派生的子私钥；
- 她使用ECDH从Bob的支付代码中第一个未使用的派生子公钥计算椭圆曲线上的一个秘密点；
- 她使用这个秘密点通过SHA256计算一个共享秘密；
- 她使用这个共享秘密在椭圆曲线上计算一个新的秘密点；
- 她将这个新的秘密点加到Bob的公钥上；
- 她获得一个新的临时公钥，只有Bob拥有关联的私钥；
- Alice可以使用派生的临时接收地址向Bob进行标准交易。

![BTC204](assets/en/66/21.webp)

如果Alice想要进行第二次支付，她将遵循之前相同的步骤，除了这次她将从Bob的支付代码中选择第二个派生的公钥。具体来说，她将使用下一个未使用的密钥。因此，她将获得一个属于Bob的新接收地址，指定为$K1$：

![BTC204](assets/en/66/22.webp)

她可以继续以这种方式操作，并派生出多达`2^32`个属于Bob的未使用地址。

从外部视角来看，通过观察区块链，理论上不可能区分BIP47支付和标准支付。这是Testnet上一个BIP47支付交易的例子：

```text
94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
```

这看起来像是一个标准交易，有一个消耗的输入，一个支付输出和一个找零：

![BTC204](assets/notext/66/23.webp)

### 接收BIP47支付并派生私钥

Alice刚刚向属于Bob的一个新BIP47地址进行了她的第一次支付。现在让我们看看Bob是如何接收这笔支付的。我们还将看到为什么Alice无法访问她刚刚生成的地址的私钥，以及Bob如何检索这个密钥来花费他刚刚收到的比特币。
一旦Bob收到来自Alice的通知交易，他甚至在她发送任何支付之前就派生出公钥BIP47 $K0$。然后他监控任何对关联地址的支付。实际上，他立即派生出几个他将监控的地址（$K0$、$K1$、$K2$、$K3$...）。以下是他如何派生这个公钥$K0$的：
- Bob从他的支付代码中选择第一个派生的私子密钥。这个私钥被命名为$b$。它与公钥$B$相关联，Alice在前一步的计算中使用了这个公钥：

$$ b $$

- Bob选择Alice从她的支付代码中派生的第一个公钥。这个键被命名为$A$。它与私钥$a$相关联，Alice在她的计算中使用了这个私钥，而且只有Alice知道。Bob可以执行此过程，因为他知道Alice的支付代码，这个代码是通过通知交易传递给他的：

$$ A = a \cdot G $$

- Bob通过在椭圆曲线上加点和倍点，将他的私钥$b$应用于Alice的公钥$A$，计算出秘密点$S$。这里我们发现了ECDH的使用，保证了这个点$S$对于Bob和Alice来说是相同的：

$$ S = b \cdot A $$
- 就像Alice一样，Bob隔离了这个点$S$的x坐标。我们将这个值命名为$Sx$。他通过SHA256函数传递这个值来找到共享密钥$s$（小写）：
$$ s = \text{SHA256}(Sx) $$

- 像Alice一样，Bob在椭圆曲线上计算点$s·G$。然后，他将这个秘密点加到他的公钥$B$上。然后，他在椭圆曲线上获得一个新点，他将其解释为公钥$K0$：

$$ K0 = B + s \cdot G $$

一旦Bob拥有了这个公钥$K0$，他就可以推导出相关的私钥，以便能够花费他的比特币。他是唯一可以生成这个私钥的人：

- Bob添加了他从个人支付代码派生出的子私钥$b$。他是唯一可以获得$b$值的人。然后，他将$b$与共享密钥$s$相加，以获得$K0$的私钥$k0$：

$$ k0 = b + s $$

感谢椭圆曲线的群律，Bob准确地获得了与Alice使用的公钥相对应的私钥。因此我们有：

$$ K0 = k0 \cdot G $$
我将总结我们刚刚一起经历的步骤，以接收BIP47支付并计算相应的私钥：
- Bob从他的个人支付代码中选择第一个派生的子私钥；
- 他使用ECDH从Alice的链代码的第一个派生的子公钥计算椭圆曲线上的一个秘密点；
- 他使用这个秘密点来计算一个与SHA256的共享秘密；
- 他使用这个共享秘密在椭圆曲线上计算一个新的秘密点；
- 他将这个新的秘密点加到他的个人公钥上；
- 他获得一个新的临时公钥，Alice将向其发送她的第一笔支付；
- Bob通过将他的支付代码中派生的子私钥和共享秘密相加，计算与这个临时公钥相关联的私钥。

![BTC204](assets/en/66/24.webp)

由于Alice无法获得$b$（Bob的私钥），她无法确定$k0$（与Bob的BIP47接收地址相关联的私钥）。从概念上讲，我们可以这样表示共享秘密$S$的计算：

![BTC204](assets/en/66/19.webp)

一旦通过ECDH找到共享秘密，Alice和Bob计算BIP47支付公钥$K0$，Bob还计算相关联的私钥$k0$：

![BTC204](assets/en/66/25.webp)

### 退还BIP47支付

由于Bob知道Alice的可重用支付代码，他已经拥有发送退款所需的所有信息。他不需要再次联系Alice请求任何信息。他只需要通过通知交易特别通知她，以便她可以使用她的种子检索她的BIP47地址，然后他也可以向她发送多达`2^32`次支付。

退款功能是BIP47特有的，是其相对于我们将在接下来的章节中研究的其他方法（如Silent Payments）的优势之一。

Bob可以以与Alice发送给他支付相同的方式退款给Alice。角色颠倒了：

![BTC204](assets/en/66/26.webp)
*非常感谢[Fanis Michalakis](https://x.com/FanisMichalakis)对启发本章写作的文章进行审查和提供宝贵的专家建议！*
https://planb.network/tutorials/privacy/paynym-bip47

## 静默支付
<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>
BIP47因其在链上的低效率而受到批评。正如前一章所解释的，它要求对每个新接收者进行一次通知交易。如果计划与该接收者建立持久的支付通道，这个限制就变得可以忽略。实际上，一次通知交易为后续几乎无限数量的BIP47支付铺平了道路。

然而，在某些情况下，通知交易可能对用户来说是一个障碍。以向接收者进行一次性捐赠为例：使用经典的比特币地址，一次交易就足够完成捐赠。但使用BIP47，需要两次交易：一次用于通知，另一次用于实际支付。当区块空间需求低且交易费用最小时，这个额外步骤通常不是问题。然而，在拥堵期间，单次支付的交易费用可能变得极高，与标准比特币交易相比，可能会使用户的成本翻倍，这对用户来说可能是不可接受的。

对于用户计划仅向静态标识符支付几次的情况，已经开发了其他解决方案。其中之一是静默支付，如[BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)中所述。该协议允许使用静态标识符接收支付，无需生成地址重用，也无需使用通知交易。让我们来看看这个协议是如何工作的。

---

*要完全理解本章内容，了解ECDH（椭圆曲线Diffie-Hellman）和HD钱包中的加密密钥派生机制是必要的。这些概念在关于BIP47的前一章中有详细说明。我在这里不会再次讲解它们。如果您还不熟悉这些概念，我建议在继续本章之前先查阅前一章。我也不会重新讨论重用接收地址的风险，以及拥有用于接收支付的唯一标识符的重要性。*

---

### 为什么不移动通知？

如BIP47章节所讨论的，通知交易主要有两个功能：
- 它通知接收者；
- 它传输发送者的支付代码。

人们可能会天真地认为，这个通知过程可以在链下进行。理论上，这完全是可行的：只需接收者指明一个通信方式来接收来自发送者的BIP47支付代码即可。然而，这种方法存在两个主要问题：
- 首先，这将把代码传输过程转移到另一种通信协议。与成本和交换隐私相关的问题仍然存在，但只是简单地转移到了这个新协议。在隐私方面，这也可能在用户的身份和链上活动之间创建链接，这是我们通过在区块链上直接进行通知来避免的。此外，在区块链外进行通知会引入审查风险（如资金封锁），而这些风险在比特币上不存在；
- 接下来，这将引发一个恢复问题。使用BIP47时，接收者必须绝对知道发送者的支付代码才能访问资金。这在收款时是正确的，但在丢失钱包的情况下通过种子恢复资金时也是如此。通过链上通知，可以避免这种风险，因为用户只需知道他们的种子就可以找到并解密通知交易。然而，如果通知是在区块链外执行的，用户则需要维护所有接收到的支付代码的动态备份，这对于普通用户来说是不切实际的。
所有这些限制使得在BIP47的背景下使用链上通知变得不可或缺。然而，静默支付（Silent Payments）特别寻求避免这一链上通知步骤，因为其成本。因此，采用的解决方案不是移动通知，而是完全消除它。为了实现这一点，必须接受一个妥协：即扫描。与BIP47不同，在BIP47中，用户凭借通知交易确切知道在哪里可以找到他们的资金，在静默支付的背景下，用户必须检查所有现有的比特币交易，以侦测可能意图支付给他们的任何支付。为了减少这种操作负担，仅将寻找静默支付的范围限制在可能包含此类支付的交易上，即那些至少包含一个Taproot P2TR输出的交易。扫描也仅专注于钱包创建日期之后的交易（如果钱包是在2024年创建的，就没有必要扫描回溯到2009年的交易）。

因此，你可以看到为什么BIP47和静默支付虽然旨在实现类似的目标，但实际上涉及不同的妥协并**因此实际上满足不同的用例**。对于一次性支付，如偶尔的捐赠，静默支付由于其较低的成本更为合适。相反，对于定期向同一接收者进行的交易，如交易平台或矿池的情况，可能更倾向于使用BIP47。
让我们一起探索静默支付的技术工作原理，以更好地理解其含义。为此，我建议我们采取与BIP352的解释性文件相同的方法。我们将逐步分解要执行的计算，逐个元素地进行，为每一个新添加的元素提供理由。
### 需要理解的一些概念

在我们开始之前，重要的是要澄清，静默支付专门依赖于使用P2TR（*支付到Taproot*）脚本类型。与BIP47不同，不需要通过散列它们来从子公钥派生接收地址。实际上，在P2TR标准中，调整后的公钥直接并公开地用在地址中。因此，一个Taproot接收地址本质上是一个伴随着一些元数据的公钥。这个调整后的公钥是两个其他公钥的聚合：一个允许通过简单签名直接和传统的支出，另一个代表MAST的默克尔根，它授权在满足Merkle树中可能刻录的某个条件的情况下进行支出。

![BTC204](assets/en/67/01.webp)

将静默支付专门限制于Taproot的决定是由两个主要原因驱动的：
- 首先，它显著地便于钱包软件的实现和未来更新，因为只需要遵循一个标准；
- 其次，这种方法有助于通过鼓励用户不在不同类型的脚本之间分散，从而在链分析中生成不同的钱包指纹，来改善用户的匿名集（有关此概念的更多信息，我邀请你参阅第2部分的第4章）。

### 静默支付公钥的简单派生
让我们从一个简单的例子开始，这将帮助您理解SP（Silent Payments，即静默支付）的核心功能。以Alice和Bob为例，他们是两个比特币用户。Alice想要向Bob发送比特币到一个新的接收地址。在这个过程中必须实现三个目标：
- Alice必须能够生成一个新的地址；
- Bob必须能够识别发送到这个特定地址的支付；
- Bob必须能够获取与这个地址关联的私钥，以便能够使用他的资金。

Alice的比特币钱包中有一个UTXO，用以下密钥对保护：
- $a$：私钥；
- $A$：公钥（$A = a \cdot G$）

Bob在互联网上发布了一个SP地址，该地址包括：
- $b$：私钥；
- $B$：公钥（$B = b \cdot G$）
通过检索Bob的地址，Alice能够使用ECDH计算出一个属于Bob的新空白地址。我们称这个地址为$P$：
$$  P = B + \text{hash}(a \cdot B) \cdot G  $$

在这个等式中，Alice简单地计算了她的私钥$a$和Bob的公钥$B$的点积。她将这个结果通过一个众所周知的哈希函数。然后，输出值通过生成点$G$的标量乘法，这个生成点是椭圆曲线`secp256k1`的。最后，Alice将得到的点加到Bob的公钥$B$上。一旦Alice有了这个地址$P$，她就使用它作为交易的输出，意味着她向它发送比特币。

> *在静默支付的上下文中，"hash"函数对应于一个特别标记为`BIP0352/SharedSecret`的SHA256哈希函数，确保生成的哈希是这个协议特有的，不能在其他上下文中重用，同时也提供了对签名中nonce重用的额外保护。这个标准对应于[在BIP340中为`secp256k1`上的Schnorr签名指定的标准](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki)。*

得益于ECDH所依赖的椭圆曲线的属性，我们知道：

$$  a \cdot B = b \cdot A  $$

因此，Bob将能够计算出Alice发送比特币的接收地址。为此，他监控所有符合静默支付标准的比特币交易，并对它们中的每一个应用以下计算，以查看支付是否是发给他的（*扫描*）：

$$  P' = B + \text{hash}(b \cdot A) \cdot G  $$

当他扫描Alice的交易时，他意识到$P'$等于$P$。因此，他知道这笔支付是发给他的：

$$  P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P   $$

从这里开始，Bob将能够计算出允许花费地址$P$的私钥$p$：

$$  p = (b + \text{hash}(b \cdot A)) \bmod n  $$

如您所见，要计算这个私钥$p$，必须拥有私钥$b$。只有Bob拥有这个私钥$b$。因此，他确实将是唯一能够花费发送到他的静默支付地址上的比特币的人。

![BTC204](assets/notext/67/02.webp)
*说明：*
- $B$：Bob发布的公钥/静态地址
- $b$：Bob的私钥
- $A$：用作交易输入的Alice的UTXO的公钥
- $a$：Alice的私钥
- $G$：椭圆曲线`secp256k1`的生成点
- $\text{SHA256}$：带有`BIP0352/SharedSecret`标签的SHA256哈希函数
- $s$：共同的ECDH秘密
- $P$：支付给Bob的公钥/唯一地址

这里是一个使用Bob的静态地址$B$来派生唯一地址$P$以发送比特币的初步相当简单的方法。然而，这种方法过于简单，存在几个需要纠正的缺陷。首先的问题是，在这个方案中，Alice不能在同一笔交易中创建多个输出到Bob。

### 如何创建多个输出？

在前一节的示例中，Alice创建了一个将会发送到Bob的唯一地址$P$的单一输出。使用相同的输入，Alice不可能为Bob创建两个不同的新地址，因为所使用的方法总会导致$P$的相同结果，因此是相同的地址。然而，在许多情况下，Alice可能希望将她对Bob的支付分割成几个较小的金额，从而创建多个UTXOs。因此，需要找到一种允许这样做的方法。

为了实现这一点，我们将稍微修改Alice执行的计算以派生$P$，以便她可以为Bob生成两个不同的地址，即$P_0$和$P_1$。

为了修改计算并获得2个不同的地址，只需添加一个修改结果的整数。因此，Alice将在她的计算中添加$0$以获得地址$P_0$，并添加$1$以获得地址$P_1$。让我们称这个整数为$i$：

$$  P_i = B + \text{hash}(a \cdot B \text{ ‖ } i) \cdot G  $$

计算过程与之前的方法保持不变，除了这次Alice会在进行哈希之前将$a \cdot B$与$i$连接起来。然后只需更改$i$就可以拥有属于Bob的新地址。例如：

$$  P_0 = B + \text{hash}(a \cdot B \text{ ‖ } 0) \cdot G  $$

$$  P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1) \cdot G  $$
当Bob扫描区块链寻找意图给他的静默支付时，他首先使用$i = 0$的地址$P_0$。如果他在$P_0$上没有找到任何支付，他就会得出这笔交易不包含任何给他的静默支付的结论，并停止分析它。然而，如果$P_0$是有效的并且包含了给他的支付，他会在同一笔交易中继续使用$P_1$来检查Alice是否进行了第二次支付。如果$P_1$被证明是无效的，他就会停止对这笔交易的搜索；否则，他会继续测试$i$的后续值：
$$  P_1 = B + \text{hash}(b \cdot A \text{ ‖ } 1) \cdot G  $$
由于如果 $P_0$ 没有产出，鲍勃会立即在 $i = 0$ 时停止，因此这个整数对鲍勃扫描交易的步骤几乎不增加额外的操作负担。

然后，鲍勃可以以同样的方式计算私钥：

$$ 
p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n
 $$

$$ 
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n 
 $$

![BTC204](assets/notext/67/03.webp)

*图注：*
- $B$：鲍勃发布的公钥/静态地址
- $b$：鲍勃的私钥
- $A$：用作交易输入的爱丽丝UTXO的公钥
- $a$：爱丽丝的私钥
- $G$：椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$：带有 `BIP0352/SharedSecret` 标签的SHA256哈希函数
- $s_0$：第一个共享的ECDH秘密
- $s_1$：第二个共享的ECDH秘密
- $P_0$：支付给鲍勃的第一个公钥/唯一地址
- $P_1$：支付给鲍勃的第二个公钥/唯一地址

通过这种方法，我们开始拥有一个不错的协议，但仍然存在一些需要克服的挑战，特别是防止地址重用。

### 如何避免地址重用？
正如我们在前面的部分看到的，爱丽丝使用保护她将要花费的UTXO的密钥对，来计算与鲍勃的共享ECDH秘密。这个秘密允许她派生出唯一地址 $P_0$。然而，如果爱丽丝多次重用这个地址，由爱丽丝使用的密钥对（$a$，$A$）可以保护多个UTXO。如果爱丽丝使用两个由相同密钥 $A$ 保护的UTXO向鲍勃的静态地址 $B$ 进行两次支付，这将导致鲍勃的地址重用。
> *地址重用对用户隐私来说是一个非常糟糕的做法。为了理解原因，我建议你回顾本培训的前几部分。*

实际上，由于唯一地址 $P_0$ 是从 $A$ 和 $B$ 派生的，如果爱丽丝为对 $B$ 的第二次支付派生出第二个地址，使用相同的密钥 $A$，她将得到相同的地址 $P_0$。为了避免这种风险并防止在静默支付中重用地址，我们需要稍微修改我们的计算。

我们想要的是，爱丽丝作为支付输入消耗的每个UTXO在鲍勃这边给出一个唯一地址，即使多个UTXO由相同的密钥对保护。因此，只需在计算唯一地址 $P_0$ 时添加对UTXO的引用即可。这个引用将简单地是作为输入消耗的UTXO的哈希：

$$  \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A)  $$

爱丽丝将在她计算唯一地址 $P_0$ 时添加这个输入引用：
在他的扫描过程中，鲍勃也可以添加$\text{inputHash}$，因为他所需要做的就是观察交易以推断$\text{outpoint}$：

$$  P_0 = B + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0) \cdot G  $$

当他找到一个有效的$P_0$时，他可以计算相应的私钥$p_0$：

$$ 
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
 $$

![BTC204](assets/notext/67/04.webp)

*图例：*
- $B$：鲍勃发布的公钥/静态地址
- $b$：鲍勃的私钥
- $A$：用作交易输入的爱丽丝UTXO的公钥
- $a$：爱丽丝的私钥
- $H$：用作输入的UTXO的哈希
- $G$：椭圆曲线`secp256k1`的生成点
- $\text{SHA256}$：带有`BIP0352/SharedSecret`标签的SHA256哈希函数
- $s_0$：第一个共享的ECDH秘密
- $P_0$：支付给鲍勃的第一个公钥/唯一地址

目前，我们的计算假设爱丽丝的交易使用单一输入。然而，她应该能够使用多个输入。因此，在鲍勃这边，对于包含多个输入的每笔交易，他理论上需要计算每个输入的ECDH，以确定是否有支付意图给他。这种方法不令人满意，所以我们需要找到一个解决方案来减少工作量！

### 调整输入中的公钥

为了解决这个问题，我们不会使用爱丽丝一侧保护特定输入的一对密钥，而是使用交易输入中所有密钥对的总和。然后，这个总和将被视为一对新的密钥。这种技术被称为“调整”。

例如，假设爱丽丝的交易有3个输入，每个输入都用不同的一对密钥保护：
- $a_0$ 保护输入#0；
- $a_1$ 保护输入#1；
- $a_2$ 保护输入#2。

![BTC204](assets/notext/67/05.webp)

按照上述方法，爱丽丝将不得不在$a_0$、$a_1$和$a_2$中选择一对密钥来计算ECDH秘密，并生成从鲍勃的静态地址$B$派生的唯一支付地址$P$。然而，这种方法要求鲍勃依次测试每种可能性，从$a_0$开始，然后是$a_1$，依此类推，直到识别出生成有效地址$P$的一对。这个过程要求鲍勃对所有交易的所有输入执行ECDH计算，显著增加了操作扫描的工作量。

为了避免这种情况，我们将要求爱丽丝使用输入中所有密钥的总和来执行她的$P$计算。以我们的例子为例，调整后的私钥$a$将如下计算：

$$  a = a_0 + a_1 + a_2  $$
同样，Alice和Bob将能够计算出调整后的公钥：
$$  A = A_0 + A_1 + A_2  $$
多亏了这种方法，Bob只需要计算交易中公钥的总和，然后仅从$A$计算ECDH秘密，这大大减少了扫描步骤需要进行的计算数量。然而，还记得上一节的内容。我们在计算中包含了哈希$\text{inputHash}$，它被用作一次性随机数以防止地址重用：

$$  \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A)  $$

但是，如果交易中有多个输入，就需要确定在此计算中选择哪个$\text{outpoint}$。根据BIP352，选择$\text{outpoint}$的标准是选择字典序最小的，这意味着选择按字母顺序首先出现的UTXO。这种方法规范了每笔交易中选择UTXO的方式。例如，如果这个字典序最小的$\text{outpoint}$是$\text{outpoint}_L$，那么$\text{inputHash}$的计算将是：

$$  \text{inputHash} = \text{hash}(\text{outpoint}_L \text{ ‖ } A)  $$

然后，计算与上一节中介绍的计算保持相同，除了私钥$a$及其对应的公钥$A$不再是保护单个输入的一对，而现在代表输入中所有密钥对的调整。

### 分离支付和扫描密钥

到目前为止，我们讨论了静默支付静态地址$B$作为一个独特的公钥。记住，正是这个公钥$B$被Alice用来创建共享的ECDH秘密，进而用来计算独特的支付地址$P$。Bob使用这个公钥$B$和相应的私钥$b$进行扫描步骤。但他还将使用私钥$b$来计算允许从地址$P$支付的私钥$p$。

这种方法的缺点是，用于计算接收静默支付的地址的所有私钥的私钥$b$，也被Bob用来扫描交易。这一步骤要求密钥$b$在连接到互联网的钱包软件上可用，这与将其保留在冷钱包上相比，使其面临更大的盗窃风险。理想情况下，能够在保持私钥$b$安全地存储在硬件钱包上的同时，利用静默支付将是有益的。幸运的是，协议已经被适应以允许确切地做到这一点。
为了实现这一点，BIP352规定接收者使用2对不同的密钥：
- $B_{\text{spend}}$：用于计算独特支付地址的私钥；
- $B_{\text{scan}}$：用于找到独特支付地址。

通过这种方式，Bob可以将私钥$b_{\text{spend}}$保留在硬件钱包上，并使用私钥$b_{\text{scan}}$在在线软件上找到他的静默支付，而不暴露$b_{\text{spend}}$。然而，公钥$B_{\text{scan}}$和$B_{\text{spend}}$都被公开，因为它们都在Bob的静态地址$B$中找到：
为了计算属于Bob的唯一支付地址$P_0$，Alice现在将执行以下计算：

$$  P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G  $$

为了找到寄给他的支付，Bob将执行以下计算：

$$  P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G  $$

如您所见，到目前为止，Bob还没有需要使用位于他的硬件钱包上的$b_{\text{spend}}$。当他希望花费$P_0$时，他可以执行以下计算来找到私钥$p_0$：

$$ p_0 = (b_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$

![BTC204](assets/notext/67/06.webp)

*图注：*
- $B_{\text{scan}}$：Bob的扫描公钥（静态地址）
- $b_{\text{scan}}$：Bob的扫描私钥
- $B_{\text{spend}}$：Bob的支付公钥（静态地址）
- $b_{\text{spend}}$：Bob的支付私钥
- $A$：输入中公钥的总和（调整值）
- $a$：对应于调整后公钥的私钥
- $H$：输入中使用的最小UTXO（按字典顺序）的哈希值
- $G$：椭圆曲线`secp256k1`的生成点
- $\text{SHA256}$：带有`BIP0352/SharedSecret`标签的SHA256哈希函数
- $s_0$：第一个共享的ECDH秘密
- $P_0$：Bob的第一个公钥/唯一支付地址

### 使用带标签的SP地址

Bob因此有一个用于静默支付的静态地址$B$，如下所示：

$$ B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$

这种方法的问题在于，它不允许区分发送到此地址的不同支付。例如，如果Bob有2个不同的客户为他的业务支付，他想要清楚地区分每个客户的支付，他将需要2个不同的静态地址。一个简单的解决方案，根据当前的方法，将是Bob创建两个单独的钱包，每个都有自己的静态地址，或者甚至在同一个钱包内建立两个不同的静态地址。然而，这种解决方案需要扫描整个区块链两次（每个地址一次），分别检测意图支付给每个地址的支付。这种双重扫描不合理地增加了Bob的操作负担。
为了解决这个问题，BIP352采用了一种标签系统，允许使用不同的静态地址而不会不合理地增加在区块链上寻找静默支付的工作量。为此，一个整数$m$被添加到支出公钥$B_{\text{spend}}$中。这个整数对于第一个静态地址可以取值$1$，然后对于第二个是$2$，依此类推。支出密钥$B_{\text{spend}}$从此将被称为$B_m$，并以这种方式构建：
$$  B_m = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } m) \cdot G  $$

例如，对于带有标签$1$的第一个支出密钥：

$$  B_1 = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G  $$

Bob发布的静态地址现在将由$B_{\text{scan}}$和$B_m$组成。例如，带有标签$1$的第一个静态地址将是：

$$ B = B_{\text{scan}} \text{ ‖ } B_1 $$

> *我们从标签1开始，因为标签0保留给找零。*

Alice将以与之前相同的方式推导出唯一的支付地址$P$，但使用新的$B_1$而不是$B_{\text{spend}}$。
$$  P_0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G  $$

实际上，Alice可能甚至不知道Bob有一个带标签的地址，因为她只是使用他提供给她的静态地址的第二部分，这种情况下，是值$B_1$而不是$B_{\text{spend}}$。

为了扫描支付，Bob将始终使用他的初始静态地址的值$B_{\text{spend}}$以这种方式：

$$   P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G  $$

然后，他简单地从每个输出中逐一减去他找到的$P_0$的值。接着，他检查这些减法的结果之一是否与他在钱包上使用的标签之一的值匹配。如果匹配，例如，对于带有标签$1$的输出#4，这意味着这个输出是与他的带标签静态地址$B_1$相关联的静默支付：

$$ Out_4 - P_0 = \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G $$

这是因为：

$$  B_1 = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G  $$
感谢这种方法，Bob可以使用多个静态地址（$B_1$、$B_2$、$B_3$...），这些地址都是从他的基础静态地址（$B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}}$）派生出来的，以便于适当地分隔使用。
然而，这种静态地址的分隔仅从个人钱包管理的角度有效，并不允许分隔身份。由于它们都有相同的$B_{\text{scan}}$，将所有静态地址关联起来并推断它们属于单一实体是非常容易的。

![BTC204](assets/notext/67/07.webp)

*图注：*
- $B_{\text{scan}}$：Bob的扫描公钥（静态地址）
- $b_{\text{scan}}$：Bob的扫描私钥
- $B_{\text{spend}}$：Bob的消费公钥（初始地址）
- $B_m$：Bob的标记消费公钥（静态地址）
- $b_m$：Bob的标记消费私钥
- $A$：输入公钥的总和（微调）
- $a$：对应于微调公钥的私钥
- $H$：作为输入的最小UTXO（按字典顺序）的哈希值
- $G$：椭圆曲线`secp256k1`的生成点
- $\text{SHA256}$：带有`BIP0352/SharedSecret`标签的SHA256哈希函数
- $s_0$：第一个共享的ECDH秘密
- $P_0$：第一个公钥/向Bob支付的唯一地址
- $p_0$：向Bob支付的第一个唯一支付地址的私钥
- $X$：带有标签的扫描私钥的哈希值

### 如何构建一个静默支付地址？

要构建一个专用的静默支付地址，首先必须在比特币HD钱包中派生出两对密钥：
- 一对$b_{\text{scan}}$、$B_{\text{scan}}$用于搜索定向给我们的支付；
- 一对$b_{\text{spend}}$、$B_{\text{spend}}$用于花费我们收到的比特币。

这些密钥对按照以下路径派生（*比特币主网*）：

```text
scan: m / 352' / 0' / 0' / 1' / 0
spend: m / 352' / 0' / 0' / 0' / 0
```

一旦这两对密钥可用，就简单地将它们首尾相连（端到端）来创建静态地址的有效载荷：

$$ B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$

如果希望使用标签，$B_{\text{spend}}$被$B_m$替换：

$$ B = B_{\text{scan}} \text{ ‖ } B_m $$

带有标签$m$：

$$  B_m = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } m) \cdot G  $$

一旦有效载荷可用，就添加HRP（*人类可读部分*）`sp`和版本`q`（=版本0）。还会添加一个校验和，并且地址以bech32m格式化。
例如，这是我的静态Silent Payments地址：
```text
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```
关于静态地址的一个重要点，您可能在前面的章节中已经输入过，这些地址在比特币交易中是不可见的。只有在输出中使用的支付地址$P$，以标准Taproot格式出现在区块链上。因此，从外部来看，无法区分涉及Silent Payment的交易和使用P2TR输出的普通交易。
就像BIP47一样，无法建立静态地址$B$与从$B$派生的支付地址$P$之间的连接。实际上，即使是潜在的攻击者Eve尝试用Bob的静态地址$B$扫描区块链，她也无法进行必要的计算来确定$P$。要做到这一点，她需要Bob的私人扫描密钥$b_{\text{scan}}$或发送者的私钥$a$，但这两个元素当然都是私有的。因此，可以明确地将某人的静态地址与个人身份形式链接起来。

### 如何使用Silent Payments？

Silent Payments的提案相对较新，到目前为止只有非常有限的几个钱包实现了这一功能。据我所知，只有3个软件支持它们：
- [CakeWallet](https://cakewallet.com/)
- [Silentium](https://app.silentium.dev/)
- [DonationWallet](https://github.com/Sosthene00/donationwallet)

我们很快会提供一个关于设置您自己的Silent Payments静态地址的详细教程。

由于这项功能是近期的，建议谨慎行事，避免在主网上使用Silent Payments进行大额交易。

*为了创建这一章节关于Silent Payments，我使用了[Silent Payments解释站点](https://silentpayments.xyz/)和[BIP352解释文档](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki).*

# 结论
<partId>2aee56c0-b285-4799-b4f7-373a552ee2b2</partId>

## 给我们一些关于这门课程的反馈
<chapterId>195d149f-80fa-5816-8b46-995a9226d082</chapterId>
<isCourseReview>true</isCourseReview>

## 最终考试
<chapterId>e803d394-e3c1-5816-a6b4-a69a2472019c</chapterId>
<isCourseExam>true</isCourseExam>

## 最后的话
<chapterId>cd8e5c67-50e4-4dcd-8e04-88ba5ec95305</chapterId>

恭喜您完成了关于比特币隐私的这项培训！
在这次培训中，我们涵盖了许多高级和技术性话题，但并不是强制要求使用所有介绍的工具。主要目标是赋予您选择披露哪些信息以及在使用比特币时希望保密哪些信息的能力。这体现了隐私保护的真正精髓。为了做出关于分享或隐藏哪些信息的明智选择，必须意识到我们行动的后果。我希望这次培训帮助您获得了这些知识。如果我必须选择这次培训中最重要的部分，我会选择专门讨论链分析的那一节。了解潜在攻击者使用的技术是保护自己的最佳方式。因此，我的建议是仔细回顾这部分内容，并尽量掌握所有细节。

在这次培训中，我们专门关注了比特币主链上的隐私问题。第二层系统（如闪电网络和侧链）上的隐私问题同样重要，且具有非常特定的特点。尽管使用链下交易可以是一种有效的策略，以规避我们已经研究的比特币上的许多可追踪性风险，但它也会暴露您于其他同样重要的风险。这就是为什么这些话题将在未来专门针对PlanB网络的培训中涵盖。

如果您喜欢这次培训，我将非常感激您能与朋友和在社交媒体上分享。谢谢！:)